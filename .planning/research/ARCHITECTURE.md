# Architecture: Fremont, CA Collection Integration

**Domain:** Community Civic Trivia Collection
**Researched:** 2026-02-20
**Confidence:** HIGH (verified against existing v1.2/v1.3 collections)

## Executive Summary

Adding a Fremont, CA collection follows the well-established community collection pattern introduced in v1.2 (Bloomington IN, Los Angeles CA) and refined in v1.3 (Indiana, California state collections). The architecture is **code-complete and battle-tested** — no new components or infrastructure required.

The integration involves:
1. Creating a locale configuration file
2. Generating questions via AI with RAG sources
3. Creating seed data JSON
4. Adding collection metadata
5. Adding collection card image
6. Running seed scripts

**Zero architectural changes.** All infrastructure exists.

## Collection Pipeline Architecture

### Overview

```
Research → Config → Generation → Export → Seed → Activation
   │          │         │           │        │         │
   │          │         │           │        │         └─ Admin review + activate
   │          │         │           │        └─ seed-community.ts
   │          │         │           └─ export-community.ts
   │          │         └─ generate-locale-questions.ts
   │          └─ locale-configs/fremont-ca.ts
   └─ Curate authoritative .gov sources
```

### Data Flow

```
1. RESEARCH PHASE
   Input:  Fremont city/county/state government websites
   Output: List of authoritative source URLs
   Tool:   Manual curation

2. CONFIGURATION PHASE
   Input:  Topic categories, target counts, source URLs
   Output: backend/src/scripts/content-generation/locale-configs/fremont-ca.ts
   Tool:   Manual creation following existing pattern

3. SOURCE FETCH PHASE
   Input:  Source URLs from config
   Output: backend/src/scripts/data/sources/fremont-ca/*.txt
   Tool:   generate-locale-questions.ts --locale fremont-ca --fetch-sources

4. GENERATION PHASE
   Input:  Locale config + RAG source documents
   Output: Draft questions in PostgreSQL (status='draft')
   Tool:   generate-locale-questions.ts --locale fremont-ca
   Process:
     - Loads source documents from data/sources/fremont-ca/
     - Calls Anthropic API with RAG context
     - Validates with Zod schema
     - Seeds to database with status='draft'
     - Links to collection via collectionId

5. REVIEW PHASE
   Input:  Draft questions in database
   Output: Activated questions (status='active')
   Tool:   Admin review page (/admin/review)
   Process: Human reviewer activates quality questions

6. EXPORT PHASE
   Input:  Active questions in database
   Output: backend/src/data/fremont-ca-questions.json
   Tool:   export-community.ts (updated with fremont-ca)
   Purpose: Create portable seed file for production deployment

7. SEED PHASE (Production)
   Input:  fremont-ca-questions.json
   Output: Questions seeded in production database
   Tool:   seed-community.ts (updated with fremont-ca)
   Process:
     - Reads JSON data file
     - Upserts topics
     - Links topics to collection
     - Inserts questions
     - Links questions to collection
```

## File Structure

### Files to CREATE

| File Path | Purpose | Template |
|-----------|---------|----------|
| `backend/src/scripts/content-generation/locale-configs/fremont-ca.ts` | Locale configuration | Copy `los-angeles-ca.ts`, adapt for Fremont |
| `backend/src/db/seed/fremont-topics.ts` | Topic documentation (reference only) | Copy `los-angeles-topics.ts`, adapt topics |
| `backend/src/data/fremont-ca-questions.json` | Portable seed data | Generated by export-community.ts |
| `backend/src/scripts/data/sources/fremont-ca/*.txt` | RAG source documents | Generated by --fetch-sources |
| `frontend/public/images/collections/fremont-ca.jpg` | Collection card image | Create/source banner image |

### Files to MODIFY

| File Path | Changes Required | Line Reference |
|-----------|------------------|----------------|
| `backend/src/db/seed/collections.ts` | Add Fremont collection metadata | After line 35 (after los-angeles-ca) |
| `backend/src/scripts/content-generation/generate-locale-questions.ts` | Add fremont-ca to supported locales | Lines 85-88 (supportedLocales map) |
| `backend/src/scripts/export-community.ts` | Add fremont-ca export call | After line 136 (after los-angeles-ca) |
| `backend/src/db/seed/seed-community.ts` | Add fremont-ca to LOCALES array | Lines 53-56 (LOCALES array) |

### Files UNCHANGED (No modification needed)

- All game routes (collection scoping already exists)
- All frontend components (collection picker is data-driven)
- Database schema (supports unlimited collections)
- Question service (collection filtering built-in)
- Admin review page (collection-agnostic)

## Component Integration Points

### 1. Collection Metadata (collections.ts)

**Location:** `backend/src/db/seed/collections.ts`

**Add after Los Angeles entry:**

```typescript
{
  name: 'Fremont, CA',
  slug: 'fremont-ca',
  description: 'Test your knowledge of the City of Fremont!',
  localeCode: 'en-US',
  localeName: 'Fremont, California',
  iconIdentifier: 'flag-ca',
  themeColor: '#0369A1', // ocean blue - California
  isActive: false, // Set to true after review
  sortOrder: 4
}
```

**Naming Convention:**
- `slug`: kebab-case, format `{city}-{state-abbrev}` (e.g., `fremont-ca`)
- `name`: Display name shown in UI (e.g., `"Fremont, CA"`)
- `localeName`: Full locale for context (e.g., `"Fremont, California"`)

### 2. Locale Configuration (locale-configs/fremont-ca.ts)

**Location:** `backend/src/scripts/content-generation/locale-configs/fremont-ca.ts`

**Structure:**

```typescript
import type { LocaleConfig } from './bloomington-in.js';

export const fremontConfig: LocaleConfig = {
  locale: 'fremont-ca',
  name: 'Fremont, California',
  externalIdPrefix: 'fre', // 3-letter prefix for question IDs
  collectionSlug: 'fremont-ca',
  targetQuestions: 100,
  batchSize: 25,

  topicCategories: [
    {
      slug: 'city-government',
      name: 'City Government',
      description: 'Fremont city government — mayor, city council, departments, and municipal services',
    },
    // ... 7-8 total topic categories
  ],

  topicDistribution: {
    'city-government': 15,
    'alameda-county': 12,
    'california-state': 15,
    // ... sums to ~100
  },

  sourceUrls: [
    'https://www.fremont.gov',
    'https://www.fremont.gov/government/city-council',
    'https://www.acgov.org', // Alameda County
    // ... 10-15 authoritative .gov sources
  ],
};
```

**Topic Pattern (based on existing collections):**
- City Government (city council, mayor, departments)
- County Government (Alameda County in this case)
- State Government (California state — reuse from LA)
- Civic History (founding, incorporation, milestones)
- Local Services (utilities, parks, public safety)
- Elections & Voting (local election process)
- Landmarks & Culture (cultural institutions, notable places)
- Budget & Finance (city budget, taxes)

### 3. Generate Script Integration

**Location:** `backend/src/scripts/content-generation/generate-locale-questions.ts`

**Modify `supportedLocales` map (lines 85-88):**

```typescript
const supportedLocales: Record<string, () => Promise<...>> = {
  'bloomington-in': () => import('./locale-configs/bloomington-in.js'),
  'los-angeles-ca': () => import('./locale-configs/los-angeles-ca.js'),
  'fremont-ca': () => import('./locale-configs/fremont-ca.js'), // ADD THIS
};
```

**Modify `configKeys` array (lines 99-100):**

```typescript
const configKeys = ['bloomingtonConfig', 'losAngelesConfig', 'fremontConfig']; // ADD fremontConfig
```

### 4. Export Script Integration

**Location:** `backend/src/scripts/export-community.ts`

**Add export call after line 136:**

```typescript
await exportCollection('bloomington-in', 'bloomington-in-questions.json');
await exportCollection('los-angeles-ca', 'los-angeles-ca-questions.json');
await exportCollection('fremont-ca', 'fremont-ca-questions.json'); // ADD THIS
```

### 5. Seed Script Integration

**Location:** `backend/src/db/seed/seed-community.ts`

**Modify LOCALES array (lines 53-56):**

```typescript
const LOCALES = [
  { slug: 'bloomington-in', file: 'bloomington-in-questions.json' },
  { slug: 'los-angeles-ca', file: 'los-angeles-ca-questions.json' },
  { slug: 'fremont-ca', file: 'fremont-ca-questions.json' }, // ADD THIS
];
```

### 6. Collection Card Image

**Location:** `frontend/public/images/collections/fremont-ca.jpg`

**Requirements:**
- Filename MUST match slug: `fremont-ca.jpg`
- Dimensions: ~800x400px (aspect ratio ~2:1)
- Content: Recognizable Fremont landmark or California imagery
- Format: JPG or PNG

**Image Loading:**
- `CollectionCard.tsx` loads images via: `/images/collections/${collection.slug}.jpg`
- Falls back to `themeColor` background if image fails to load
- No code changes needed — purely convention-based

## Build Order (Suggested Phases)

### Phase 1: Configuration & Research
**Goal:** Create locale config and curate authoritative sources

**Tasks:**
1. Research Fremont city/county government structure
2. Identify 10-15 authoritative .gov source URLs
3. Create `locale-configs/fremont-ca.ts` with 8 topic categories
4. Define topic distribution targeting ~100 questions

**Output:**
- `backend/src/scripts/content-generation/locale-configs/fremont-ca.ts`
- Source URL list ready for RAG fetch

**Dependencies:** None

---

### Phase 2: Source Fetch & Generation
**Goal:** Generate 100 draft questions with AI + RAG

**Tasks:**
1. Run `generate-locale-questions.ts --locale fremont-ca --fetch-sources`
   - Fetches and saves source documents to `data/sources/fremont-ca/*.txt`
2. Run `generate-locale-questions.ts --locale fremont-ca`
   - Generates 100 questions in 4 batches (25 each)
   - Seeds to database with `status='draft'`
3. Create `fremont-topics.ts` reference file (documents generated topics)

**Output:**
- `backend/src/scripts/data/sources/fremont-ca/*.txt` (10-15 files)
- 100 questions in database with `status='draft'`
- `backend/src/db/seed/fremont-topics.ts` (documentation)

**Dependencies:** Phase 1 complete

**Commands:**
```bash
cd backend
npx tsx src/scripts/content-generation/generate-locale-questions.ts --locale fremont-ca --fetch-sources
npx tsx src/scripts/content-generation/generate-locale-questions.ts --locale fremont-ca
```

---

### Phase 3: Review & Activation
**Goal:** Human review activates quality questions

**Tasks:**
1. Review generated questions via admin panel (`/admin/review`)
2. Activate quality questions (change `status='active'`)
3. Archive or fix low-quality questions
4. Ensure difficulty distribution is balanced (30% easy, 40% medium, 30% hard)

**Output:**
- 80-100 active questions ready for play

**Dependencies:** Phase 2 complete

**Access:** Admin user account required

---

### Phase 4: Collection Activation & Export
**Goal:** Make Fremont collection playable and create portable seed data

**Tasks:**
1. Add Fremont collection metadata to `collections.ts`
2. Set `isActive: true` for Fremont collection
3. Modify `export-community.ts` to include Fremont
4. Run export script to generate `fremont-ca-questions.json`
5. Modify `seed-community.ts` to include Fremont
6. Add collection card image to `frontend/public/images/collections/fremont-ca.jpg`

**Output:**
- `backend/src/data/fremont-ca-questions.json` (portable seed file)
- Fremont collection visible in collection picker
- End-to-end playability

**Dependencies:** Phase 3 complete

**Commands:**
```bash
cd backend
npx tsx src/scripts/export-community.ts
npm run db:seed:community  # Test seeding
```

---

### Phase 5: Verification & Testing
**Goal:** Verify end-to-end functionality

**Tasks:**
1. Verify collection appears in picker with correct metadata
2. Play a game using Fremont collection
3. Verify questions are Fremont-specific
4. Check difficulty balance
5. Verify collection card image loads
6. Test expiration system (if any time-sensitive questions exist)

**Output:**
- Verified working collection
- Ready for production deployment

**Dependencies:** Phase 4 complete

---

## Architectural Patterns

### Pattern 1: Convention-Based Collection Discovery

**What:** Collections are discovered via database query, not hardcoded

**How it works:**
```typescript
// Frontend fetches collections dynamically
GET /api/game/collections
→ Returns all isActive=true collections

// Collection picker renders cards data-driven
{collections.map(c => <CollectionCard collection={c} />)}
```

**Why it works:**
- No frontend code changes needed for new collections
- Collection metadata lives in single source of truth (database)
- Image loading is convention-based (slug.jpg)

**Fremont integration:** Add metadata to `collections.ts`, set `isActive: true`. Collection appears automatically.

---

### Pattern 2: Locale Config as Single Source of Truth

**What:** All generation parameters live in one config file

**How it works:**
```typescript
// Config drives everything
const config = fremontConfig;

// Topic categories → database topics
ensureLocaleTopics(config.collectionSlug, config.topicCategories);

// Source URLs → RAG documents
fetchSources(config.sourceUrls, dataDir);

// Distribution → AI prompt
buildSystemPrompt(config.name, config.topicDistribution);
```

**Why it works:**
- One file change enables entire generation pipeline
- Config is version-controlled and auditable
- Easy to replicate for new locales

**Fremont integration:** Create `fremont-ca.ts` config. Pipeline handles the rest.

---

### Pattern 3: Idempotent Seeding with Conflict Resolution

**What:** Seed scripts can be run multiple times safely

**How it works:**
```typescript
// All inserts use onConflictDoNothing
await db.insert(topics)
  .values(topicData)
  .onConflictDoNothing({ target: topics.slug });

await db.insert(questions)
  .values(questionData)
  .onConflictDoNothing({ target: questions.externalId });
```

**Why it works:**
- Re-running seeds after question updates won't duplicate
- Production deployments can run seed-community.ts safely
- Development iteration is friction-free

**Fremont integration:** No special handling needed. Standard seed scripts work.

---

### Pattern 4: Two-Stage Seeding (Generate → Export → Seed)

**What:** Local generation → JSON export → production seed

**How it works:**
```
1. Local Development:
   generate-locale-questions.ts → PostgreSQL (draft questions)
   Admin review → status='active'
   export-community.ts → fremont-ca-questions.json

2. Production Deployment:
   seed-community.ts reads fremont-ca-questions.json
   Seeds questions to production database
```

**Why it works:**
- Separates AI generation (expensive, error-prone) from deployment (reliable, fast)
- JSON file is version-controlled and human-reviewable
- Production doesn't need Anthropic API access

**Fremont integration:** Generate locally, export JSON, commit to repo, deploy.

---

## Anti-Patterns to Avoid

### Anti-Pattern 1: Hardcoding Collection IDs

**What goes wrong:** Referring to Fremont collection by ID instead of slug

**Why it's bad:**
- IDs are auto-incremented and differ between dev/prod
- Breaks when seed order changes
- Not portable across environments

**Instead:**
```typescript
// BAD
const fremontId = 4; // Fragile!

// GOOD
const [collection] = await db
  .select({ id: collections.id })
  .from(collections)
  .where(eq(collections.slug, 'fremont-ca'))
  .limit(1);
```

---

### Anti-Pattern 2: Skipping Topic Documentation File

**What goes wrong:** Not creating `fremont-topics.ts` reference file

**Why it's bad:**
- Loses documentation of what was generated
- No reference for topic IDs after generation
- Harder to debug topic-related issues

**Instead:**
- Create `fremont-topics.ts` AFTER generation completes
- Document actual topic distribution from generation logs
- Include generation run metadata (date, question counts, source results)

---

### Anti-Pattern 3: Inconsistent Naming Conventions

**What goes wrong:** Using `fremont` instead of `fremont-ca` or `FremontCA` instead of `fremontConfig`

**Why it's bad:**
- Breaks image loading (`/images/collections/${slug}.jpg`)
- Breaks slug-based database queries
- Inconsistent with established pattern

**Convention checklist:**
- Collection slug: `fremont-ca` (kebab-case, city-state)
- Config export: `fremontConfig` (camelCase)
- Config file: `fremont-ca.ts` (matches slug)
- Data file: `fremont-ca-questions.json` (matches slug)
- Image file: `fremont-ca.jpg` (matches slug)
- External ID prefix: `fre` (3-letter, lowercase)

---

### Anti-Pattern 4: Generating Questions Without RAG Sources

**What goes wrong:** Running generation without `--fetch-sources` first

**Why it's bad:**
- AI relies on training data (less accurate, may hallucinate)
- Questions lack authoritative source citations
- Lower quality than RAG-enhanced generation

**Instead:**
```bash
# ALWAYS fetch sources first
npx tsx generate-locale-questions.ts --locale fremont-ca --fetch-sources

# THEN generate
npx tsx generate-locale-questions.ts --locale fremont-ca
```

---

## Integration Checklist

Before declaring Fremont collection complete:

### Configuration Phase
- [ ] `locale-configs/fremont-ca.ts` created with 8 topic categories
- [ ] Source URLs curated (10-15 authoritative .gov sites)
- [ ] Topic distribution sums to ~100 questions
- [ ] External ID prefix chosen (3-letter, unique, lowercase)

### Generation Phase
- [ ] RAG sources fetched (`--fetch-sources` succeeded)
- [ ] 100 questions generated across 4 batches
- [ ] Zod validation passed for all questions
- [ ] Questions seeded with `status='draft'`
- [ ] `fremont-topics.ts` documentation created

### Review Phase
- [ ] Admin reviewed all draft questions
- [ ] 80-100 questions activated (`status='active'`)
- [ ] Difficulty distribution balanced (30/40/30 target)
- [ ] Time-sensitive questions have `expiresAt` set

### Activation Phase
- [ ] Collection metadata added to `collections.ts`
- [ ] `generate-locale-questions.ts` updated with fremont-ca support
- [ ] `export-community.ts` updated with fremont-ca export
- [ ] `seed-community.ts` updated with fremont-ca in LOCALES
- [ ] `fremont-ca-questions.json` generated and committed
- [ ] Collection card image added (`fremont-ca.jpg`)
- [ ] Collection set to `isActive: true`

### Verification Phase
- [ ] Collection appears in picker with correct name/description
- [ ] Collection card image loads
- [ ] Game can be started with Fremont collection
- [ ] Questions are Fremont-specific (not federal or other locale)
- [ ] Collection name displays during play and on results screen
- [ ] Admin panel shows Fremont questions

---

## Database Schema (Existing — No Changes)

The database schema already supports unlimited collections via many-to-many relationships:

```
collections (1) ─────< collection_topics (N) >───── (N) topics
                                                          │
collections (1) ─────< collection_questions (N) >─── (N) questions
                                                          │
                                                    topics (1) ───< questions (N)
```

**Key tables:**
- `collections`: Collection metadata (name, slug, description, themeColor, isActive)
- `topics`: Topic categories (shared across collections)
- `questions`: Individual questions (linked via collectionQuestions)
- `collection_topics`: Which topics belong to which collections
- `collection_questions`: Which questions belong to which collections

**Fremont integration:** No schema changes. Fremont collection is just more rows in existing tables.

---

## Source Files Reference

### Verified File Paths (Existing)

| Category | File Path | Purpose |
|----------|-----------|---------|
| **Seed Scripts** | `backend/src/db/seed/seed.ts` | Main seed (federal collection) |
| | `backend/src/db/seed/seed-community.ts` | Community collection seed |
| | `backend/src/db/seed/collections.ts` | Collection metadata |
| | `backend/src/db/seed/bloomington-topics.ts` | Bloomington topic reference |
| | `backend/src/db/seed/los-angeles-topics.ts` | LA topic reference |
| **Generation** | `backend/src/scripts/content-generation/generate-locale-questions.ts` | AI question generator |
| | `backend/src/scripts/content-generation/locale-configs/bloomington-in.ts` | Bloomington config |
| | `backend/src/scripts/content-generation/locale-configs/los-angeles-ca.ts` | LA config |
| | `backend/src/scripts/content-generation/rag/fetch-sources.ts` | RAG source fetcher |
| **Export** | `backend/src/scripts/export-community.ts` | Database → JSON exporter |
| **Data** | `backend/src/data/bloomington-in-questions.json` | Bloomington seed data |
| | `backend/src/data/los-angeles-ca-questions.json` | LA seed data |
| **Frontend** | `frontend/src/features/collections/components/CollectionCard.tsx` | Collection card component |
| | `frontend/src/features/collections/components/CollectionPicker.tsx` | Collection picker |
| | `frontend/public/images/collections/bloomington-in.jpg` | Bloomington card image |
| | `frontend/public/images/collections/los-angeles-ca.jpg` | LA card image |

---

## Estimated Effort

| Phase | Tasks | Time Estimate |
|-------|-------|---------------|
| Phase 1: Configuration & Research | Research Fremont government structure, curate sources, create config | 2-3 hours |
| Phase 2: Source Fetch & Generation | Fetch sources, run generation (4 batches), create topic reference | 1-2 hours |
| Phase 3: Review & Activation | Human review of 100 questions, activation decisions | 3-4 hours |
| Phase 4: Collection Activation & Export | Code updates, export, image sourcing | 1 hour |
| Phase 5: Verification & Testing | End-to-end testing, bug fixes | 1 hour |
| **Total** | | **8-11 hours** |

**Note:** Time estimates assume familiarity with the existing pattern. First-time implementation may take longer.

---

## Success Criteria

Fremont collection is complete when:

1. **Visible:** Collection appears in picker with name "Fremont, CA" and appropriate description
2. **Playable:** User can start and complete a game using only Fremont questions
3. **Accurate:** Questions are Fremont-specific (verifiable against source documents)
4. **Portable:** `fremont-ca-questions.json` exists and seeds correctly via `db:seed:community`
5. **Documented:** `fremont-topics.ts` reference file exists with generation metadata
6. **Branded:** Collection card displays `fremont-ca.jpg` image

---

## References

**Existing Collections (Templates):**
- Bloomington IN: `locale-configs/bloomington-in.ts`, `bloomington-topics.ts`, `bloomington-in-questions.json`
- Los Angeles CA: `locale-configs/los-angeles-ca.ts`, `los-angeles-topics.ts`, `los-angeles-ca-questions.json`

**Pipeline Documentation:**
- v1.2 Roadmap: `.planning/milestones/v1.2-ROADMAP.md`
- Generation Script: `backend/src/scripts/content-generation/generate-locale-questions.ts` (lines 1-80 have usage docs)
- Seed Script: `backend/src/db/seed/seed-community.ts` (lines 1-12 have usage docs)

**Fremont Government Sources (Starting Point):**
- City of Fremont: https://www.fremont.gov
- Fremont City Council: https://www.fremont.gov/government/city-council
- Alameda County: https://www.acgov.org
- California State: https://www.ca.gov

---

_This architecture document is based on verified code patterns from v1.2 (Bloomington IN, Los Angeles CA) and v1.3 (Indiana, California state collections). All file paths and integration points have been validated against the existing codebase._
