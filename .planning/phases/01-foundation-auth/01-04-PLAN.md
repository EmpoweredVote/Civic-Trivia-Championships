---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - frontend/src/App.tsx
  - frontend/src/components/ProtectedRoute.tsx
  - frontend/src/components/AuthInitializer.tsx
  - frontend/src/components/layout/Header.tsx
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/services/api.ts
autonomous: false

must_haves:
  truths:
    - "User session persists across browser refresh"
    - "User can log out from any screen"
    - "Unauthenticated users are redirected to login"
    - "Authenticated users can access protected routes"
    - "App shows loading state during auth initialization"
  artifacts:
    - path: "frontend/src/components/ProtectedRoute.tsx"
      provides: "Route protection wrapper"
      min_lines: 15
    - path: "frontend/src/components/AuthInitializer.tsx"
      provides: "Session refresh on app load"
      min_lines: 20
    - path: "frontend/src/components/layout/Header.tsx"
      provides: "Navigation with logout button"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/AuthInitializer.tsx"
      to: "frontend/src/services/authService.ts"
      via: "refresh on mount"
      pattern: "authService\\.refresh"
    - from: "frontend/src/components/layout/Header.tsx"
      to: "frontend/src/services/authService.ts"
      via: "logout call"
      pattern: "authService\\.logout"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ProtectedRoute.tsx"
      via: "route wrapping"
      pattern: "ProtectedRoute|element.*ProtectedRoute"
---

<objective>
Implement session persistence, protected routes, and logout functionality to complete the authentication flow.

Purpose: Ensure users stay logged in across browser refreshes (AUTH-04), can access protected pages only when authenticated, and can log out from any screen (AUTH-03). This completes the end-to-end auth experience.
Output: Fully functional authentication flow with session persistence, protected routes, and logout.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement session persistence and protected routes</name>
  <files>
    frontend/src/components/AuthInitializer.tsx
    frontend/src/components/ProtectedRoute.tsx
    frontend/src/services/api.ts
  </files>
  <action>
    Create session management components:

    1. Create src/components/AuthInitializer.tsx:
       - Props: children: React.ReactNode
       - Get { setAuth, clearAuth, setLoading, isLoading } from useAuthStore
       - useEffect on mount:
         - Call authService.refresh()
         - On success: setAuth(accessToken, user)
         - On error: clearAuth() (no valid session)
         - Finally: setLoading(false)
       - If isLoading, render loading spinner:
         - min-h-screen flex items-center justify-center bg-gray-50
         - Animated spinner div with border-teal-600
         - "Loading..." text
       - Otherwise render children
       - This ensures refresh token cookie is checked before any route renders

    2. Create src/components/ProtectedRoute.tsx:
       - Use Outlet from react-router-dom
       - Get { isAuthenticated, isLoading } from useAuthStore
       - If isLoading, return null (AuthInitializer handles loading UI)
       - If not authenticated, return <Navigate to="/login" replace />
       - Otherwise render <Outlet />

    3. Update src/services/api.ts:
       - Add 401 response interceptor pattern:
         - Create apiRequest function that handles 401 specially
         - On 401, attempt authService.refresh() once
         - If refresh succeeds, retry original request
         - If refresh fails, clear auth and redirect to /login
       - Use a flag to prevent infinite refresh loops
  </action>
  <verify>
    Session persists: Login, refresh page, still logged in
    Protected routes: Visit /dashboard without login, redirected to /login
    401 handling: API returns 401, auto-refresh attempted
  </verify>
  <done>
    Sessions persist across refresh, protected routes redirect unauthenticated users, 401s trigger refresh
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Header with logout and Dashboard page</name>
  <files>
    frontend/src/components/layout/Header.tsx
    frontend/src/pages/Dashboard.tsx
  </files>
  <action>
    Build navigation and protected page:

    1. Create src/components/layout/Header.tsx:
       - Get { user, accessToken, clearAuth } from useAuthStore
       - Get navigate from useNavigate
       - handleLogout: async, call authService.logout(accessToken), clearAuth(), navigate('/login')
       - Layout: sticky top-0 z-50 bg-white shadow-sm border-b border-gray-200
       - Container: max-w-7xl mx-auto px-4 sm:px-6 lg:px-8
       - Flex between: logo/title left, user info/logout right
       - Logo: text-xl font-bold text-teal-600, "Civic Trivia"
       - If authenticated:
         - Show user name or email: text-sm text-gray-700
         - Logout button: text-sm text-gray-500 hover:text-gray-700, "Log out"
       - Mobile responsive: name hidden on small screens, just show logout button

    2. Create src/pages/Dashboard.tsx:
       - Get { user } from useAuthStore
       - Layout: min-h-screen bg-gray-50
       - Include Header component at top
       - Main content: max-w-7xl mx-auto py-6 sm:px-6 lg:px-8
       - Welcome message: "Welcome, {user.name}!"
       - Placeholder content: "Game features coming soon..."
       - Card style: bg-white shadow rounded-lg p-6
  </action>
  <verify>
    Header displays user info when logged in
    Logout button works and redirects to login
    Dashboard shows welcome message with user name
  </verify>
  <done>
    Header with logout works from any screen, Dashboard displays user info
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up React Router with all routes</name>
  <files>
    frontend/src/App.tsx
  </files>
  <action>
    Complete the routing setup:

    1. Update src/App.tsx:
       - Import BrowserRouter, Routes, Route from react-router-dom
       - Import AuthInitializer
       - Import ProtectedRoute
       - Import pages: Login, Signup, Dashboard
       - Structure:
         ```tsx
         <BrowserRouter>
           <AuthInitializer>
             <Routes>
               {/* Public routes */}
               <Route path="/login" element={<Login />} />
               <Route path="/signup" element={<Signup />} />

               {/* Protected routes */}
               <Route element={<ProtectedRoute />}>
                 <Route path="/" element={<Dashboard />} />
                 <Route path="/dashboard" element={<Dashboard />} />
               </Route>
             </Routes>
           </AuthInitializer>
         </BrowserRouter>
         ```
       - AuthInitializer wraps everything to check session on load
       - ProtectedRoute wraps routes requiring authentication
  </action>
  <verify>
    Full flow works:
    1. Visit / while logged out -> redirected to /login
    2. Sign up -> logged in, redirected to /
    3. Refresh page -> still logged in (session persists)
    4. Click logout -> redirected to /login, session cleared
    5. Can't access / without logging in again
  </verify>
  <done>
    Complete auth flow working with session persistence, protected routes, and logout
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete authentication system with:
    - User signup with email, password, name
    - User login with email, password
    - Session persistence across browser refresh
    - Protected routes (Dashboard)
    - Logout from header on any screen
    - Mobile responsive design
    - Clear error messages for auth failures
  </what-built>
  <how-to-verify>
    Prerequisites:
    - PostgreSQL running with database created
    - Redis running
    - Backend .env configured with real secrets

    Test flow:
    1. Start servers: `npm run dev` from project root
    2. Visit http://localhost:5173
    3. Should redirect to /login (not authenticated)
    4. Click "Sign up" link, fill form:
       - Name: Test User
       - Email: test@example.com
       - Password: Password123
    5. Should redirect to dashboard, see "Welcome, Test User!"
    6. Refresh the page (F5 or browser refresh)
    7. Should still be on dashboard, still logged in (AUTH-04: session persists)
    8. Click "Log out" in header
    9. Should redirect to /login
    10. Try to visit http://localhost:5173/ directly
    11. Should redirect to /login (protected route)
    12. Log in with test@example.com / Password123
    13. Should see dashboard again

    Error handling tests:
    14. Log out, try to sign up with same email -> should see "Email already registered" error
    15. Try to log in with wrong password -> should see "Invalid email or password" error
    16. Try to sign up with password "weak" -> should see validation error

    Mobile test:
    17. Open browser DevTools, toggle device toolbar (mobile view)
    18. Verify login/signup forms are usable on small screen
    19. Verify header logout button is accessible on mobile
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Session persistence: Login, refresh page, still authenticated (AUTH-04)
2. Logout works: Clicking logout clears session and redirects (AUTH-03)
3. Protected routes: Unauthenticated users redirected to login
4. Full flow: Signup -> Dashboard -> Refresh -> Still logged in -> Logout -> Login -> Dashboard
5. Error messages: Clear, specific error messages for auth failures (AUTH-05)
6. Mobile responsive: Auth forms and header work on mobile (PERF-05)
</verification>

<success_criteria>
- AUTH-01: User can sign up with email and password
- AUTH-02: User can log in with email and password
- AUTH-03: User can log out from any screen (header logout button)
- AUTH-04: User session persists across browser refresh (refresh token in cookie)
- AUTH-05: User receives clear error messages for auth failures
- PERF-05: Mobile responsive design works on phones and tablets
- Protected routes redirect unauthenticated users to login
- Loading state shown during initial auth check
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
