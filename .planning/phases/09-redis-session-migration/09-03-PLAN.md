---
phase: 09-redis-session-migration
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - frontend/src/services/gameService.ts
  - frontend/src/components/DegradedBanner.tsx
  - frontend/src/features/game/components/GameScreen.tsx
autonomous: false

must_haves:
  truths:
    - "User sees subtle banner when app is running in degraded (in-memory) mode"
    - "Banner is invisible during normal Redis operation"
    - "Banner message communicates sessions may not persist without alarming user"
    - "Degraded state is detected from API response, not by polling"
  artifacts:
    - path: "frontend/src/components/DegradedBanner.tsx"
      provides: "Subtle banner component for degraded mode"
      exports: ["DegradedBanner"]
    - path: "frontend/src/services/gameService.ts"
      provides: "Game service that extracts degraded flag from API responses"
      contains: "degraded"
  key_links:
    - from: "frontend/src/services/gameService.ts"
      to: "/api/game/session"
      via: "extracts degraded boolean from session creation response"
      pattern: "degraded"
    - from: "frontend/src/components/DegradedBanner.tsx"
      to: "frontend/src/features/game/components/GameScreen.tsx"
      via: "rendered conditionally based on degraded state"
      pattern: "DegradedBanner|degraded"
---

<objective>
Add a subtle frontend indicator when the app is running in degraded (in-memory) mode, so users know sessions may not persist across server restarts.

Purpose: User decision from CONTEXT.md requires a visible-but-subtle indicator during degraded operation. This is the only user-facing change in the Redis migration phase.

Output: DegradedBanner component, updated gameService to extract degraded flag, GameScreen integration
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-redis-session-migration/09-CONTEXT.md
@.planning/phases/09-redis-session-migration/09-02-SUMMARY.md
@frontend/src/services/gameService.ts
@frontend/src/features/game/components/GameScreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract degraded flag from API and create banner component</name>
  <files>
    frontend/src/services/gameService.ts
    frontend/src/components/DegradedBanner.tsx
  </files>
  <action>
**frontend/src/services/gameService.ts** - Update to capture degraded flag:

When creating a game session (the call to `POST /api/game/session`), the response now includes an optional `degraded: boolean` field. Extract this flag and make it available to the game flow. Options:
- Return it alongside sessionId from the session creation function
- Store it in a module-level variable that components can read
- Add it to the game state/store

Simplest approach: return `{ sessionId, questions, degraded }` from the session creation call. The game hook/reducer can store it.

**frontend/src/components/DegradedBanner.tsx** - Create subtle degraded mode indicator:

A small, non-intrusive banner that appears at the top of the game screen when `degraded` is true. Design guidelines:
- Position: Fixed or sticky at top of game area, not overlapping content
- Style: Subtle amber/yellow background with dark text, small font size (text-xs or text-sm)
- Message: "Session storage is temporarily limited -- your game progress may not persist if the server restarts" or similar non-alarming phrasing
- Include a dismiss/close button (X) so user can hide it
- Use Tailwind classes consistent with existing app styling (slate backgrounds, game-show aesthetic)
- Add `role="status"` and `aria-live="polite"` for accessibility (matches existing announcement patterns from Phase 7)
- Animate in with a subtle fade using Framer Motion (consistent with app animation patterns)

Component signature:
```typescript
interface DegradedBannerProps {
  visible: boolean;
}
export function DegradedBanner({ visible }: DegradedBannerProps): JSX.Element | null
```

Returns null when `visible` is false or after user dismisses it. Uses local useState for dismissed tracking.
  </action>
  <verify>
`npx tsc --noEmit` passes from frontend/. DegradedBanner component renders when visible=true, shows nothing when visible=false. gameService returns degraded flag from session creation.
  </verify>
  <done>
DegradedBanner component exists with accessible, dismissible, subtle amber banner. gameService extracts degraded flag from POST /api/game/session response.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Redis session migration with graceful degradation:
1. Storage abstraction (SessionStorage interface + MemoryStorage + RedisStorage)
2. Async SessionManager migration
3. Health endpoint at /health with Redis status
4. Docker Compose for local Redis
5. Frontend degraded mode banner

This checkpoint verifies the ENTIRE phase, not just Plan 03.
  </what-built>
  <how-to-verify>
**Test 1: In-memory mode (no Redis)**
1. Stop any running Redis containers
2. Start backend WITHOUT REDIS_URL: `cd backend && npm run dev`
3. Confirm log shows "in-memory storage" message
4. Open app in browser, start a game, play through
5. Verify the subtle degraded banner appears at the top of the game screen
6. Verify you can dismiss the banner with the X button
7. Visit http://localhost:3000/health — should show `storage.type: "memory"`, `status: "healthy"`

**Test 2: Redis mode**
1. Start Redis: `docker compose up -d` from project root
2. Start backend WITH Redis: `REDIS_URL=redis://localhost:6379 npm run dev` (or add to .env)
3. Confirm log shows "Connected to Redis"
4. Open app, start a game, play through — degraded banner should NOT appear
5. Visit http://localhost:3000/health — should show `storage.type: "redis"`, `status: "healthy"`
6. Restart the backend server (Ctrl+C, restart)
7. Visit http://localhost:3000/health — session count should still show previous sessions (persistence!)

**Test 3: Graceful degradation**
1. With Redis running and backend connected, stop Redis: `docker compose down`
2. Backend should NOT crash
3. Visit http://localhost:3000/health — should show `status: "degraded"` with 503
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Frontend compiles without errors
2. DegradedBanner shows only in degraded mode, hidden in normal Redis operation
3. Banner is accessible (role="status", aria-live)
4. Banner is dismissible
5. Full game flow works in both modes
6. Health endpoint reports correct storage status
</verification>

<success_criteria>
- Degraded banner visible ONLY when backend is in fallback mode
- Banner is subtle, non-alarming, and dismissible
- Game flow completely unchanged in normal operation
- Phase 9 success criteria met:
  1. Sessions survive server restart (with Redis)
  2. Redis TTL provides 1-hour expiry
  3. Graceful degradation to in-memory when Redis unavailable
  4. Sub-5ms local Redis latency (inherent)
  5. Storage abstraction supports multi-instance (shared Redis)
</success_criteria>

<output>
After completion, create `.planning/phases/09-redis-session-migration/09-03-SUMMARY.md`
</output>
