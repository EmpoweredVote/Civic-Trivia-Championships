---
phase: 18-foundation-admin-auth-telemetry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/models/User.ts
  - backend/src/utils/tokenUtils.ts
  - backend/src/controllers/authController.ts
  - backend/src/middleware/auth.ts
  - backend/src/routes/admin.ts
autonomous: true

must_haves:
  truths:
    - "A non-admin user hitting any /api/admin endpoint receives 403 with error message"
    - "An admin user can access /api/admin endpoints normally"
    - "JWT access token includes isAdmin claim reflecting the user's is_admin column"
    - "Login and refresh responses include isAdmin in the user object"
  artifacts:
    - path: "backend/src/middleware/auth.ts"
      provides: "requireAdmin middleware function"
      exports: ["requireAdmin"]
    - path: "backend/src/utils/tokenUtils.ts"
      provides: "TokenPayload with isAdmin field"
      contains: "isAdmin"
    - path: "backend/src/controllers/authController.ts"
      provides: "isAdmin in login/refresh user response"
      contains: "isAdmin"
    - path: "backend/src/models/User.ts"
      provides: "User interface with isAdmin field, queries include is_admin"
      contains: "isAdmin"
    - path: "backend/src/routes/admin.ts"
      provides: "Admin routes protected by requireAdmin middleware"
      contains: "requireAdmin"
  key_links:
    - from: "backend/src/controllers/authController.ts"
      to: "backend/src/utils/tokenUtils.ts"
      via: "generateAccessToken includes isAdmin in payload"
      pattern: "isAdmin.*generateAccessToken|generateAccessToken.*isAdmin"
    - from: "backend/src/routes/admin.ts"
      to: "backend/src/middleware/auth.ts"
      via: "router.use(authenticateToken, requireAdmin)"
      pattern: "requireAdmin"
    - from: "backend/src/models/User.ts"
      to: "database users table"
      via: "SQL queries selecting is_admin column"
      pattern: "is_admin"
---

<objective>
Add admin role infrastructure to the backend: is_admin column on users table, isAdmin in JWT tokens, requireAdmin middleware, and protect all /api/admin routes.

Purpose: Security prerequisite for all admin features in v1.3. Without this, anyone with a valid JWT can access admin endpoints.
Output: Backend admin role-check system where non-admin users get 403, admin users pass through normally.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-foundation-admin-auth-telemetry/18-CONTEXT.md
@.planning/phases/18-foundation-admin-auth-telemetry/18-RESEARCH.md

@backend/src/middleware/auth.ts
@backend/src/utils/tokenUtils.ts
@backend/src/models/User.ts
@backend/src/controllers/authController.ts
@backend/src/routes/admin.ts
@backend/src/config/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add is_admin column and update User model + JWT pipeline</name>
  <files>
    backend/src/models/User.ts
    backend/src/utils/tokenUtils.ts
    backend/src/controllers/authController.ts
  </files>
  <action>
  1. **Add is_admin column to users table via raw SQL migration.**
     The users table is managed with raw SQL (not Drizzle). Run a migration query at server startup or via a script:
     ```sql
     ALTER TABLE users ADD COLUMN IF NOT EXISTS is_admin BOOLEAN NOT NULL DEFAULT false;
     ```
     Create a migration script at `backend/src/scripts/migrate-admin-role.ts` that connects to the database and runs this ALTER TABLE. Also run it directly against the database (use the existing `pool` from `config/database.ts`).

  2. **Update User model (`backend/src/models/User.ts`):**
     - Add `isAdmin: boolean` to the `User` interface
     - Add `is_admin as "isAdmin"` to ALL SELECT queries in `findByEmail`, `findById`, `getProfileStats`
     - No changes needed to `create` (defaults to false) or `updateStats`

  3. **Update TokenPayload and generateAccessToken (`backend/src/utils/tokenUtils.ts`):**
     - Add `isAdmin?: boolean` to the `TokenPayload` interface
     - Update `generateAccessToken` signature to accept `{ id: number; email: string; isAdmin?: boolean }` and include `isAdmin: user.isAdmin || false` in the JWT payload

  4. **Update authController (`backend/src/controllers/authController.ts`):**
     - In `login`: after finding user, pass `isAdmin: user.isAdmin` to `generateAccessToken`. Include `isAdmin: user.isAdmin || false` in the response user object.
     - In `refresh`: after finding user via `User.findById`, pass `isAdmin: user.isAdmin` to `generateAccessToken`. Include `isAdmin: user.isAdmin || false` in the response user object.
     - In `signup`: no changes needed (new users are not admin).

  5. **First admin designation:** Use environment variable approach. In the `login` function, after successful password verification, check if the user's email matches `process.env.ADMIN_EMAIL`. If it matches and `user.isAdmin` is false, run an UPDATE query to set `is_admin = true` for that user. This is a one-time promotion -- subsequent logins skip the UPDATE since `isAdmin` is already true. Log a console message when an admin is promoted: `console.log('Admin role granted to:', user.email)`.

  IMPORTANT: Do NOT modify the Drizzle schema file (backend/src/db/schema.ts) -- the users table is not in Drizzle, it uses raw SQL via the `pool` connection.
  </action>
  <verify>
    - `npx tsx backend/src/scripts/migrate-admin-role.ts` runs without error
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
    - User model queries return isAdmin field
    - TokenPayload type includes isAdmin
  </verify>
  <done>
    - User interface has isAdmin: boolean
    - All User.findByEmail/findById/getProfileStats queries return is_admin as isAdmin
    - generateAccessToken accepts and encodes isAdmin in JWT
    - Login and refresh endpoints return isAdmin in user object
    - ADMIN_EMAIL env var check promotes first admin on login
    - Migration script exists and runs cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create requireAdmin middleware and protect admin routes</name>
  <files>
    backend/src/middleware/auth.ts
    backend/src/routes/admin.ts
  </files>
  <action>
  1. **Create requireAdmin middleware in `backend/src/middleware/auth.ts`:**
     Add a new exported function `requireAdmin` after the existing `optionalAuth` function:
     ```typescript
     export function requireAdmin(
       req: Request,
       res: Response,
       next: NextFunction
     ): void {
       if (!req.user) {
         res.status(401).json({ error: 'Authentication required' });
         return;
       }
       if (!req.user.isAdmin) {
         res.status(403).json({ error: 'Admin access required' });
         return;
       }
       next();
     }
     ```
     This is synchronous -- no need for async since req.user is already populated by authenticateToken.

     Note: The `req.user` type is `TokenPayload` which now includes `isAdmin?: boolean`. The check `!req.user.isAdmin` correctly handles both `undefined` and `false`.

  2. **Update admin routes (`backend/src/routes/admin.ts`):**
     - Import `requireAdmin` alongside `authenticateToken` from middleware
     - Change `router.use(authenticateToken)` to `router.use(authenticateToken, requireAdmin)`
     - This ensures ALL admin routes require both authentication AND admin role

  The order matters: `authenticateToken` first (populates req.user from JWT), then `requireAdmin` (checks isAdmin on req.user). If authenticateToken rejects, requireAdmin never runs.
  </action>
  <verify>
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
    - `requireAdmin` is exported from auth.ts
    - admin.ts router.use includes both authenticateToken and requireAdmin
  </verify>
  <done>
    - requireAdmin middleware exported from backend/src/middleware/auth.ts
    - Non-admin authenticated users get 403 with `{ error: "Admin access required" }`
    - Unauthenticated users get 401 (from authenticateToken, before requireAdmin)
    - Admin users pass through to route handlers normally
    - All existing admin routes (GET /questions, POST /questions/:id/renew, POST /questions/:id/archive) are protected
  </done>
</task>

</tasks>

<verification>
1. Migration script runs and adds is_admin column to users table
2. TypeScript compiles with no errors: `cd backend && npx tsc --noEmit`
3. Login response includes `isAdmin: false` for regular users
4. JWT token payload includes isAdmin claim
5. Non-admin user hitting `/api/admin/questions` receives 403
6. Admin user (after ADMIN_EMAIL promotion) can access admin endpoints
</verification>

<success_criteria>
- is_admin column exists on users table with NOT NULL DEFAULT false
- requireAdmin middleware rejects non-admins with 403
- JWT tokens carry isAdmin claim
- Login and refresh responses include isAdmin in user object
- ADMIN_EMAIL env var mechanism promotes first admin
- All admin routes require admin role
</success_criteria>

<output>
After completion, create `.planning/phases/18-foundation-admin-auth-telemetry/18-01-SUMMARY.md`
</output>
