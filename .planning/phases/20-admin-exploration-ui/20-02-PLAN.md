---
phase: 20-admin-exploration-ui
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - frontend/src/pages/admin/QuestionsPage.tsx
  - frontend/src/pages/admin/components/QuestionTable.tsx
  - frontend/src/pages/admin/components/QuestionDetailPanel.tsx
  - frontend/src/pages/admin/components/DifficultyRate.tsx
  - frontend/src/hooks/useDebounce.ts
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can view a paginated table of questions with columns: text, collection, difficulty, quality score, encounters, correct rate, status, created date"
    - "Admin can sort the table by clicking column headers (quality score, difficulty, encounters, correct rate, created date)"
    - "Admin can filter by collection, difficulty, and status using dropdown selects"
    - "Admin can search across question text, answers, and explanations using a search bar"
    - "Filter state persists in URL query params and survives page refresh"
    - "Admin can click a question row to open a slide-over detail panel showing full question, all 4 options (correct highlighted), explanation, Learn More link, quality violations, and telemetry"
    - "Detail panel has prev/next arrows to navigate between questions without closing"
    - "Calculated difficulty rate shows percentage for questions with 20+ encounters and 'insufficient data' for fewer"
  artifacts:
    - path: "frontend/src/pages/admin/QuestionsPage.tsx"
      provides: "Question explorer page with search, filters, and table"
      min_lines: 80
    - path: "frontend/src/pages/admin/components/QuestionTable.tsx"
      provides: "Sortable data table component"
      min_lines: 60
    - path: "frontend/src/pages/admin/components/QuestionDetailPanel.tsx"
      provides: "Slide-over detail panel with Headless UI Dialog"
      min_lines: 100
    - path: "frontend/src/pages/admin/components/DifficultyRate.tsx"
      provides: "TELE-03 calculated difficulty rate display component"
      min_lines: 15
    - path: "frontend/src/hooks/useDebounce.ts"
      provides: "Reusable debounce hook for search input"
      min_lines: 10
  key_links:
    - from: "frontend/src/pages/admin/QuestionsPage.tsx"
      to: "/api/admin/questions/explore"
      via: "fetch with useSearchParams-driven query string"
      pattern: "fetch.*admin/questions/explore"
    - from: "frontend/src/pages/admin/components/QuestionDetailPanel.tsx"
      to: "/api/admin/questions/:id/detail"
      via: "fetch when questionId changes"
      pattern: "fetch.*admin/questions.*detail"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/admin/QuestionsPage.tsx"
      via: "React Router nested route under /admin"
      pattern: "Route.*questions.*QuestionsPage"
---

<objective>
Build the question explorer page: a paginated, sortable, filterable table of questions with a slide-over detail panel. This is the primary admin tool for exploring and inspecting question content and quality.

Purpose: EXPL-01 (sortable/filterable table), EXPL-02 (question detail view), TELE-03 (calculated difficulty rate), and partial EXPL-04 (frontend consuming the API endpoints from Plan 01).
Output: QuestionsPage with table, filters, search, pagination, slide-over detail panel, and difficulty rate component. Route wired at /admin/questions.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-admin-exploration-ui/20-CONTEXT.md
@.planning/phases/20-admin-exploration-ui/20-RESEARCH.md
@.planning/phases/20-admin-exploration-ui/20-01-SUMMARY.md

# Existing admin shell and routing
@frontend/src/pages/admin/AdminLayout.tsx
@frontend/src/App.tsx

# Quality violation types (for detail panel display)
@backend/src/services/qualityRules/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Question explorer page with table, filters, search, and pagination</name>
  <files>
    frontend/src/pages/admin/QuestionsPage.tsx
    frontend/src/pages/admin/components/QuestionTable.tsx
    frontend/src/pages/admin/components/DifficultyRate.tsx
    frontend/src/hooks/useDebounce.ts
    frontend/src/App.tsx
  </files>
  <action>
**1. Create useDebounce hook** at `frontend/src/hooks/useDebounce.ts`:
- Generic hook: `function useDebounce<T>(value: T, delay: number): T`
- Uses useState + useEffect with setTimeout/clearTimeout cleanup
- 300ms delay for search (caller specifies)

**2. Create DifficultyRate component** at `frontend/src/pages/admin/components/DifficultyRate.tsx`:
- Props: `{ correctCount: number; encounterCount: number; minEncounters?: number }`
- Default minEncounters = 20 (per Phase 20 success criteria)
- If encounterCount < minEncounters: render gray text "Insufficient data (N encounters)"
- Otherwise: render `Math.round((correctCount / encounterCount) * 100)` with color coding:
  - < 30%: text-red-600 (very hard)
  - 30-60%: text-yellow-600 (moderate)
  - > 60%: text-green-600 (easy)
- This fulfills TELE-03 requirement

**3. Create QuestionTable component** at `frontend/src/pages/admin/components/QuestionTable.tsx`:
- Props: `{ questions: QuestionRow[]; sort: string; order: string; onSortChange: (column: string) => void; onQuestionClick: (id: number, index: number) => void; }`
- Define QuestionRow interface matching the API response data shape (id, externalId, text, difficulty, qualityScore, status, encounterCount, correctCount, createdAt, collectionNames)
- Native HTML `<table>` with Tailwind styling (red-themed headers matching admin shell)
- Columns: Question Text (truncated), Collection(s), Difficulty, Quality Score, Encounters, Correct Rate (DifficultyRate component), Status, Created
- Sortable columns: quality_score, difficulty, encounter_count, correct_count, created_at -- render sort indicator arrow on active column
- Click handler on row to open detail panel
- Quality score cell: show score number, or gray "Not scored" if null
- Status cell: badge styling (green for active, red for archived, yellow for expired)
- Difficulty cell: badge styling (green/yellow/red for easy/medium/hard)
- Table should show loading skeleton (animate-pulse) when data is null/undefined
- Export QuestionRow type for use by QuestionsPage

**4. Create QuestionsPage** at `frontend/src/pages/admin/QuestionsPage.tsx`:
- Uses `useSearchParams` from react-router-dom as single source of truth for all filter/sort/page state
- Reads from URL: page, limit (default 25), sort (default 'quality_score'), order (default 'asc'), collection, difficulty, status, search
- State: questions data array, pagination metadata, loading boolean, error string, selectedQuestionId (number|null), selectedQuestionIndex (number)
- Search input at top: controlled text input that updates local state, debounced via useDebounce(300ms), debounced value syncs to URL `search` param
- Filter row below search: three `<select>` dropdowns for collection (fetch collection list from /api/admin/collections/health or hardcode known collections), difficulty (easy/medium/hard), status (active/archived/expired). Each syncs to URL params. All have "All" default option.
- On URL param change: fetch from `GET /api/admin/questions/explore?{params}` with all current params
- Use the auth token from authStore for fetch: `headers: { Authorization: \`Bearer ${token}\` }`
- Render QuestionTable with data
- Pagination controls below table: "Page X of Y" with Prev/Next buttons, disabled at boundaries. "Showing N-M of Total" text.
- When filter changes: reset page to 1 (update URL param)
- When a question row is clicked: set selectedQuestionId and selectedQuestionIndex, which opens the detail panel (built in Task 2)
- IMPORTANT: Do NOT create infinite re-render loops. Only update URL from user actions (input onChange, select onChange, button onClick). Fetch data in useEffect that watches searchParams.toString(). Do NOT watch individual params in separate useEffects that also update URL.

**5. Wire route in App.tsx**:
- Import QuestionsPage from `./pages/admin/QuestionsPage`
- Add nested route under the AdminLayout: `<Route path="questions" element={<QuestionsPage />} />`
- This goes where the `{/* Future admin routes will be added here in Phase 20 */}` comment is
  </action>
  <verify>
```
cd frontend && npx tsc --noEmit && npm run build
```
Build should succeed. Verify QuestionsPage route is accessible by checking App.tsx has the route definition.
  </verify>
  <done>
QuestionsPage renders at /admin/questions with: search bar, 3 filter dropdowns, sortable table with all required columns, pagination controls. All filter/sort/page state persists in URL. DifficultyRate component shows calculated difficulty or "insufficient data" (TELE-03). Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slide-over question detail panel with prev/next navigation</name>
  <files>
    frontend/src/pages/admin/components/QuestionDetailPanel.tsx
    frontend/src/pages/admin/QuestionsPage.tsx
  </files>
  <action>
**1. Create QuestionDetailPanel** at `frontend/src/pages/admin/components/QuestionDetailPanel.tsx`:

Uses Headless UI Dialog + Transition (already installed) for accessible slide-over panel from the right.

Props:
```typescript
interface QuestionDetailPanelProps {
  questionId: number | null;
  onClose: () => void;
  onNavigate: (direction: 'prev' | 'next') => void;
  hasPrev: boolean;
  hasNext: boolean;
}
```

Panel is open when `questionId !== null`.

**Structure:**
- Headless UI `<Dialog>` wrapping `<Transition>` for slide animation
- Semi-transparent backdrop (bg-black/30)
- Panel slides from right: `translate-x-full` -> `translate-x-0`, max-w-2xl
- Header: red-900 bg with "Question Details" title, prev/next arrow buttons (left/right chevrons), and close X button. Prev/next buttons disabled based on hasPrev/hasNext props.
- Body: scrollable content area

**Data fetching:**
- useEffect watching questionId: when non-null, fetch `GET /api/admin/questions/${questionId}/detail` with auth token
- State: questionDetail (full question + audit), loading, error
- Show loading skeleton while fetching

**Inline violation badge helper:**

Create a helper function `getViolationsForSection(violations: Violation[], section: 'question' | 'options' | 'explanation' | 'source')` that maps violation rules to the content section they apply to:
- `'question'` section: rules `'partisan-framing'`, `'pure-lookup'` (violations about the question text itself)
- `'options'` section: rules `'ambiguous-answers'`, `'multiple-correct'` (violations about answer choices)
- `'explanation'` section: rules `'weak-explanation'`, `'no-explanation'` (violations about the explanation)
- `'source'` section: rules `'broken-source-link'`, `'no-source'` (violations about the source/URL)
- Any rule not in the above mappings: falls through to the `'question'` section as default

Create an `InlineViolationBadge` component (can be defined in the same file) that renders a small inline badge:
- Props: `{ violation: Violation }`
- Renders a compact pill/badge: red bg for blocking severity (`bg-red-100 text-red-800 border border-red-300`), yellow bg for advisory (`bg-yellow-100 text-yellow-800 border border-yellow-300`)
- Shows the rule name formatted as title case (e.g., "ambiguous-answers" -> "Ambiguous Answers") and severity icon (exclamation triangle for blocking, info circle for advisory)
- If `violation.evidence` exists, show it as a small tooltip or italic text below the badge

**Content layout (when loaded) -- violations shown BOTH inline AND in summary:**
- **Question text** - full text, large font, dark text. Below the question text, render inline violation badges for any violations matching the `'question'` section using the helper above. These badges appear directly beneath the question text they annotate, visually connected with a left border accent (e.g., `border-l-4 border-red-300 pl-3 mt-2` wrapper for blocking, `border-yellow-300` for advisory).
- **Answer options** - numbered list (A, B, C, D), correct answer highlighted with green bg + checkmark icon. Other options in neutral styling. After the options list, render inline violation badges for any violations matching the `'options'` section. If a violation has `evidence` text that matches specific option text, highlight that specific option with a red/yellow left border instead of green.
- **Explanation** - below options, gray bg section with the explanation text. After the explanation text, render inline violation badges for any violations matching the `'explanation'` section (e.g., "Weak Explanation" advisory badge).
- **Learn More** - if source.url exists, render as external link (opens new tab) with source.name as label. After the link, render inline violation badges for any violations matching the `'source'` section (e.g., "Broken Source Link" blocking badge).
- **Metadata row** - difficulty badge, status badge, created date, externalId
- **Telemetry section** - encounter count, correct count, DifficultyRate component (reuse from Task 1)
- **Quality Assessment summary section** (below all content, serves as a comprehensive reference):
  - Score: large number display with color coding (0-40 red, 41-70 yellow, 71-100 green, null gray "Not scored")
  - Violations list: if violations exist, render each with:
    - Severity badge: red "Blocking" or yellow "Advisory"
    - Rule name (violation.rule formatted: "ambiguous-answers" -> "Ambiguous Answers")
    - Message text
    - Evidence text (if present, in monospace/code styling)
  - "No violations found" message if violations array is empty

**2. Wire panel into QuestionsPage.tsx** (modify existing file):
- Import QuestionDetailPanel
- Add selectedQuestionId and selectedQuestionIndex to state (if not already from Task 1)
- Render QuestionDetailPanel at bottom of QuestionsPage JSX, passing:
  - questionId={selectedQuestionId}
  - onClose={() => setSelectedQuestionId(null)}
  - onNavigate: on 'prev' -> set selectedQuestionId to questions[selectedQuestionIndex - 1].id and decrement index; on 'next' -> set to questions[selectedQuestionIndex + 1].id and increment index
  - hasPrev={selectedQuestionIndex > 0}
  - hasNext={selectedQuestionIndex < questions.length - 1}

Prev/next navigates within the CURRENT page of results (not across pages). This is the simplest correct implementation per CONTEXT.md.
  </action>
  <verify>
```
cd frontend && npx tsc --noEmit && npm run build
```
Build compiles. Verify QuestionDetailPanel.tsx exists and imports Dialog from @headlessui/react. Verify QuestionsPage.tsx renders QuestionDetailPanel. Grep for "InlineViolationBadge" in QuestionDetailPanel.tsx to confirm inline badges are implemented.
  </verify>
  <done>
Slide-over detail panel opens when clicking a question row, showing full question content (text, 4 options with correct highlighted, explanation, Learn More link) with inline violation badges annotating the relevant content sections where violations apply, PLUS a quality assessment summary section below with all violations listed with severity badges. Telemetry data (encounters, correct count, difficulty rate) displayed. Prev/next arrows navigate between questions. Panel closes on backdrop click, X button, or Escape key.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Question explorer page at /admin/questions with sortable/filterable table, search, pagination, and slide-over detail panel with inline violation badges on content AND summary violation section with telemetry display</what-built>
  <how-to-verify>
1. Start backend and frontend dev servers
2. Log in as an admin user
3. Navigate to /admin/questions
4. Verify: Table shows questions with all columns (text, collection, difficulty, quality score, encounters, correct rate, status, created)
5. Verify: Default sort is quality score ascending (lowest first)
6. Verify: Click column headers to sort (arrows change direction)
7. Verify: Use filter dropdowns (collection, difficulty, status) -- table updates, page resets to 1
8. Verify: Type in search bar -- table updates after brief delay (300ms debounce)
9. Verify: URL updates with filter/sort/page params (copy URL, paste in new tab -- same view loads)
10. Verify: Pagination controls work (prev/next, page numbers)
11. Verify: Click a question row -- slide-over panel opens from right
12. Verify: Panel shows full question text, 4 answer options (correct highlighted green), explanation, Learn More link
13. Verify: For questions WITH violations, inline badges appear next to the relevant content (e.g., "Ambiguous Answers" badge near answer options, "Weak Explanation" badge near explanation text)
14. Verify: Below all content, quality assessment summary section shows score and full violations list with severity badges
15. Verify: Violations appear BOTH as inline badges on content AND in the summary section below
16. Verify: Panel shows encounter count, correct count, and calculated difficulty rate
17. Verify: Questions with fewer than 20 encounters show "Insufficient data" for difficulty rate
18. Verify: Prev/next arrows in panel header navigate between questions
19. Verify: Panel closes on X button, Escape key, or backdrop click
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` -- production build succeeds
2. /admin/questions route renders QuestionsPage
3. Table displays all required columns from EXPL-01
4. Detail panel displays all required content from EXPL-02
5. Violations shown both inline on content AND in summary section per CONTEXT.md decision
6. Difficulty rate displays correctly per TELE-03
7. URL state persistence works for all filters and sort
8. No new npm dependencies added
</verification>

<success_criteria>
- QuestionsPage at /admin/questions shows paginated, sortable, filterable question table (EXPL-01)
- Click question opens slide-over detail panel with full content, inline violation badges on relevant content sections, quality assessment summary section, and telemetry (EXPL-02)
- Violations shown BOTH ways: inline badges on relevant content AND summary section below (CONTEXT.md decision)
- Calculated difficulty rate shows percentage or "insufficient data" threshold (TELE-03)
- Filter state persists in URL params (CONTEXT.md decision)
- All components use red admin theme consistent with existing AdminLayout
- Human verification confirms visual and functional correctness
</success_criteria>

<output>
After completion, create `.planning/phases/20-admin-exploration-ui/20-02-SUMMARY.md`
</output>
