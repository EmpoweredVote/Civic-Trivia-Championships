---
phase: 24-question-generation-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/scripts/content-generation/generate-locale-questions.ts
  - backend/src/scripts/content-generation/prompts/system-prompt.ts
autonomous: true

must_haves:
  truths:
    - "Generation script accepts --locale fremont-ca and loads Fremont config"
    - "System prompt includes Fremont-specific sensitivity instructions for Ohlone, Afghan-American, Tesla/NUMMI, and Mission San Jose"
    - "System prompt includes quality guidelines and expiration timestamp guidance"
    - "RAG sources fetched and cached for Fremont locale"
  artifacts:
    - path: "backend/src/scripts/content-generation/generate-locale-questions.ts"
      provides: "Fremont locale registration in supportedLocales map"
      contains: "fremont-ca"
    - path: "backend/src/scripts/content-generation/prompts/system-prompt.ts"
      provides: "Fremont sensitivity notes, quality guidelines, expiration rules in system prompt"
      contains: "buildSystemPrompt"
  key_links:
    - from: "generate-locale-questions.ts"
      to: "locale-configs/fremont-ca.ts"
      via: "dynamic import in loadLocaleConfig"
      pattern: "fremont-ca.*fremontConfig"
    - from: "system-prompt.ts"
      to: "quality-guidelines.ts"
      via: "import QUALITY_GUIDELINES"
      pattern: "QUALITY_GUIDELINES"
---

<objective>
Register Fremont locale in the generation pipeline and enhance the system prompt with Fremont-specific sensitivity instructions, quality guidelines, and expiration timestamp guidance. Fetch and cache RAG sources.

Purpose: The generation script currently only supports bloomington-in and los-angeles-ca. Before generating questions, we need to register the Fremont config, enhance prompts with Fremont's unique sensitivity requirements (Ohlone present-tense framing, Afghan-American cultural heritage focus, Tesla/NUMMI civic-only framing, Mission San Jose disambiguation), embed quality guidelines to maximize first-pass validation rate, and pre-fetch RAG source documents.

Output: Generation pipeline configured and ready for Fremont question generation.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-question-generation-review/24-CONTEXT.md
@.planning/phases/24-question-generation-review/24-RESEARCH.md

@backend/src/scripts/content-generation/generate-locale-questions.ts
@backend/src/scripts/content-generation/prompts/system-prompt.ts
@backend/src/scripts/content-generation/prompts/quality-guidelines.ts
@backend/src/scripts/content-generation/locale-configs/fremont-ca.ts
@backend/src/scripts/content-generation/question-schema.ts
@backend/src/scripts/content-generation/utils/quality-validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Fremont locale and enhance system prompt</name>
  <files>
    backend/src/scripts/content-generation/generate-locale-questions.ts
    backend/src/scripts/content-generation/prompts/system-prompt.ts
  </files>
  <action>
  **1. Register Fremont in generate-locale-questions.ts:**

  In the `loadLocaleConfig()` function's `supportedLocales` map, add:
  ```typescript
  'fremont-ca': () => import('./locale-configs/fremont-ca.js') as Promise<{ fremontConfig: LocaleConfig }>,
  ```

  In the `configKeys` array, add `'fremontConfig'`:
  ```typescript
  const configKeys = ['bloomingtonConfig', 'losAngelesConfig', 'fremontConfig'];
  ```

  Update the `--help` text to list `fremont-ca` as a supported locale.

  **2. Enhance buildSystemPrompt() in system-prompt.ts:**

  Add a second parameter `localeSlug?: string` to `buildSystemPrompt()`. When `localeSlug === 'fremont-ca'`, append Fremont-specific sensitivity instructions to the base prompt. Keep the function backward-compatible (localeSlug is optional, defaults to no sensitivity notes).

  Import and append `QUALITY_GUIDELINES` from `./quality-guidelines.js` to the system prompt for all locales (this was built in Phase 21 but never embedded in the system prompt — LA and Indiana generation ran without it in the prompt, relying on the validation retry loop instead. Embedding it will improve first-pass rates for Fremont).

  **Fremont sensitivity section to append (only when localeSlug is 'fremont-ca'):**

  ```
  ## Fremont-Specific Content Guidelines

  ### Ohlone / Indigenous History
  - ALWAYS use present tense: "Ohlone people have lived here for thousands of years"
  - NEVER purely past tense: "Ohlone people lived here before colonization"
  - Acknowledge ongoing presence, not just historical existence
  - Respectful framing without romanticization of mission system

  ### Afghan-American Community / Little Kabul
  - Focus on CULTURAL HERITAGE: food, traditions, cultural institutions, contributions to Fremont
  - Do NOT reduce to refugee/immigration narrative
  - Celebrate how the Afghan-American community has shaped Fremont's identity
  - No poverty tourism or tragedy framing

  ### Tesla / NUMMI
  - CIVIC ANGLES ONLY: zoning decisions, environmental review, job numbers, tax revenue, factory reuse
  - NUMMI history and Tesla acquisition are fine (economic impact on Fremont)
  - Do NOT ask about Tesla products (cars, batteries, software)
  - Do NOT ask about Elon Musk personally (wealth, views, social media)
  - Do NOT ask about corporate strategy (production targets, stock price)

  ### Mission San Jose Disambiguation
  - "Mission San Jose (historic mission)" = 1797 Spanish mission (Mission San Jose de Guadalupe)
  - "Mission San Jose district" = modern neighborhood within Fremont
  - NEVER use ambiguous "Mission San Jose" without a qualifier

  ### Five-Town Consolidation (1956)
  - When mentioning consolidation, name ALL five towns: Centerville, Niles, Irvington, Mission San Jose, Warm Springs
  - This is a core Fremont identity story — ensure accuracy

  ### Diversity and Demographics
  - Celebrate diversity through institutions, events, and cultural contributions
  - Do NOT use census-style statistics ("X% of Fremont is Y ethnicity")
  - Do NOT rank communities against each other
  - Focus on what makes Fremont unique

  ### Expiration Timestamps for Elected Officials
  - Fremont Mayor: term ends January 2027. Set expiresAt: "2027-01-01T00:00:00Z"
  - City Council Districts up in 2026: expiresAt: "2027-01-01T00:00:00Z"
  - Alameda County Supervisor District 1: expiresAt: "2027-01-01T00:00:00Z"
  - For structural questions about offices (not specific people): expiresAt: null
  - Prefer structural questions over current-official-name questions to reduce expiration churn

  ### Difficulty Distribution (Fremont-specific calibration)
  - Target: 40% easy, 40% medium, 20% hard
  - Easy: Foundational facts a civic-minded resident would know (e.g., "How many districts does Fremont have?")
  - Medium: Requires civic knowledge but learnable (e.g., "What role does the city manager play?")
  - Hard: Nuanced details even locals might not know (e.g., "Which five towns consolidated to form Fremont in 1956?")
  - Distractors should scale with difficulty — easy has obviously wrong answers, hard has genuinely tricky ones
  ```

  **3. Update the generate-locale-questions.ts to pass localeSlug to buildSystemPrompt:**

  In the `generateBatch()` function, change:
  ```typescript
  const systemPromptText = buildSystemPrompt(config.name, batchTopicDistribution);
  ```
  to:
  ```typescript
  const systemPromptText = buildSystemPrompt(config.name, batchTopicDistribution, config.locale);
  ```

  This passes the locale slug so the system prompt can include Fremont-specific sensitivity notes.
  </action>
  <verify>
  Run TypeScript compilation check:
  ```bash
  cd backend && npx tsc --noEmit
  ```

  Verify Fremont is registered:
  ```bash
  npx tsx src/scripts/content-generation/generate-locale-questions.ts --help
  ```
  Should list `fremont-ca` as a supported locale.
  </verify>
  <done>
  - `--locale fremont-ca` is accepted by the generation script
  - System prompt includes Fremont sensitivity notes when locale is fremont-ca
  - Quality guidelines embedded in system prompt for all locales
  - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fetch and cache Fremont RAG sources</name>
  <files>
    backend/src/scripts/data/sources/fremont-ca/ (created directory)
  </files>
  <action>
  Run the generation script with `--fetch-sources` flag to download and cache all 20 source URLs from the Fremont locale config:

  ```bash
  cd backend
  npx tsx src/scripts/content-generation/generate-locale-questions.ts --locale fremont-ca --fetch-sources --dry-run
  ```

  The `--dry-run` flag prevents database operations. The `--fetch-sources` flag downloads HTML from the 20 URLs in `fremont-ca.ts` sourceUrls and saves parsed text to `backend/src/scripts/data/sources/fremont-ca/`.

  **After fetching, check the results:**
  - Count how many sources were successfully fetched (target: at least 14 of 20, i.e., 70%+)
  - If fewer than 14 succeed, note which failed and why (403 errors, timeouts, etc.)
  - Check that fetched files contain meaningful content (not just navigation HTML)

  **If fetch success rate is below 70%:**
  The generation can still proceed — the AI will use whatever sources are available plus its training data. Low fetch rates are common with .gov sites. Do NOT block on this — just note the fetch rate in the output and proceed.

  Do NOT run actual question generation in this task — that happens in Plan 02.
  </action>
  <verify>
  ```bash
  ls backend/src/scripts/data/sources/fremont-ca/ | wc -l
  ```
  Should show at least 14 cached source files. Check a sample file to confirm it has meaningful content (not just HTML boilerplate).
  </verify>
  <done>
  - RAG sources fetched and cached in backend/src/scripts/data/sources/fremont-ca/
  - At least 70% of sources (14/20) successfully fetched
  - Source files contain meaningful civic content (not just navigation)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in backend directory
- `--locale fremont-ca` accepted by generation script
- System prompt contains "Ohlone", "Little Kabul", "Tesla", "Mission San Jose" sensitivity notes when locale is fremont-ca
- RAG sources cached in backend/src/scripts/data/sources/fremont-ca/
- Quality guidelines text appears in system prompt output
</verification>

<success_criteria>
- Generation pipeline fully configured for Fremont locale
- Fremont-specific sensitivity notes embedded in system prompt
- Quality guidelines embedded in system prompt for improved first-pass rate
- RAG sources pre-fetched and cached for generation
- Ready for Plan 02 (question generation)
</success_criteria>

<output>
After completion, create `.planning/phases/24-question-generation-review/24-01-SUMMARY.md`
</output>
