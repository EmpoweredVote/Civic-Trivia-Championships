---
phase: 24-question-generation-review
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - backend/src/scripts/data/reports/generation-fremont-ca-*.json
autonomous: true

must_haves:
  truths:
    - "~130 questions generated across all 8 Fremont topic categories"
    - "All generated questions validated through quality rules with retry loop"
    - "Topic distribution approximately matches targets (civic-history ~26, landmarks-culture ~23, budget-finance ~16, others ~13 each)"
    - "Difficulty distribution skews easier (roughly 40/40/20 easy/medium/hard)"
    - "Generation report saved with pass/fail stats, violation breakdown, and performance metrics"
    - "Questions seeded to database as status='draft'"
  artifacts:
    - path: "backend/src/scripts/data/reports/generation-fremont-ca-*.json"
      provides: "Generation report with quality validation stats"
    - path: "database: questions table"
      provides: "~130 draft Fremont questions linked to fremont-ca collection"
  key_links:
    - from: "generate-locale-questions.ts"
      to: "fremont-ca.ts"
      via: "loadLocaleConfig('fremont-ca')"
      pattern: "fremontConfig"
    - from: "generate-locale-questions.ts"
      to: "quality-validation.ts"
      via: "validateAndRetry with auditQuestion"
      pattern: "validateAndRetry"
    - from: "seed-questions.ts"
      to: "database"
      via: "seedQuestionBatch inserts as draft"
      pattern: "status.*draft"
---

<objective>
Generate ~130 Fremont civic trivia questions using the configured pipeline, validate each against quality rules with retry loop, and seed passing questions to database as draft.

Purpose: This is the core generation work. We overshoot the 100-question target by ~30% to provide a curation buffer for Plan 03. The generation script handles batching (4 batches of ~32), prompt caching for cost savings, Zod schema validation, and quality-rule validation with up to 3 retries per question. Questions are seeded as 'draft' status.

Output: ~130 draft questions in the database, generation report with quality stats.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-question-generation-review/24-CONTEXT.md
@.planning/phases/24-question-generation-review/24-RESEARCH.md
@.planning/phases/24-question-generation-review/24-01-SUMMARY.md

@backend/src/scripts/content-generation/generate-locale-questions.ts
@backend/src/scripts/content-generation/locale-configs/fremont-ca.ts
@backend/src/scripts/content-generation/utils/quality-validation.ts
@backend/src/scripts/content-generation/utils/seed-questions.ts
@backend/src/scripts/content-generation/question-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure generation for overshoot and integrate quality validation</name>
  <files>
    backend/src/scripts/content-generation/generate-locale-questions.ts
  </files>
  <action>
  The generation script needs two modifications for Fremont's overshoot-and-curate strategy:

  **1. Add overshoot support:**

  The current script generates exactly `config.targetQuestions` (100). For Fremont, we need to generate ~130 (30% overshoot). Add an optional `overshootFactor` field to the `LocaleConfig` type (in `bloomington-in.ts` where the type is defined) with a default of 1.0 (no overshoot). Set Fremont's config to `overshootFactor: 1.3`.

  In the main orchestrator of `generate-locale-questions.ts`, use `Math.ceil(config.targetQuestions * (config.overshootFactor ?? 1.0))` to calculate the actual generation target. This changes `totalBatches` calculation:
  ```typescript
  const actualTarget = Math.ceil(config.targetQuestions * (config.overshootFactor ?? 1.0));
  const totalBatches = Math.ceil(actualTarget / config.batchSize);
  ```

  **2. Integrate validateAndRetry into the generation pipeline:**

  Currently the script calls `generateBatch()` but does NOT run quality validation. The `validateAndRetry()` function exists but isn't wired into the generation script. Wire it in:

  After each `generateBatch()` call, run `validateAndRetry(batchQuestions, regenerateFn)` where `regenerateFn` calls the Anthropic API to regenerate a single failed question with violation feedback.

  The `regenerateFn` should:
  - Take the failed question and violation messages
  - Call Claude API with a prompt like: "This question failed quality validation: [violations]. Fix it and return a single question in the same JSON format."
  - Parse and return the fixed question
  - Use prompt caching (the source documents are already cached from the batch call)

  Only seed questions that pass validation (the `passed` array from `validateAndRetry`). Track failed questions for the generation report.

  After all batches, call `createReport()` and `saveReport()` to persist the generation report.

  **3. Add overshootFactor to Fremont config:**

  In `fremont-ca.ts`, add:
  ```typescript
  overshootFactor: 1.3, // Generate ~130, curate to ~100 in review
  ```

  **4. Update LocaleConfig type:**

  In `bloomington-in.ts` (where the LocaleConfig type is defined), add the optional field:
  ```typescript
  overshootFactor?: number; // Generate more than target, curate down later. Default 1.0
  ```
  </action>
  <verify>
  ```bash
  cd backend && npx tsc --noEmit
  ```
  TypeScript compiles without errors. The validateAndRetry import resolves correctly.
  </verify>
  <done>
  - Generation script calculates overshoot target (~130 for Fremont)
  - Quality validation retry loop integrated into generation pipeline
  - RegenerateFn wired to Claude API for fixing failed questions
  - Generation report created and saved after run
  - Fremont config has overshootFactor: 1.3
  - LocaleConfig type updated with optional overshootFactor field
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate ~130 Fremont questions with quality validation</name>
  <files>
    backend/src/scripts/data/reports/generation-fremont-ca-*.json
  </files>
  <action>
  Run the full generation pipeline for Fremont. This will:
  1. Load the Fremont locale config (8 topics, 130 target with overshoot)
  2. Load cached RAG source documents (from Plan 01 Task 2)
  3. Generate questions in batches of 25 (~6 batches for 130)
  4. Validate each question with auditQuestion() and retry failures up to 3 times
  5. Seed passing questions to database as status='draft'
  6. Save generation report

  ```bash
  cd backend
  npx tsx src/scripts/content-generation/generate-locale-questions.ts --locale fremont-ca
  ```

  **IMPORTANT: This requires ANTHROPIC_API_KEY in backend/.env.** The key should already be configured from Phase 17/21 generation runs. If the key is missing, check backend/.env.

  **Expected runtime:** 10-20 minutes (API calls + validation loop).

  **Expected cost:** ~$2-4 with prompt caching (first batch writes cache, batches 2-6 read cache at 90% discount).

  **After generation completes, verify the output:**

  1. Check total generated questions:
     ```bash
     npx tsx -e "
       import 'dotenv/config';
       import { db } from './src/db/index.js';
       import { questions, collectionQuestions, collections } from './src/db/schema.js';
       import { eq, and, sql } from 'drizzle-orm';

       const result = await db.execute(sql\`
         SELECT COUNT(*) as count FROM civic_trivia.questions q
         JOIN civic_trivia.collection_questions cq ON q.id = cq.question_id
         JOIN civic_trivia.collections c ON cq.collection_id = c.id
         WHERE c.slug = 'fremont-ca'
       \`);
       console.log('Fremont questions in database:', result.rows[0].count);
       process.exit(0);
     "
     ```

  2. Check topic distribution:
     ```bash
     npx tsx -e "
       import 'dotenv/config';
       import { db } from './src/db/index.js';
       import { sql } from 'drizzle-orm';

       const result = await db.execute(sql\`
         SELECT q.subcategory, COUNT(*) as count
         FROM civic_trivia.questions q
         JOIN civic_trivia.collection_questions cq ON q.id = cq.question_id
         JOIN civic_trivia.collections c ON cq.collection_id = c.id
         WHERE c.slug = 'fremont-ca'
         GROUP BY q.subcategory
         ORDER BY count DESC
       \`);
       for (const row of result.rows) {
         console.log(\`  \${row.subcategory}: \${row.count}\`);
       }
       process.exit(0);
     "
     ```

  3. Check difficulty distribution:
     ```bash
     npx tsx -e "
       import 'dotenv/config';
       import { db } from './src/db/index.js';
       import { sql } from 'drizzle-orm';

       const result = await db.execute(sql\`
         SELECT q.difficulty, COUNT(*) as count
         FROM civic_trivia.questions q
         JOIN civic_trivia.collection_questions cq ON q.id = cq.question_id
         JOIN civic_trivia.collections c ON cq.collection_id = c.id
         WHERE c.slug = 'fremont-ca'
         GROUP BY q.difficulty
       \`);
       for (const row of result.rows) {
         console.log(\`  \${row.difficulty}: \${row.count}\`);
       }
       process.exit(0);
     "
     ```

  4. Check generation report:
     ```bash
     ls backend/src/scripts/data/reports/generation-fremont-ca-*.json
     ```

  **If generation produces fewer than 100 questions:** This is acceptable â€” Plan 03 can generate supplemental questions for under-represented topics. Note the shortfall in the summary.

  **If API errors occur:** The script continues to next batch on error. If a batch fails, re-run that specific batch:
  ```bash
  npx tsx src/scripts/content-generation/generate-locale-questions.ts --locale fremont-ca --batch N
  ```
  </action>
  <verify>
  - Total questions in database for fremont-ca collection: at least 100 (target ~130)
  - Topic distribution covers all 8 categories (no category has 0)
  - Difficulty distribution roughly 40/40/20 (easy/medium/hard)
  - Generation report JSON exists in backend/src/scripts/data/reports/
  - All questions have status='draft'
  </verify>
  <done>
  - ~130 Fremont questions generated, validated, and seeded to database as draft
  - All 8 topic categories represented in the generated questions
  - Generation report saved with pass/fail stats and performance metrics
  - Quality validation retry loop caught and fixed (or dropped) questions with blocking violations
  </done>
</task>

</tasks>

<verification>
- At least 100 Fremont questions in the database (target ~130)
- All 8 topic categories have questions
- Difficulty distribution approximately 40% easy, 40% medium, 20% hard
- Generation report exists with validation stats
- No questions inserted with blocking violations still present
- All questions have status='draft' (not 'active')
</verification>

<success_criteria>
- ~130 quality-validated Fremont questions in database as draft status
- Topic distribution approximately matches targets from fremont-ca.ts
- Generation report documents the run (pass rate, retries, costs)
- Ready for Plan 03 (review, curation, finalization)
</success_criteria>

<output>
After completion, create `.planning/phases/24-question-generation-review/24-02-SUMMARY.md`
</output>
