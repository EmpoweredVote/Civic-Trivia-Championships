---
phase: 22-admin-question-editing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/pages/admin/components/QuestionEditForm.tsx
  - frontend/src/pages/admin/components/SortableOption.tsx
autonomous: true

must_haves:
  truths:
    - "QuestionEditForm renders controlled inputs for question text, explanation, 4 options, source URL, and difficulty"
    - "Character counters display current/max length on question text and explanation fields"
    - "Options can be reordered via drag-and-drop with visible drag handles"
    - "Correct answer radio button follows its option when reordered"
    - "Difficulty is a 1-10 range input with Easy/Medium/Hard label"
    - "Source URL input validates URL format on change"
  artifacts:
    - path: "frontend/src/pages/admin/components/QuestionEditForm.tsx"
      provides: "Edit form with controlled inputs, character counters, difficulty slider, URL validation, dirty tracking"
      min_lines: 150
    - path: "frontend/src/pages/admin/components/SortableOption.tsx"
      provides: "Draggable option row with drag handle, text input, correct answer radio"
      min_lines: 30
  key_links:
    - from: "frontend/src/pages/admin/components/QuestionEditForm.tsx"
      to: "frontend/src/pages/admin/components/SortableOption.tsx"
      via: "import SortableOption"
      pattern: "import.*SortableOption"
    - from: "frontend/src/pages/admin/components/QuestionEditForm.tsx"
      to: "@dnd-kit/core"
      via: "DndContext import"
      pattern: "import.*DndContext.*@dnd-kit/core"
---

<objective>
Create the QuestionEditForm and SortableOption components with @dnd-kit for option reordering.

Purpose: These are the new UI components for inline question editing. They are self-contained and can be built independently of the backend endpoint and the panel integration. Plan 03 will wire them into the QuestionDetailPanel.

Output: Two new React components (QuestionEditForm.tsx, SortableOption.tsx) and @dnd-kit installed as a dependency.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-admin-question-editing/22-RESEARCH.md

@frontend/src/pages/admin/components/QuestionDetailPanel.tsx
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @dnd-kit dependencies</name>
  <files>frontend/package.json</files>
  <action>
Run from the frontend directory:
```
cd frontend && npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

This installs:
- `@dnd-kit/core` — Drag-and-drop foundation (DndContext, closestCenter)
- `@dnd-kit/sortable` — Sortable list preset (SortableContext, useSortable, arrayMove, verticalListSortingStrategy)
- `@dnd-kit/utilities` — CSS utility (CSS.Transform.toString)

Verify installation succeeds and packages appear in package.json dependencies.
  </action>
  <verify>
Check that `@dnd-kit/core`, `@dnd-kit/sortable`, and `@dnd-kit/utilities` appear in frontend/package.json dependencies.
  </verify>
  <done>
@dnd-kit packages installed in frontend/package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SortableOption and QuestionEditForm components</name>
  <files>
    frontend/src/pages/admin/components/SortableOption.tsx
    frontend/src/pages/admin/components/QuestionEditForm.tsx
  </files>
  <action>
**SortableOption.tsx** — A draggable option row component:

```
Props:
  id: string           — Unique sortable ID (use a stable ID, not array index)
  label: string        — "A", "B", "C", "D" (derived from position in parent)
  text: string         — Current option text
  isCorrect: boolean   — Whether this is the correct answer
  onTextChange: (text: string) => void
  onMarkCorrect: () => void
```

Implementation:
- Use `useSortable({ id })` from `@dnd-kit/sortable`
- Apply `CSS.Transform.toString(transform)` and `transition` to the container div style
- Set `opacity: 0.5` when `isDragging` is true
- Layout: horizontal flex row containing:
  1. **Drag handle** — A button/div with `{...attributes} {...listeners}` for the drag handle. Use a 6-dot grip icon (two columns of 3 dots). Style: `cursor-grab text-gray-400 hover:text-gray-600 p-1`
  2. **Label** — `<span>` showing "A.", "B.", etc. Style: `font-semibold text-gray-700 w-6`
  3. **Text input** — `<input type="text">` with the option text. Style: `flex-1 px-3 py-2 border border-gray-300 rounded focus:border-red-500 focus:ring-1 focus:ring-red-500`. Max length 150 characters.
  4. **Correct answer radio** — `<input type="radio" name="correctAnswer">` checked={isCorrect}. Style: `w-5 h-5 text-red-600 focus:ring-red-500`. Label text "Correct" shown as `sr-only` for accessibility.
- Container: `flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg`

**QuestionEditForm.tsx** — The main edit form component:

```
Props:
  question: QuestionDetail  — The current question data (same interface from QuestionDetailPanel)
  onSave: (data: EditFormData) => Promise<void>  — Called when user clicks Save
  onCancel: () => void      — Called when user clicks Cancel
  onDirtyChange: (isDirty: boolean) => void  — Reports dirty state to parent
  isSaving: boolean         — Whether a save is in progress (disables form)
```

Define `EditFormData` interface:
```typescript
interface EditFormData {
  text: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
  sourceUrl: string;
  difficulty: number;
}
```

Define an internal `OptionItem` type to track options with stable IDs:
```typescript
interface OptionItem {
  id: string;       // Stable ID for dnd-kit (e.g., 'opt-0', 'opt-1', etc.)
  text: string;
}
```

Implementation:

1. **State initialization** — On mount (or when `question` changes), initialize:
   - `text` from question.text
   - `optionItems: OptionItem[]` — Map question.options to `[{ id: 'opt-0', text: options[0] }, ...]`
   - `correctOptionId: string` — The `id` of the option that is correct (e.g., if correctAnswer is 2, then 'opt-2')
   - `explanation` from question.explanation
   - `sourceUrl` from question.source.url or ''
   - `difficulty: number` — Map question.difficulty string to numeric: 'easy' = 3, 'medium' = 5, 'hard' = 8 (midpoints of ranges)
   - `sourceUrlError: string` — Inline URL validation error

2. **Dirty tracking** — Use useEffect to compare current form state against initial question data. Call `onDirtyChange(isDirty)` whenever dirty state changes. Compare stringified form data vs initial data.

3. **Character counters** — For question text (max 300) and explanation (max 500), show a counter below each textarea:
   - Format: `{current}/{max} characters`
   - Style: `text-sm mt-1` with color `text-gray-500` normally, `text-red-600` when > 90% of max
   - Use `maxLength` attribute on the textarea to hard-stop at the limit

4. **Question text field** — `<textarea>` with label "Question Text", rows=3, required. Show character counter below.

5. **Options section** — Wrapped in `<DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>` and `<SortableContext items={optionItems.map(o => o.id)} strategy={verticalListSortingStrategy}>`.
   - Render 4 `<SortableOption>` components, one per optionItem
   - The `label` prop is derived from the option's current array position: `String.fromCharCode(65 + index)` (A, B, C, D)
   - `isCorrect` is `optionItem.id === correctOptionId`
   - `onMarkCorrect` sets `correctOptionId` to the clicked option's id
   - `onTextChange` updates the text of the specific optionItem
   - **handleDragEnd**: On drag end, use `arrayMove` to reorder `optionItems`. The `correctOptionId` does NOT need to change because we track by stable ID, not index. The correct answer follows its option automatically.

6. **Explanation field** — `<textarea>` with label "Explanation", rows=4, required. Show character counter below. Hint text: "Supports basic markdown (bold, italic, links)"

7. **Source URL field** — `<input type="url">` with label "Source URL". On blur or change, validate URL format using `try { new URL(value) } catch { setSourceUrlError('Invalid URL format') }`. Show inline error message in red below the input when invalid.

8. **Difficulty field** — `<input type="range" min={1} max={10}>` with label "Difficulty" and current value displayed. Also show a text label based on value: 1-3 = "Easy", 4-7 = "Medium", 8-10 = "Hard" with matching color badge (green/yellow/red). Format: slider on one line, "{value}/10 — {label}" below.

9. **Form submission** — The `onSave` callback receives the form data. Map `correctOptionId` back to numeric index: find the index of the option with that id in the current `optionItems` array. Map `optionItems` back to string array. The parent (Plan 03) will handle the actual API call.

10. **Disable all inputs** when `isSaving` is true. Show subtle opacity reduction on the form.

Do NOT add useBlocker or beforeunload handling in this component — the parent QuestionDetailPanel will handle unsaved changes warnings (Plan 03).

Export both `QuestionEditForm` and the `EditFormData` interface.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify TypeScript compilation succeeds.

Verify both files exist and contain the expected components:
- SortableOption.tsx exports SortableOption component with useSortable hook
- QuestionEditForm.tsx exports QuestionEditForm component with DndContext, state management, and character counters
  </verify>
  <done>
SortableOption.tsx renders a draggable option row with drag handle, text input, and correct answer radio. QuestionEditForm.tsx renders a complete edit form with controlled inputs for all question fields, drag-and-drop option reordering, character counters on text/explanation, URL validation on source, numeric difficulty slider, and dirty state tracking. Both compile cleanly.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities in frontend/package.json
- SortableOption.tsx uses useSortable hook and renders drag handle + text input + radio
- QuestionEditForm.tsx uses DndContext + SortableContext wrapping 4 SortableOption components
- Character counters show "{current}/{max} characters" for text (300) and explanation (500) fields
- Difficulty slider shows 1-10 range with Easy/Medium/Hard label
- Correct answer tracks by stable option ID, not index (survives drag reorder)
- Form exports EditFormData type for use by Plan 03
</verification>

<success_criteria>
Two new components exist that provide the complete edit form UI, ready to be integrated into the QuestionDetailPanel by Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/22-admin-question-editing/22-02-SUMMARY.md`
</output>
