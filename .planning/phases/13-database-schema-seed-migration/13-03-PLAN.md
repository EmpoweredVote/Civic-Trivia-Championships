---
phase: 13-database-schema-seed-migration
plan: 03
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - backend/src/db/seed/seed.ts
  - backend/src/db/seed/collections.ts
  - backend/src/db/seed/topics.ts
  - backend/src/db/seed/questions.ts
  - backend/src/db/index.ts
autonomous: true

must_haves:
  truths:
    - "All 120 existing federal questions are in the database with full content"
    - "A Federal Civics collection exists with name, slug, description, and locale metadata"
    - "Bloomington IN and Los Angeles CA collections exist as inactive"
    - "All 7 Federal topics exist in topics table and are linked to Federal collection"
    - "Each question is linked to the Federal collection via collection_questions"
    - "Questions reference topics by ID, not by string"
    - "Learning content JSONB contains only paragraphs and corrections (source is a separate column)"
  artifacts:
    - path: "backend/src/db/seed/seed.ts"
      provides: "Main seed orchestrator"
      contains: "seedCollections|seedTopics|seedQuestions"
    - path: "backend/src/db/seed/collections.ts"
      provides: "Collection seed data for Federal, Bloomington, LA"
      contains: "federal|bloomington-in|los-angeles-ca"
    - path: "backend/src/db/seed/topics.ts"
      provides: "Topic seed data for Federal's 7 topics + 9 subcategories"
      contains: "Constitution|Amendments|Branches of Government"
    - path: "backend/src/db/seed/questions.ts"
      provides: "Question migration logic from JSON to database format"
      contains: "questions\\.json|sources\\.json"
    - path: "backend/src/db/index.ts"
      provides: "Drizzle database instance using existing pg Pool"
      contains: "drizzle.*pool"
  key_links:
    - from: "backend/src/db/seed/seed.ts"
      to: "backend/src/db/schema.ts"
      via: "imports table definitions"
      pattern: "import.*schema"
    - from: "backend/src/db/seed/questions.ts"
      to: "backend/src/data/questions.json"
      via: "reads JSON question data"
      pattern: "questions\\.json"
    - from: "backend/src/db/seed/questions.ts"
      to: "backend/src/db/seed/sources.json"
      via: "reads source mapping"
      pattern: "sources\\.json"
    - from: "backend/src/db/index.ts"
      to: "backend/src/config/database.ts"
      via: "wraps existing pg Pool with Drizzle"
      pattern: "import.*pool.*database"
---

<objective>
Seed the database with collections, topics, and all 120 migrated questions.

Purpose: This populates the schema created in Plan 01 with the actual data — 3 collections (Federal active, Bloomington/LA inactive), Federal topics, and all 120 questions migrated from JSON with their learning content and sources. After this plan, the database is the single source of truth for question data.

Output: Seed scripts that can be run idempotently, plus a Drizzle database instance that wraps the existing pg Pool for use by seed scripts and future query code.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-database-schema-seed-migration/13-CONTEXT.md
@.planning/phases/13-database-schema-seed-migration/13-RESEARCH.md
@.planning/phases/13-database-schema-seed-migration/13-01-SUMMARY.md
@.planning/phases/13-database-schema-seed-migration/13-02-SUMMARY.md
@backend/src/db/schema.ts
@backend/src/db/seed/sources.json
@backend/src/data/questions.json
@backend/src/config/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drizzle database instance and seed data modules</name>
  <files>
    backend/src/db/index.ts
    backend/src/db/seed/collections.ts
    backend/src/db/seed/topics.ts
  </files>
  <action>
**Create `backend/src/db/index.ts`** — Drizzle database instance that wraps the existing pg Pool:
```typescript
import { drizzle } from 'drizzle-orm/node-postgres';
import { pool } from '../config/database.js';
import * as schema from './schema.js';

export const db = drizzle(pool, { schema });
```

This reuses the existing Pool connection (with SSL config and search_path) — do NOT create a new connection.

**Create `backend/src/db/seed/collections.ts`** — Export an array of 3 collection seed objects:

1. **Federal Civics** (active):
   - name: "Federal Civics"
   - slug: "federal"
   - description: "Test your knowledge of U.S. federal government, the Constitution, and how democracy works at the national level."
   - localeCode: "en-US"
   - localeName: "United States"
   - iconIdentifier: "flag-us"
   - themeColor: "#1E3A8A" (deep blue)
   - isActive: true
   - sortOrder: 1

2. **Bloomington, IN Civics** (inactive):
   - name: "Bloomington, IN Civics"
   - slug: "bloomington-in"
   - description: "Explore Bloomington city government, Indiana state civics, and what makes local democracy work in Monroe County."
   - localeCode: "en-US"
   - localeName: "Bloomington, Indiana"
   - iconIdentifier: "flag-in"
   - themeColor: "#991B1B" (deep red — Indiana)
   - isActive: false
   - sortOrder: 2

3. **Los Angeles, CA Civics** (inactive):
   - name: "Los Angeles, CA Civics"
   - slug: "los-angeles-ca"
   - description: "Discover how Los Angeles city government works, California state civics, and the issues shaping the nation's second-largest city."
   - localeCode: "en-US"
   - localeName: "Los Angeles, California"
   - iconIdentifier: "flag-ca"
   - themeColor: "#0369A1" (ocean blue — California)
   - isActive: false
   - sortOrder: 3

**Create `backend/src/db/seed/topics.ts`** — Export an array of topic seed objects. These are the Federal collection's topics:

Primary topics (the 7 `topic` values from questions.json):
1. name: "Constitution", slug: "constitution", description: "The U.S. Constitution and its foundational principles"
2. name: "Amendments", slug: "amendments", description: "Constitutional amendments and the Bill of Rights"
3. name: "Branches of Government", slug: "branches-of-government", description: "The three branches of federal government"
4. name: "Elections", slug: "elections", description: "Voting, elections, and the electoral process"
5. name: "Civic Participation", slug: "civic-participation", description: "How citizens engage with government"
6. name: "Supreme Court", slug: "supreme-court", description: "The Supreme Court and landmark decisions"
7. name: "U.S. History", slug: "us-history", description: "Historical events that shaped American government"

Subcategory topics (the 9 `topicCategory` values — stored as separate topic records):
8. name: "Bill of Rights", slug: "bill-of-rights", description: "The first ten amendments"
9. name: "Federalism", slug: "federalism", description: "Division of power between federal and state governments"
10. name: "Voting", slug: "voting", description: "Voting rights and voter participation"
11. name: "Congress", slug: "congress", description: "The legislative branch — House and Senate"
12. name: "Judiciary", slug: "judiciary", description: "The federal court system"
13. name: "Civic Participation (subcategory)", slug: "civic-participation-sub", description: "Forms of civic engagement beyond voting"
14. name: "Executive", slug: "executive", description: "The presidency and executive branch agencies"
15. name: "Elections (subcategory)", slug: "elections-sub", description: "Election processes and campaigns"

Note: Two topicCategory values overlap with topic names (civic-participation and elections). Use distinct slugs for the subcategory versions to avoid conflicts (civic-participation-sub, elections-sub).

Also export a mapping from the original JSON topic string to slug, and from topicCategory string to slug, so the question migration can look up topic IDs.
  </action>
  <verify>
Run `cd backend && npx tsc --noEmit` — all new files compile without errors.
Check that collections.ts exports 3 collection objects and topics.ts exports 15 topic objects plus lookup mappings.
  </verify>
  <done>
- db/index.ts creates Drizzle instance wrapping existing pg Pool
- collections.ts exports 3 collection seed objects (Federal active, Bloomington/LA inactive)
- topics.ts exports 15 topic objects (7 primary + 8 subcategory) with slug mappings
- All files compile without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create question migration module and run seed</name>
  <files>
    backend/src/db/seed/questions.ts
    backend/src/db/seed/seed.ts
  </files>
  <action>
**Create `backend/src/db/seed/questions.ts`** — Module that transforms JSON questions to database format:

1. Read `backend/src/data/questions.json` (the 120 questions)
2. Read `backend/src/db/seed/sources.json` (the 120 source mappings from Plan 02)
3. For each question, transform to database insert format:
   - externalId: question.id (e.g., "q001")
   - text: question.text
   - options: question.options (as JSONB array)
   - correctAnswer: question.correctAnswer
   - explanation: question.explanation
   - difficulty: question.difficulty
   - topicId: look up from topics table by matching question.topic string to topic slug (use the mapping from topics.ts)
   - subcategory: question.topicCategory or null
   - source: Get from sources.json by question ID. For the 33 questions that already have learningContent.source, verify the sources.json value matches. Format: `{ name: string, url: string }`
   - learningContent: If question.learningContent exists, extract ONLY `paragraphs` and `corrections` fields (NOT source or topic — those are promoted to their own columns). If no learningContent, set to null.
   - expiresAt: null (no questions expire yet)

Export a function `getQuestionInserts(topicIdMap: Record<string, number>)` that takes a mapping of topic slugs to database IDs and returns the array of question insert objects.

**Create `backend/src/db/seed/seed.ts`** — Main seed orchestrator:

1. Import db instance, schema tables, and seed data modules
2. Run everything in a transaction:

```
BEGIN TRANSACTION

a) Insert collections (ON CONFLICT DO NOTHING on slug)
   -> Capture returned IDs

b) Insert topics (ON CONFLICT DO NOTHING on slug)
   -> Capture returned IDs
   -> Build topicSlug -> id mapping

c) Insert collection_topics for Federal collection
   -> Link all 15 topics to the Federal collection
   -> ON CONFLICT DO NOTHING

d) Transform questions using topicIdMap
   -> Insert all 120 questions (ON CONFLICT DO NOTHING on external_id)
   -> Capture returned IDs

e) Insert collection_questions
   -> Link all 120 questions to the Federal collection
   -> ON CONFLICT DO NOTHING

f) Run ANALYZE on all 5 tables

COMMIT
```

3. Print summary: "Seeded X collections, Y topics, Z questions, W collection-question links"
4. Handle errors: ROLLBACK on any failure, print error, exit with code 1
5. Close db connection / end pool after completion

Make the seed idempotent — safe to run multiple times due to ON CONFLICT DO NOTHING.

Run the seed:
```bash
cd backend && npx tsx src/db/seed/seed.ts
```

After seed completes, verify data by querying counts:
```sql
SELECT 'collections' as tbl, count(*) FROM civic_trivia.collections
UNION ALL SELECT 'topics', count(*) FROM civic_trivia.topics
UNION ALL SELECT 'collection_topics', count(*) FROM civic_trivia.collection_topics
UNION ALL SELECT 'questions', count(*) FROM civic_trivia.questions
UNION ALL SELECT 'collection_questions', count(*) FROM civic_trivia.collection_questions;
```

Expected: 3 collections, 15 topics, 15 collection_topics, 120 questions, 120 collection_questions.
  </action>
  <verify>
Run the count query above and confirm:
- collections: 3
- topics: 15 (7 primary + 8 subcategory, noting civic-participation-sub has a deduplicated slug)
- collection_topics: 15 (all topics linked to Federal)
- questions: 120
- collection_questions: 120

Spot-check a question with learning content:
```sql
SELECT external_id, text, source, learning_content IS NOT NULL as has_lc
FROM civic_trivia.questions WHERE external_id = 'q001';
```
Expected: q001 shows source as JSONB with name/url, has_lc = true.

Spot-check a question without learning content:
```sql
SELECT external_id, text, source, learning_content IS NOT NULL as has_lc
FROM civic_trivia.questions WHERE external_id = 'q008';
```
Expected: q008 shows source as JSONB with name/url, has_lc = false.

Verify Federal collection is active and others are not:
```sql
SELECT name, slug, is_active FROM civic_trivia.collections ORDER BY sort_order;
```
Expected: Federal (active), Bloomington (inactive), LA (inactive).

Run seed again to confirm idempotency — should complete without errors and insert 0 new rows.
  </verify>
  <done>
- 3 collections seeded (Federal active, Bloomington/LA inactive)
- 15 topics seeded and linked to Federal collection
- 120 questions migrated with correct topic references, sources, and learning content
- All 120 questions linked to Federal collection via collection_questions
- ANALYZE run on all tables
- Seed script is idempotent (safe to re-run)
- Database is the single source of truth for question data
  </done>
</task>

</tasks>

<verification>
1. `SELECT count(*) FROM civic_trivia.collections` = 3
2. `SELECT count(*) FROM civic_trivia.topics` = 15
3. `SELECT count(*) FROM civic_trivia.collection_topics` = 15
4. `SELECT count(*) FROM civic_trivia.questions` = 120
5. `SELECT count(*) FROM civic_trivia.collection_questions` = 120
6. `SELECT count(*) FROM civic_trivia.questions WHERE source IS NULL` = 0 (all have sources)
7. `SELECT count(*) FROM civic_trivia.questions WHERE learning_content IS NOT NULL` = 33
8. Federal collection is active; Bloomington and LA are inactive
9. Running seed again produces no errors and no duplicate rows
</verification>

<success_criteria>
- All 120 federal questions live in PostgreSQL with full content (options, explanations, learning content, sources)
- Federal Civics collection exists with correct metadata
- Bloomington IN and Los Angeles CA collections exist as inactive placeholders
- Topics table contains Federal's 7 primary + 8 subcategory topics, all linked to Federal collection
- Each question references a topic by ID (not string)
- Source column is populated for ALL 120 questions (NOT NULL constraint satisfied)
- Seed script is idempotent and transactional
</success_criteria>

<output>
After completion, create `.planning/phases/13-database-schema-seed-migration/13-03-SUMMARY.md`
</output>
