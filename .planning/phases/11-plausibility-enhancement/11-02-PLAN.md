---
phase: 11-plausibility-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - backend/src/routes/game.ts
  - backend/src/services/sessionService.ts
  - frontend/src/services/gameService.ts
autonomous: true

must_haves:
  truths:
    - "Client never receives the flagged field in any API response"
    - "Flagged answers look identical to normal answers on results screen"
    - "Frontend TypeScript types do not reference flagged"
    - "Results endpoint strips flagged from individual answer records"
    - "Answer endpoint strips flagged from response"
  artifacts:
    - path: "backend/src/routes/game.ts"
      provides: "Response stripping for /answer and /results endpoints"
      contains: "flagged"
    - path: "frontend/src/services/gameService.ts"
      provides: "Clean frontend types without flagged field"
  key_links:
    - from: "backend/src/routes/game.ts POST /answer"
      to: "client response"
      via: "Object destructuring to strip flagged"
      pattern: "const.*flagged.*\\.\\.\\..*=.*answer"
    - from: "backend/src/routes/game.ts GET /results"
      to: "client response"
      via: "Map answers to strip flagged from each"
      pattern: "answers\\.map|flagged.*\\.\\.\\..*clientAnswer"
---

<objective>
Strip the `flagged` field from all API responses to the client and clean up frontend types, ensuring the plausibility system is fully invisible to players.

Purpose: The plausibility system must be completely silent — players see lower scores but never know why. Leaking `flagged` to the client would allow cheaters to detect and evade the system.

Output: Clean API responses with no flagged field, clean frontend types.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-plausibility-enhancement/11-CONTEXT.md
@.planning/phases/11-plausibility-enhancement/11-01-SUMMARY.md
@backend/src/routes/game.ts
@backend/src/services/sessionService.ts
@frontend/src/services/gameService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip flagged from API responses and results endpoint</name>
  <files>
    backend/src/routes/game.ts
    backend/src/services/sessionService.ts
  </files>
  <action>
1. In `backend/src/routes/game.ts` POST `/answer` endpoint:
   - Currently line 138 sends `flagged: answer.flagged` directly to client — REMOVE this
   - Use object destructuring: `const { flagged, ...clientAnswer } = answer;`
   - Build response from clientAnswer fields (basePoints, speedBonus, totalPoints, correctAnswer, wager)
   - The `correct` field computation stays the same
   - Do NOT include `flagged` in the response object at all

2. In `backend/src/routes/game.ts` GET `/results/:sessionId` endpoint:
   - Currently returns `results.answers` which includes `flagged` on each ServerAnswer
   - Before returning, map answers to strip flagged: `results.answers.map(({ flagged, ...rest }) => rest)`
   - Assign stripped answers back: create a clean results object with stripped answers
   - All other results fields (totalScore, totalBasePoints, etc.) pass through unchanged

3. In `backend/src/services/sessionService.ts` `getResults()` method:
   - The `GameSessionResult` interface has `answers: ServerAnswer[]` which includes flagged
   - Create a new type or inline type for client-facing answers that omits flagged:
     `Omit<ServerAnswer, 'flagged'>[]`
   - OR: leave the interface as-is (ServerAnswer internally) and let the route handle stripping
   - PREFERRED approach: Leave getResults() returning ServerAnswer[] (useful for server-side analytics/logging), and let the route strip flagged before sending to client. This keeps the internal API rich and the external API clean.
  </action>
  <verify>
    - `npx tsc --noEmit` in backend directory passes
    - Start server, create session, submit answer — response JSON does NOT contain "flagged" key
    - Submit 10 answers, fetch results — individual answer objects in response do NOT contain "flagged" key
    - Verify with: `curl -s POST /api/game/answer ... | grep flagged` returns nothing
  </verify>
  <done>
    - POST /answer response has no flagged field
    - GET /results/:sessionId answer records have no flagged field
    - Server-side ServerAnswer still tracks flagged internally
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove flagged from frontend types</name>
  <files>
    frontend/src/services/gameService.ts
  </files>
  <action>
1. In `frontend/src/services/gameService.ts`:
   - Remove `flagged: boolean` from the submitAnswer return type (line 46 and line 73)
   - The response type should be: `{ basePoints: number; speedBonus: number; totalPoints: number; correct: boolean; correctAnswer: number; wager?: number }`
   - No other frontend files reference `flagged` (already verified via grep)

2. Verify no other frontend files reference `flagged`:
   - Search frontend/src for any remaining "flagged" references
   - If found, remove them (they would be dead code since server no longer sends it)
  </action>
  <verify>
    - `npx tsc --noEmit` in frontend directory passes (or `npm run build` in frontend)
    - Grep for "flagged" in frontend/src returns zero results
    - Frontend builds successfully
  </verify>
  <done>
    - Frontend TypeScript types have no flagged field
    - Frontend compiles cleanly
    - No dead references to flagged anywhere in frontend code
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Backend compiles: `cd backend && npx tsc --noEmit`
2. Frontend compiles: `cd frontend && npx tsc --noEmit` (or `npm run build`)
3. Full integration test:
   - Start backend server
   - Create session (POST /api/game/session)
   - Submit 10 answers (POST /api/game/answer) — no "flagged" in any response
   - Fetch results (GET /api/game/results/:sessionId) — no "flagged" in answer records
   - Server console shows plausibility warnings for suspicious answers (server-side logging intact)
4. Grep entire codebase for client-facing "flagged" — only appears in:
   - backend/src/services/sessionService.ts (ServerAnswer interface — server-internal)
   - backend/src/config/plausibilityThresholds.ts (config)
   - NOT in any route response, NOT in frontend code
</verification>

<success_criteria>
- Zero instances of "flagged" in any API response to client
- Frontend has no flagged type references
- Server-side flagged tracking still works (console.warn, internal ServerAnswer)
- Both frontend and backend compile cleanly
- Flagged answers visually identical to normal answers from player perspective
</success_criteria>

<output>
After completion, create `.planning/phases/11-plausibility-enhancement/11-02-SUMMARY.md`
</output>
