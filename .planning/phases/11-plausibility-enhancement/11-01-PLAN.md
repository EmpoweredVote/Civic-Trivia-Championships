---
phase: 11-plausibility-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/config/plausibilityThresholds.ts
  - backend/src/services/sessionService.ts
  - backend/src/services/scoreService.ts
autonomous: true

must_haves:
  truths:
    - "Suspiciously fast wrong answers receive no speed bonus after 3 flags in a game"
    - "Fast correct answers are never penalized regardless of speed"
    - "Anonymous players are never affected by the plausibility system"
    - "The final question is never affected by speed penalties"
    - "Accessibility users with extended time are not falsely flagged"
    - "Each game judges plausibility independently (no cross-game memory)"
    - "Penalized answers look identical to normal low-scoring answers from the player's perspective"
  artifacts:
    - path: "backend/src/config/plausibilityThresholds.ts"
      provides: "Difficulty-adjusted threshold config with as const"
      contains: "PLAUSIBILITY_THRESHOLDS"
      exports: ["PLAUSIBILITY_THRESHOLDS", "PlausibilityDifficulty"]
    - path: "backend/src/services/sessionService.ts"
      provides: "Enhanced plausibility detection with pattern counting"
      contains: "plausibilityFlags"
    - path: "backend/src/services/scoreService.ts"
      provides: "Penalty-aware speed bonus calculation"
      exports: ["calculateSpeedBonus", "calculateScore", "calculateResponseTime"]
  key_links:
    - from: "backend/src/services/sessionService.ts"
      to: "backend/src/config/plausibilityThresholds.ts"
      via: "import PLAUSIBILITY_THRESHOLDS"
      pattern: "import.*PLAUSIBILITY_THRESHOLDS.*plausibilityThresholds"
    - from: "backend/src/services/sessionService.ts"
      to: "backend/src/models/User.ts"
      via: "User.findById for timerMultiplier lookup"
      pattern: "User\\.findById"
    - from: "backend/src/services/sessionService.ts"
      to: "backend/src/services/scoreService.ts"
      via: "calculateScore with flagged+penaltyActive params"
      pattern: "calculateScore.*flagged|penaltyActive"
---

<objective>
Implement the core plausibility detection and penalty system: difficulty-adjusted timing thresholds, session-scoped pattern counting, timer multiplier adjustment, and penalty-aware scoring.

Purpose: Upgrade passive flag-only plausibility detection to an active system that detects suspicious answer patterns and zeroes speed bonuses after 3+ flags, while respecting accessibility settings and avoiding false positives on correct answers.

Output: Threshold config file, enhanced sessionService with pattern detection, penalty-aware scoreService.

NOTE - ROADMAP DEVIATION (user-approved): ROADMAP.md PLAUS-02 says "30% point reduction" but the user decided on "zero speed bonus" penalty instead. This is intentionally cleaner: suspicious speed = no speed reward. After this plan completes, update ROADMAP.md Phase 11 Success Criteria item 2 from "Flagged answers receive 30% point reduction" to "Flagged answers receive zero speed bonus (not just passive logging)" to reflect this locked decision.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-plausibility-enhancement/11-CONTEXT.md
@.planning/phases/11-plausibility-enhancement/11-RESEARCH.md
@backend/src/services/sessionService.ts
@backend/src/services/scoreService.ts
@backend/src/models/User.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plausibility threshold config and update GameSession interface</name>
  <files>
    backend/src/config/plausibilityThresholds.ts
    backend/src/services/sessionService.ts
  </files>
  <action>
1. Create `backend/src/config/plausibilityThresholds.ts` with:
   - `PLAUSIBILITY_THRESHOLDS` object using `as const` assertion
   - Difficulty thresholds: easy: 1.0, medium: 0.75, hard: 0.5 (seconds)
   - patternThreshold: 3 (number of flags before penalties apply)
   - Export `PlausibilityDifficulty` type: `keyof Omit<typeof PLAUSIBILITY_THRESHOLDS, 'patternThreshold'>`
   - Export a `getAdjustedThreshold(difficulty, timerMultiplier)` function that returns `baseThreshold * timerMultiplier`
   - Include JSDoc explaining the threshold rationale (cognitive processing times for 4-option MCQ)

2. In `backend/src/services/sessionService.ts`:
   - Add `plausibilityFlags: number` to the `GameSession` interface
   - Initialize `plausibilityFlags: 0` in `createSession()`
   - Update `QUESTION_DURATION` from 25 to 20 (Phase 10 changed frontend timer to 20s — backend must match for accurate responseTime calculation. VERIFIED: frontend/src/features/game/components/GameScreen.tsx line 25 already has `const QUESTION_DURATION = 20`)
   - Update `MAX_PLAUSIBLE_TIME_REMAINING` from 25 to 20 (same reason — must match frontend QUESTION_DURATION)
   - Remove the `MIN_PLAUSIBLE_RESPONSE_TIME` constant (replaced by difficulty-adjusted thresholds)
  </action>
  <verify>
    - `npx tsc --noEmit` in backend directory passes with no type errors
    - Verify frontend/backend duration sync: `grep -n "QUESTION_DURATION" frontend/src/features/game/components/GameScreen.tsx backend/src/services/sessionService.ts` — both must show 20
    - plausibilityThresholds.ts exports PLAUSIBILITY_THRESHOLDS and getAdjustedThreshold
    - GameSession interface has plausibilityFlags field
    - QUESTION_DURATION is 20, MAX_PLAUSIBLE_TIME_REMAINING is 20
    - MIN_PLAUSIBLE_RESPONSE_TIME constant is removed
  </verify>
  <done>
    - Config file exists with immutable thresholds (as const)
    - GameSession tracks plausibilityFlags per session
    - Duration constants match frontend (20s questions, 50s final) — explicitly verified by grep
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite plausibility detection and penalty-aware scoring</name>
  <files>
    backend/src/services/sessionService.ts
    backend/src/services/scoreService.ts
  </files>
  <action>
1. In `backend/src/services/scoreService.ts`:
   - Add new `calculateScoreWithPenalty(isCorrect, timeRemaining, flagged, penaltyActive)` function
   - When `flagged && penaltyActive`: return { basePoints: isCorrect ? 100 : 0, speedBonus: 0, totalPoints: isCorrect ? 100 : 0 }
   - When NOT penalized: use existing calculateScore logic (base + speed bonus)
   - Keep existing `calculateScore` function unchanged for backward compatibility
   - Keep existing `calculateSpeedBonus` and `calculateResponseTime` unchanged

2. In `backend/src/services/sessionService.ts` `submitAnswer()` method, rewrite the plausibility check block:
   - Import `PLAUSIBILITY_THRESHOLDS`, `getAdjustedThreshold` from config
   - Import `User` from models (for timerMultiplier lookup)
   - Import `calculateScoreWithPenalty` from scoreService

   DETECTION LOGIC (replace the existing flagged/plausibility block):

   CRITICAL DESIGN NOTE: The `flagged` field can ONLY ever be `true` for wrong answers.
   This is because the detection logic checks `isCorrect` first and skips flagging entirely
   for correct answers (step d below). Therefore, the penalty logic in calculateScoreWithPenalty
   inherently never applies to correct answers — there is no separate "exclude correct answers
   from penalty" check needed. Add a code comment explaining this invariant:
   // INVARIANT: flagged=true implies isCorrect=false (detection skips correct answers)
   // This means penalties inherently only apply to wrong answers — by design, not by filter.

   a. Skip plausibility entirely if `isFinalQuestion` (Q10 exempt)
   b. Skip plausibility entirely if `session.userId === 'anonymous'` (anonymous exempt)
   c. Calculate `isCorrect` FIRST: `selectedOption === question.correctAnswer`
   d. Skip flagging if `isCorrect` (fast correct answers are legitimate knowledge — this ensures flagged=true can ONLY happen for wrong answers)
   e. If NOT correct and NOT exempt:
      - Fetch timerMultiplier: `const user = await User.findById(session.userId as number)` and get `user?.timerMultiplier ?? 1.0`
      - Get adjusted threshold: `getAdjustedThreshold(question.difficulty as PlausibilityDifficulty, timerMultiplier)`
      - If `responseTime < threshold`: set `flagged = true`, increment `session.plausibilityFlags += 1`, console.warn with message including: sessionId, questionIndex, difficulty, timerMultiplier, threshold, responseTime
   f. Keep the existing `timeRemaining > maxPlausibleTime` check as a separate sanity validation (this catches clock manipulation, orthogonal to difficulty-based detection)

   PENALTY APPLICATION:
   - After detection, calculate `penaltyActive = session.plausibilityFlags >= PLAUSIBILITY_THRESHOLDS.patternThreshold`
   - For normal questions (not final): use `calculateScoreWithPenalty(isCorrect, timeRemaining, flagged, penaltyActive)` instead of `calculateScore(isCorrect, timeRemaining)`
   - For final question: keep existing wager scoring logic unchanged (no plausibility involvement)

   IMPORTANT ordering:
   - Calculate responseTime FIRST
   - Then check isCorrect
   - Then run plausibility detection (needs isCorrect)
   - Then calculate penaltyActive (needs updated plausibilityFlags)
   - Then calculate score (needs flagged + penaltyActive)

   IMPORTANT edge cases:
   - `question.difficulty` is typed as `string` in the Question interface. Cast to PlausibilityDifficulty when passing to getAdjustedThreshold. Add a runtime guard: if difficulty is not in ['easy', 'medium', 'hard'], fall back to 'hard' threshold (strictest).
   - The `flagged` field in ServerAnswer should still be set even when anonymous or Q10 — just always `false` for those cases.

3. After implementation, update ROADMAP.md Phase 11 Success Criteria item 2:
   - Change "Flagged answers receive 30% point reduction (not just passive logging)" to "Flagged answers receive zero speed bonus (not just passive logging)"
   - This reflects the user-approved deviation from PLAUS-02's original "30% reduction" wording
  </action>
  <verify>
    - `npx tsc --noEmit` in backend directory passes
    - Start dev server (`npm run dev` in backend) — server starts without errors
    - Test with curl — create an authenticated session and submit answers:
      1. `curl -s -X POST http://localhost:3001/api/game/session -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" | jq .sessionId` — capture sessionId
      2. Submit a normal-speed answer (timeRemaining ~15): `curl -s -X POST http://localhost:3001/api/game/answer -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"sessionId":"$SID","selectedOption":0,"timeRemaining":15}' | jq .` — verify response includes basePoints and speedBonus fields
      3. Submit a suspiciously fast wrong answer (timeRemaining ~19.5, meaning <0.5s response time): `curl -s -X POST http://localhost:3001/api/game/answer -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"sessionId":"$SID","selectedOption":3,"timeRemaining":19.5}' | jq .` — verify response succeeds
      4. Check server console output for `console.warn` message containing "plausibility" and the threshold details (difficulty, multiplier, threshold value, responseTime)
    - Verify NO console.warn appears when a fast answer happens to be correct (submit with correct option at high timeRemaining)
    - Verify ROADMAP.md Phase 11 Success Criteria item 2 updated to say "zero speed bonus"
    - Verify code comment exists: grep for "INVARIANT: flagged=true implies isCorrect=false" in sessionService.ts
  </verify>
  <done>
    - Plausibility detection uses difficulty-adjusted thresholds (easy 1.0s, medium 0.75s, hard 0.5s)
    - Only fast WRONG answers are flagged (code comment documents the flagged=true => isCorrect=false invariant)
    - Anonymous users are never flagged
    - Q10 is never checked for plausibility
    - Timer multiplier users get proportionally scaled thresholds
    - plausibilityFlags increments per flag in session
    - Speed bonus zeroed only when flagged AND 3+ total flags in session
    - Forward-only: first 2 flags get normal scoring, penalties from 3rd flag onward
    - console.warn fires with diagnostic details for each flagged answer
    - ROADMAP.md updated to reflect user-approved "zero speed bonus" deviation from original "30% reduction"
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. TypeScript compiles cleanly: `cd backend && npx tsc --noEmit`
2. Frontend/backend duration sync: `grep "QUESTION_DURATION" frontend/src/features/game/components/GameScreen.tsx backend/src/services/sessionService.ts` — both show 20
3. Server starts: `cd backend && npm run dev` (no runtime errors)
4. Manual test flow:
   - Create session via POST /api/game/session
   - Submit answers via POST /api/game/answer
   - Verify normal scoring for legitimate answers
   - Verify console.warn appears for suspiciously fast wrong answers (server logs)
   - Verify NO console.warn for fast correct answers
   - Verify penalty logic: first 2 flags don't affect scoring, 3rd+ zeroes speed bonus
5. Code invariant documented: grep for "INVARIANT: flagged=true implies isCorrect=false" confirms comment exists
6. ROADMAP.md deviation documented: Phase 11 success criteria says "zero speed bonus" not "30% reduction"
</verification>

<success_criteria>
- Plausibility thresholds are difficulty-adjusted and configurable via single config file
- Detection skips anonymous users, Q10, and correct answers
- Timer multiplier scales thresholds proportionally
- Pattern counting requires 3+ flags before penalties activate
- Penalty zeroes speed bonus (forward-only, no retroactive) — user-approved deviation from PLAUS-02 "30% reduction"
- All TypeScript types are correct, server compiles and runs
- Backend QUESTION_DURATION matches frontend (both 20s), explicitly verified
- ROADMAP.md updated to reflect actual penalty behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-plausibility-enhancement/11-01-SUMMARY.md`
</output>
