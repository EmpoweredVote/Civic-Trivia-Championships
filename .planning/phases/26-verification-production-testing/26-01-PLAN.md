---
phase: 26-verification-production-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/scripts/verify-production.ts
  - backend/package.json
  - .planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md
  - .planning/STATE.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "Fremont collection has 50+ active questions in production database"
    - "Game sessions can be created from Fremont collection with 8-question rounds"
    - "All Fremont questions have fre- prefix external IDs (locale-specific)"
    - "All three difficulty levels (easy, medium, hard) are represented"
    - "Time-sensitive questions have expiration timestamps"
    - "Fremont collection is visible in /api/game/collections response"
    - "Admin API returns Fremont questions when filtered by collection"
  artifacts:
    - path: "backend/src/scripts/verify-production.ts"
      provides: "Comprehensive production verification script for all 7 success criteria"
      min_lines: 150
    - path: ".planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md"
      provides: "Markdown verification report with pass/fail for each criterion"
      contains: "PASS"
  key_links:
    - from: "backend/src/scripts/verify-production.ts"
      to: "production Supabase database"
      via: "DATABASE_URL environment variable"
      pattern: "process\\.env\\.DATABASE_URL"
    - from: "backend/src/scripts/verify-production.ts"
      to: "production backend API"
      via: "BACKEND_URL for session creation tests"
      pattern: "fetch.*session"
    - from: "backend/src/db/seed/seed-community.ts"
      to: "production Supabase database"
      via: "DATABASE_URL for seeding Fremont questions"
      pattern: "fremont-ca"
---

<objective>
Deploy the Fremont collection to production and verify all 7 success criteria are met through automated testing against the live production database and API. If all criteria pass, mark the v1.4 milestone as complete.

Purpose: This is the final gate before shipping the Fremont, CA collection. The seed script was prepared in Phase 25 but never run against production. This plan deploys code, seeds the database, runs comprehensive automated verification, and closes the milestone.

Output: verify-production.ts script, verification report markdown, updated milestone status in ROADMAP.md and STATE.md
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-verification-production-testing/26-CONTEXT.md
@.planning/phases/26-verification-production-testing/26-RESEARCH.md
@.planning/phases/25-image-seed-activation/25-01-SUMMARY.md
@backend/src/scripts/verify-fremont-final.ts
@backend/src/scripts/verify-activation.ts
@backend/src/db/seed/seed-community.ts
@backend/src/routes/game.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive production verification script</name>
  <files>backend/src/scripts/verify-production.ts, backend/package.json</files>
  <action>
Create `backend/src/scripts/verify-production.ts` that checks all 7 success criteria against the production database and API. Follow the established pattern from verify-fremont-final.ts and verify-activation.ts.

The script must:

1. **Setup:** Import dotenv/config, db from '../db/index.js', sql from 'drizzle-orm'. Log the sanitized DATABASE_URL (mask password) and timestamp at start. Define a CheckResult interface with fields: criterion (string), status ('PASS' | 'FAIL'), details (string), evidence (any, optional).

2. **Criterion 1 - Minimum 50 questions:** Query active Fremont questions via collection_questions join. PASS if count >= 50. Log actual count.

3. **Criterion 2 - Game sessions with 8-question rounds:** Use fetch() to POST to `${BACKEND_URL}/api/game/session` with the Fremont collection ID (look up from DB first via `SELECT id FROM civic_trivia.collections WHERE slug = 'fremont-ca'`). PASS if response is 201 and response body has questions array with length === 8. Create 3 test sessions total. Sessions live in Redis with TTL so no cleanup needed (document this in output).

4. **Criterion 3 - End-to-end playability:** For one of the test sessions, submit answers to all 8 questions via POST to `${BACKEND_URL}/api/game/answer` with sessionId, questionId, selectedOption: 0, timeRemaining: 15. Then fetch results via GET `${BACKEND_URL}/api/game/results/${sessionId}`. PASS if results return 200 with totalScore and totalQuestions === 8.

5. **Criterion 4 - Fremont-specific questions:** Query ALL active Fremont questions' external_id values. PASS if every external_id starts with 'fre-'. If any don't match, list the non-matching IDs in details for user review (per CONTEXT.md: flag for user review, not auto-deactivate).

6. **Criterion 5 - Difficulty balance:** Query difficulty distribution (GROUP BY difficulty). PASS if all three levels (easy, medium, hard) have at least 1 question each. No strict ratio enforcement per CONTEXT.md decision. Log the distribution with percentages.

7. **Criterion 6 - Expiration system:** Query count of questions with non-null expires_at. PASS if at least 1 question has an expiration timestamp. Also verify no currently-expired questions are still active (expires_at < NOW() AND status = 'active' should return 0).

8. **Criterion 7 - Admin panel / API accessibility:** GET `${BACKEND_URL}/api/game/collections` and verify Fremont appears in the response (check for slug 'fremont-ca' in returned collections array). PASS if found. This verifies the collection is visible to players, which implies admin panel visibility since admin uses the same data source.

9. **Reporting:** After all 7 checks complete (DO NOT fail fast â€” run all checks regardless), print a console.table summary. Then generate a markdown report and write it to `.planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md` with frontmatter (phase, verified date, status, score). Include evidence for each criterion.

10. **Exit code:** Exit 0 if all pass, exit 1 if any fail.

Use BACKEND_URL from environment variable, defaulting to 'https://civic-trivia-backend.onrender.com'. Use try/catch around each criterion check so one failure doesn't prevent other checks from running.

Add to backend/package.json scripts: `"verify:production": "tsx src/scripts/verify-production.ts"`

IMPORTANT: The report path should use path.resolve relative to the script location to find the .planning directory at the project root, since the script runs from backend/. Use something like:
```
const reportPath = resolve(__dirname, '..', '..', '..', '.planning', 'phases', '26-verification-production-testing', '26-VERIFICATION-REPORT.md');
```
  </action>
  <verify>
Run `npx tsx backend/src/scripts/verify-production.ts --help 2>&1 || echo "Script exists"` to confirm the file compiles. Check that `backend/package.json` contains "verify:production" script entry.
  </verify>
  <done>
verify-production.ts exists with all 7 criterion checks, report generation, and non-fail-fast error handling. package.json has verify:production script entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to production and seed Fremont collection</name>
  <files>(no new files â€” deployment actions)</files>
  <action>
Deploy the Fremont collection to production in this order:

**Step 1: Commit the verification script** created in Task 1.
```bash
git add backend/src/scripts/verify-production.ts backend/package.json
git commit -m "feat(26): add production verification script for Fremont collection"
```

**Step 2: Push to master** to trigger Render auto-deploy for both frontend and backend.
```bash
git push origin master
```
This deploys:
- Backend: verify-production.ts script, seed-community.ts with Fremont registered
- Frontend: fremont-ca.jpg banner image in public/images/collections/

**Step 3: Wait for Render deploy** â€” pause for ~3-5 minutes. Then verify the backend is live by hitting the health endpoint:
```bash
curl -s https://civic-trivia-backend.onrender.com/api/game/collections | head -c 200
```
Confirm the response includes collection data (even if Fremont isn't visible yet since it hasn't been seeded).

**Step 4: Seed production database** â€” Run the community seed script against production. This requires the production DATABASE_URL. The executor should:
1. Check if DATABASE_URL in backend/.env points to production Supabase (should contain 'supabase.co')
2. If it does, run: `cd backend && npm run db:seed:community`
3. If it doesn't, the executor will need to set DATABASE_URL to the production value before running. The production DATABASE_URL is the same one used by Render (stored in Render dashboard environment variables).

The seed script is idempotent (ON CONFLICT DO NOTHING) so it's safe to run multiple times. It will:
- Seed Bloomington (skips existing), LA (skips existing), and Fremont (inserts 92 questions)
- Set Fremont collection isActive: true
- Log a summary of all collections, topics, questions, and collection-questions counts

**Step 5: Verify seed success** â€” After seeding, run a quick check:
```bash
curl -s https://civic-trivia-backend.onrender.com/api/game/collections
```
Fremont should now appear in the collections list with questionCount >= 50.

IMPORTANT: If the DATABASE_URL doesn't point to production, DO NOT modify .env files. Instead, prompt the user to provide the production DATABASE_URL or confirm it's already set correctly. This is a safety measure to prevent accidentally overwriting dev database configuration.
  </action>
  <verify>
`curl -s https://civic-trivia-backend.onrender.com/api/game/collections` returns JSON that includes 'fremont-ca' in the response. The seed script output shows Fremont questions seeded successfully.
  </verify>
  <done>
Code pushed to master, Render deployed (both frontend and backend), Fremont collection seeded to production database with 92 active questions, collection visible in /api/game/collections endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run production verification and finalize milestone</name>
  <files>.planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md, .planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
**Step 1: Run the verification script against production.**

Set BACKEND_URL to the production backend and run:
```bash
cd backend && BACKEND_URL=https://civic-trivia-backend.onrender.com npm run verify:production
```

The script will check all 7 criteria and generate a report at `.planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md`.

Review the terminal output. All 7 criteria should show PASS.

**Step 2: Handle failures (if any).**

Per CONTEXT.md decisions:
- If non-Fremont questions found (criterion 4 fails): Flag the specific external_ids in the report for user review. DO NOT auto-deactivate.
- If question count drops below 50 after any fixes: Phase fails. Stop and report.
- If session creation fails: Check that Render deploy completed. Retry after waiting.
- If difficulty balance fails: This would mean a level is completely missing â€” investigate.

**Step 3: If all 7 criteria pass, update milestone status.**

Update `.planning/ROADMAP.md`:
1. Change `| 26. Verification | v1.4 | 0/TBD | Not started | - |` to `| 26. Verification | v1.4 | 1/1 | Complete | 2026-02-21 |`
2. Change Phase 26 Plans from `TBD` to `1 plan`
3. Update plan checklist: `- [x] 26-01-PLAN.md â€” Deploy, verify, and finalize Fremont collection`
4. Change the v1.4 milestone header from `### ðŸš§ v1.4 Fremont, CA Collection (In Progress)` to a completed details block like the other milestones

Update `.planning/STATE.md`:
1. Update current position to Phase 26 complete
2. Update progress bar and percentage to reflect completion
3. Change v1.4 milestone progress to complete (all requirements delivered)
4. Update session continuity section
5. Move "Phase 26 readiness notes" from Blockers/Concerns to being cleared (no blockers remaining)
6. Add decision: "Phase 26: All 7 verification criteria passed, v1.4 milestone complete"

**Step 4: Commit the verification report and milestone updates.**
```bash
git add .planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md .planning/STATE.md .planning/ROADMAP.md
git commit -m "docs(26): verification passed â€” v1.4 Fremont collection shipped"
git push origin master
```
  </action>
  <verify>
The file `.planning/phases/26-verification-production-testing/26-VERIFICATION-REPORT.md` exists and contains "status: passed" in frontmatter. STATE.md shows Phase 26 complete and v1.4 milestone complete. ROADMAP.md shows Phase 26 with 1/1 plans complete.
  </verify>
  <done>
All 7 verification criteria pass. Verification report generated and saved. v1.4 milestone marked complete in STATE.md and ROADMAP.md. All changes committed and pushed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, confirm:
1. `curl -s https://civic-trivia-backend.onrender.com/api/game/collections` includes Fremont with 50+ questions
2. `curl -s -X POST https://civic-trivia-backend.onrender.com/api/game/session -H "Content-Type: application/json" -d '{"collectionId": FREMONT_ID}'` returns 201 with 8 questions
3. `curl -s https://civic-trivia-frontend.onrender.com` loads the frontend (banner image accessible)
4. 26-VERIFICATION-REPORT.md exists with all 7 criteria marked PASS
5. ROADMAP.md shows v1.4 complete
6. STATE.md shows Phase 26 complete
</verification>

<success_criteria>
- Production database contains 50+ active Fremont questions
- Game sessions create successfully from Fremont collection with 8 questions each
- End-to-end playability verified (session create -> answer -> results)
- All questions confirmed as Fremont-specific (fre- prefix)
- All three difficulty levels represented
- Time-sensitive questions have expiration timestamps
- Fremont visible in public collections API
- Verification report saved to planning directory
- v1.4 milestone marked complete in STATE.md and ROADMAP.md
</success_criteria>

<output>
After completion, create `.planning/phases/26-verification-production-testing/26-01-SUMMARY.md`
</output>
