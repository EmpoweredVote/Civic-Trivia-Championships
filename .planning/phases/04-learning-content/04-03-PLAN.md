---
phase: 04-learning-content
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/features/game/components/ResultsScreen.tsx
  - frontend/src/pages/Game.tsx
autonomous: false

must_haves:
  truths:
    - "Results screen shows topic category badge for each question in the accordion"
    - "Questions with learningContent are tappable from results to open LearnMoreModal"
    - "Modal opened from results shows same content as during gameplay"
    - "User can close results modal and continue reviewing other questions"
    - "Topic badges use the correct icon and label for each category"
  artifacts:
    - path: "frontend/src/features/game/components/ResultsScreen.tsx"
      provides: "Topic badges in accordion headers, tappable Learn More from results"
      contains: "LearnMoreModal"
    - path: "frontend/src/pages/Game.tsx"
      provides: "Pass questions with learningContent to ResultsScreen"
      contains: "ResultsScreen"
  key_links:
    - from: "frontend/src/features/game/components/ResultsScreen.tsx"
      to: "frontend/src/features/game/components/LearnMoreModal.tsx"
      via: "Opens modal when user taps question with content"
      pattern: "LearnMoreModal"
    - from: "frontend/src/features/game/components/ResultsScreen.tsx"
      to: "frontend/src/features/game/components/TopicIcon.tsx"
      via: "Renders topic icon and label per question"
      pattern: "TOPIC_ICONS|TOPIC_LABELS"
---

<objective>
Add topic category badges to the ResultsScreen question accordions and make questions with learning content tappable to reopen the LearnMoreModal.

Purpose: Fulfills LEARN-05 (results screen lists topics covered during game) and ensures educational content is not a one-time opportunity -- users can review and learn from any question after the game ends.

Output: Updated ResultsScreen with topic badges per question, tappable "Learn More" links in expanded accordion, and integrated LearnMoreModal for results-phase content viewing.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-learning-content/04-CONTEXT.md
@.planning/phases/04-learning-content/04-02-SUMMARY.md
@frontend/src/features/game/components/ResultsScreen.tsx
@frontend/src/features/game/components/LearnMoreModal.tsx
@frontend/src/features/game/components/TopicIcon.tsx
@frontend/src/types/game.ts
@frontend/src/pages/Game.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add topic badges and Learn More links to ResultsScreen</name>
  <files>
    frontend/src/features/game/components/ResultsScreen.tsx
    frontend/src/pages/Game.tsx
  </files>
  <action>
1. Update `ResultsScreen.tsx`:

   a. Add imports:
      - `{ TOPIC_ICONS, TOPIC_LABELS }` from `./TopicIcon`
      - `{ LearnMoreModal }` from `./LearnMoreModal`
      - `LearningContent` type from `../../../types/game`

   b. Add state for results-phase modal:
      - `const [learnMoreQuestion, setLearnMoreQuestion] = useState<{ content: LearningContent; userAnswer: number | null; correctAnswer: number } | null>(null)`
      - The modal is open when `learnMoreQuestion !== null`

   c. Add handlers:
      - `handleOpenLearnMore(questionIndex: number)`:
        - Gets question and answer at that index
        - Sets learnMoreQuestion with: content from question.learningContent, userAnswer from answer.selectedOption, correctAnswer from answer.correctAnswer
      - `handleCloseLearnMore()`:
        - Sets learnMoreQuestion to null

   d. In the question accordion collapsed view (the button element), add a topic badge:
      - Position: Between "Question {N}" label and the question text
      - Badge markup: small inline-flex with topic icon (16x16, w-4 h-4) + topic label text
      - Styling: `inline-flex items-center gap-1 text-xs text-slate-400 bg-slate-800/80 px-2 py-0.5 rounded-full mt-1`
      - Only show if question has `topicCategory` field
      - Use TOPIC_ICONS[question.topicCategory] for icon, TOPIC_LABELS[question.topicCategory] for label

   e. In the question accordion expanded view, add a "Learn More" link:
      - Position: After the existing explanation div, before the closing of the expanded section
      - Only show if question.learningContent exists
      - Render as a button styled like a text link:
        ```
        <button
          onClick={(e) => { e.stopPropagation(); handleOpenLearnMore(index); }}
          className="mt-3 text-teal-400 hover:text-teal-300 text-sm font-medium flex items-center gap-1 transition-colors"
        >
          <svg className="w-4 h-4" ...book-open-icon.../>
          Learn More
        </button>
        ```
      - stopPropagation prevents the accordion from toggling when clicking Learn More

   f. Render LearnMoreModal at the bottom of the component (outside the scrollable area):
      ```tsx
      <LearnMoreModal
        isOpen={learnMoreQuestion !== null}
        onClose={handleCloseLearnMore}
        content={learnMoreQuestion?.content ?? { topic: 'voting', paragraphs: [], corrections: {}, source: { name: '', url: '' } }}
        userAnswer={learnMoreQuestion?.userAnswer ?? null}
        correctAnswer={learnMoreQuestion?.correctAnswer ?? 0}
      />
      ```

2. Verify Game.tsx passes questions correctly:
   - The existing Game.tsx already passes `state.questions` to ResultsScreen
   - Confirm that questions include learningContent and topicCategory (they should, since the server strips correctAnswer but the frontend loads from session which includes these fields)
   - If questions from useGameState don't include learningContent (because server strips it), then the learning content needs to come from a different source. Check: the server sends questions via createGameSession -- does it strip learningContent?
   - LIKELY ISSUE: The server strips correctAnswer from questions sent to client (for anti-cheat). It may also not include learningContent. If so, learningContent needs to be loaded separately or included in the session response.
   - RESOLUTION: Update the backend session creation to include learningContent in the questions sent to the client (it's not a secret -- it's educational content). Only correctAnswer needs to be stripped. Check `backend/src/services/sessionService.ts` and the session creation endpoint to confirm learningContent passes through. If the backend explicitly strips fields, add learningContent to the allowed fields.

3. If backend changes are needed (check sessionService.ts):
   - Find where questions are sent to client and ensure learningContent and topicCategory are included
   - These are NOT security-sensitive fields (unlike correctAnswer)
   - Update the backend Question interface if needed to include learningContent and topicCategory

IMPORTANT: The question `topicCategory` field must be present in the Question type on the frontend (done in Plan 01). Ensure the server passes it through to the client.

IMPORTANT: Per CONTEXT.md decision -- "Just topic names shown -- no accuracy-per-category stats." Do NOT add any topic-level aggregation or accuracy statistics.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes
    - `cd backend && npx tsc --noEmit` passes (if backend types updated)
    - ResultsScreen imports LearnMoreModal and TopicIcon components
    - Topic badges render in accordion headers
    - "Learn More" link appears in expanded accordion for questions with content
  </verify>
  <done>
    - Topic category badge (icon + label) shown per question in results accordion
    - Questions with learningContent have clickable "Learn More" link in expanded view
    - Clicking "Learn More" opens LearnMoreModal with correct answer-aware content
    - Modal can be closed to continue reviewing other questions
    - Backend passes learningContent and topicCategory to client (not stripped)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Learn More feature across the game flow:
    1. Answer reveal: "Learn More" button fades in, tooltip auto-shows with teaser
    2. Modal: Opens with educational content, answer-aware opener, topic icon, source link
    3. Timer: Auto-advance pauses when modal opens, resumes on close
    4. Keyboard: 'L' shortcut opens modal during reveal
    5. Results: Topic badges on each question, tappable "Learn More" from accordion
  </what-built>
  <how-to-verify>
    Start both servers: `cd backend && npm run dev` and `cd frontend && npm run dev`

    **During Gameplay:**
    1. Visit http://localhost:5173 and start a Quick Play game
    2. Answer a question correctly -- after reveal, verify:
       - "Learn More" button fades in (lower area, teal)
       - Tooltip auto-shows briefly with first sentence teaser, then dismisses
       - Click "Learn More" button -- modal should open with "That's right!" opener
       - Game should be visually dimmed behind modal
       - Modal shows 2-3 paragraphs of educational content
       - Source citation at bottom with clickable link
       - Topic icon visible at top of modal
       - Press Escape or click outside -- modal closes
       - Auto-advance timer RESUMES (does NOT restart from 6s)
    3. Answer a question incorrectly -- verify modal shows specific wrong-answer correction
    4. Let a question time out -- verify modal shows "Time's up!" opener
    5. Press 'L' during reveal -- verify modal opens via keyboard
    6. Verify tooltip only auto-shows ONCE (first reveal only, subsequent reveals show button without tooltip)
    7. Note: Only ~15 questions have Learn More content -- some questions will not show the button

    **Results Screen:**
    8. Complete the game and reach results screen
    9. Verify each question shows a topic category badge (icon + name) in accordion header
    10. Expand a question that has content -- verify "Learn More" link appears below explanation
    11. Click "Learn More" from results -- verify modal opens with correct content
    12. Close modal -- verify results screen is still functional

    **Edge Cases:**
    13. On a question WITHOUT learningContent -- verify NO Learn More button appears (clean, no errors)
    14. Mobile viewport (resize to 375px width) -- verify modal scrolls, content fits
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- Topic badges visible on all questions in results accordion (for questions with topicCategory)
- "Learn More" link works from results screen to open modal
- Full gameplay flow: reveal -> button -> tooltip -> modal -> close -> timer resumes
- Questions without learningContent show no button (graceful degradation)
- Modal accessible: focus trap, escape key, click outside, keyboard shortcut
</verification>

<success_criteria>
- LEARN-01: Answer reveal includes "Learn more" link for deeper content -- VERIFIED
- LEARN-02: "Learn more" opens modal without leaving game -- VERIFIED
- LEARN-03: Modal shows expanded explanation (2-3 paragraphs) -- VERIFIED
- LEARN-04: User can close modal and continue game -- VERIFIED
- LEARN-05: Results screen lists topics covered during game -- VERIFIED
- CONT-06: At least 10 topics have "Learn more" content available -- VERIFIED (15+ questions across 9 categories)
</success_criteria>

<output>
After completion, create `.planning/phases/04-learning-content/04-03-SUMMARY.md`
</output>
