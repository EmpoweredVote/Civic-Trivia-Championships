---
phase: 21-generation-pipeline-new-collections
plan: 04
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "California state collection has 80-100 active questions in the database"
    - "California questions are visible in the collection picker for gameplay"
    - "All inserted California questions passed quality validation (no blocking violations)"
    - "A generation report exists showing pass/fail breakdown for California"
  artifacts:
    - path: "backend/src/scripts/data/reports/generation-california-state-*.json"
      provides: "California generation report with stats"
  key_links:
    - from: "collections table"
      to: "california-state collection"
      via: "slug = 'california-state'"
      pattern: "california-state"
    - from: "collection_questions table"
      to: "questions table"
      via: "collectionId for california-state"
      pattern: "collectionId"
---

<objective>
Run the state generation script to produce the California state question collection (80-100 questions). Same pipeline as Indiana (Plan 03), different content.

Purpose: Requirement COLL-02 (California state question collection). California is an alpha community location (LA founder). Consistent style with Indiana -- same template, same approach, only content differs.

Output: 80-100 active California state questions in the database, visible in the collection picker, with a generation report file.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-generation-pipeline-new-collections/21-CONTEXT.md
@.planning/phases/21-generation-pipeline-new-collections/21-01-SUMMARY.md
@.planning/phases/21-generation-pipeline-new-collections/21-02-SUMMARY.md
@backend/src/scripts/content-generation/generate-state-questions.ts
@backend/src/scripts/content-generation/locale-configs/state-configs/california.ts

# Reference Indiana results to compare quality/pass rates
@.planning/phases/21-generation-pipeline-new-collections/21-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch California RAG sources and generate collection</name>
  <files></files>
  <action>
Run the California state generation from the backend directory. Apply any lessons learned from Indiana generation (referenced in 21-03-SUMMARY.md -- e.g., if prompt adjustments were needed).

1. **Fetch RAG sources and test first batch:**
```bash
cd backend
npx tsx src/scripts/content-generation/generate-state-questions.ts --state california --fetch-sources --dry-run --batch 1
```

2. **Check first batch results.** Compare pass rate with Indiana. If significantly lower, check failure reasons -- California's ballot proposition system and direct democracy topics may trigger different rule violations than Indiana.

3. **Run full generation:**
```bash
npx tsx src/scripts/content-generation/generate-state-questions.ts --state california --fetch-sources
```

4. **Verify database insertion:**
```bash
npx tsx -e "
import { db } from './src/db/index.js';
import { sql } from 'drizzle-orm';

const result = await db.execute(sql\`
  SELECT c.name, c.slug, COUNT(cq.question_id) as question_count
  FROM civic_trivia.collections c
  LEFT JOIN civic_trivia.collection_questions cq ON c.id = cq.collection_id
  LEFT JOIN civic_trivia.questions q ON cq.question_id = q.id AND q.status = 'active'
  WHERE c.slug = 'california-state'
  GROUP BY c.id, c.name, c.slug
\`);
console.log(result.rows);
process.exit(0);
"
```

5. **Verify generation report** in `backend/src/scripts/data/reports/`.

If below 80 active questions, run additional batches as needed.
  </action>
  <verify>
Database query shows california-state collection with 80-100 active questions. Generation report JSON exists. Report shows passedValidation >= 80.
  </verify>
  <done>
California state collection has 80-100 active questions in the database. Generation report persisted with pass/fail stats.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>California state question collection (80-100 questions) generated via quality-gated AI pipeline and inserted into the database as active questions.</what-built>
  <how-to-verify>
1. Visit the frontend collection picker
2. Verify "California State" appears as a playable collection
3. Start a game with the California State collection
4. Play through 5-10 questions and verify:
   - Questions cover ballot propositions, direct democracy, state legislature, civic history
   - Questions are beginner-friendly
   - California-specific features are represented (propositions, assembly vs senate, recall)
   - Style and tone are consistent with Indiana questions (same template, same approach)
5. Check admin question explorer for California State collection quality scores
  </how-to-verify>
  <resume-signal>Type "approved" or describe any quality issues with the generated questions</resume-signal>
</task>

</tasks>

<verification>
1. Database contains 80-100 active questions with collectionSlug 'california-state'
2. Topic distribution covers California-specific civics (propositions, direct democracy, large legislature)
3. Generation report shows all inserted questions passed quality validation
4. Style consistent with Indiana collection (same template produced both)
5. Collection is visible and playable in the frontend
</verification>

<success_criteria>
- California state collection has 80-100 active, playable questions
- All questions passed Phase 19 quality rules
- California-specific features well-represented (propositions, direct democracy, recall)
- Consistent style and tone with Indiana collection
- Collection visible in gameplay collection picker
</success_criteria>

<output>
After completion, create `.planning/phases/21-generation-pipeline-new-collections/21-04-SUMMARY.md`
</output>
