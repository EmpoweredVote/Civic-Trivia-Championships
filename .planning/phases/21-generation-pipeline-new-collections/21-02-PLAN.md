---
phase: 21-generation-pipeline-new-collections
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/scripts/content-generation/prompts/state-system-prompt.ts
  - backend/src/scripts/content-generation/locale-configs/state-configs/indiana.ts
  - backend/src/scripts/content-generation/locale-configs/state-configs/california.ts
  - backend/src/scripts/content-generation/generate-state-questions.ts
autonomous: true

must_haves:
  truths:
    - "A state-level generation template exists distinct from the city-level template"
    - "State template covers both government structure AND broader civic topics with equal emphasis"
    - "Indiana config has state-specific features (part-time legislature, multiple elected officers)"
    - "California config has state-specific features (ballot propositions, direct democracy)"
    - "State generation script accepts --state flag and integrates with quality validation pipeline"
  artifacts:
    - path: "backend/src/scripts/content-generation/prompts/state-system-prompt.ts"
      provides: "State-level system prompt builder"
      exports: ["buildStateSystemPrompt"]
    - path: "backend/src/scripts/content-generation/locale-configs/state-configs/indiana.ts"
      provides: "Indiana state configuration"
      exports: ["indianaConfig"]
    - path: "backend/src/scripts/content-generation/locale-configs/state-configs/california.ts"
      provides: "California state configuration"
      exports: ["californiaConfig"]
    - path: "backend/src/scripts/content-generation/generate-state-questions.ts"
      provides: "State-level generation script with quality validation"
      exports: []
  key_links:
    - from: "backend/src/scripts/content-generation/generate-state-questions.ts"
      to: "backend/src/scripts/content-generation/prompts/state-system-prompt.ts"
      via: "import buildStateSystemPrompt"
      pattern: "import.*buildStateSystemPrompt"
    - from: "backend/src/scripts/content-generation/prompts/state-system-prompt.ts"
      to: "backend/src/scripts/content-generation/prompts/quality-guidelines.ts"
      via: "import QUALITY_GUIDELINES"
      pattern: "import.*QUALITY_GUIDELINES"
    - from: "backend/src/scripts/content-generation/generate-state-questions.ts"
      to: "backend/src/scripts/content-generation/utils/quality-validation.ts"
      via: "import validateAndRetry, saveReport"
      pattern: "import.*validateAndRetry.*quality-validation"
---

<objective>
Create the state-level generation template, Indiana and California state configs, and the state generation script that wires everything together (template + quality guidelines + validation pipeline).

Purpose: Requirement GENR-03 (state-level template distinct from city-level). The state template covers government structure, civic processes, and broader civics -- unlike the city template which focuses on local government mechanics. The generation script is the executable that Plans 03 and 04 will run to produce actual collections.

Output: State system prompt, two state configs, and a runnable generation script.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-generation-pipeline-new-collections/21-CONTEXT.md
@.planning/phases/21-generation-pipeline-new-collections/21-RESEARCH.md
@backend/src/scripts/content-generation/prompts/system-prompt.ts
@backend/src/scripts/content-generation/locale-configs/bloomington-in.ts
@backend/src/scripts/content-generation/generate-locale-questions.ts
@backend/src/scripts/content-generation/anthropic-client.ts
@backend/src/scripts/content-generation/question-schema.ts
@backend/src/scripts/content-generation/utils/seed-questions.ts

# Plan 01 SUMMARY needed for quality-guidelines.ts and quality-validation.ts exports
@.planning/phases/21-generation-pipeline-new-collections/21-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state system prompt and state configs</name>
  <files>
    backend/src/scripts/content-generation/prompts/state-system-prompt.ts
    backend/src/scripts/content-generation/locale-configs/state-configs/indiana.ts
    backend/src/scripts/content-generation/locale-configs/state-configs/california.ts
  </files>
  <action>
**File 1: `prompts/state-system-prompt.ts`**

Create `buildStateSystemPrompt(stateName, stateFeatures, topicDistribution)` function. Model after the existing `buildSystemPrompt()` in `prompts/system-prompt.ts` but with key differences:

- Import and embed `QUALITY_GUIDELINES` from `./quality-guidelines.js` (from Plan 01)
- Topic scope covers THREE areas with equal emphasis (per CONTEXT.md decisions):
  1. **Government Structure (~40%)**: State legislature composition/powers/processes, governor and executive branch, state courts and judiciary
  2. **Civic Processes (~30%)**: State elections and voting, ballot initiatives/referendums/recalls, constitutional amendment process, citizen engagement
  3. **Broader Civics (~30%)**: State civic history and founding, state constitution key provisions, major policy issues with civic context, state symbols/landmarks with civic significance
- Accept `stateFeatures` string parameter for state-specific unique features (injected from config)
- Include the QUALITY_GUIDELINES in a dedicated section
- Same output format as city template (JSON with questions array)
- Same partisan neutrality rules
- Add instruction: "Questions should be beginner-friendly -- no assumed civic knowledge. Questions teach through options and explanations."
- Add instruction: "Focus on foundational civic knowledge, not obscure governmental trivia."
- Same explanation citation pattern ("According to [source], ...")
- Same elected official expiration handling
- Do NOT include RAG source document handling in the system prompt -- that's handled in the generation script's message construction

**File 2: `locale-configs/state-configs/indiana.ts`**

Create `indianaConfig` following the `LocaleConfig` interface from bloomington-in.ts:
- locale: 'indiana-state'
- name: 'Indiana'
- externalIdPrefix: 'ins' (Indiana State)
- collectionSlug: 'indiana-state'
- targetQuestions: 100
- batchSize: 25 (same as city template -- proven batch size)
- topicCategories: 8 categories covering the three areas:
  - legislature (state legislature composition and powers)
  - governor-executive (governor and executive branch)
  - state-courts (state court system and judiciary)
  - elections-voting (state elections and voting rights)
  - ballot-initiatives (ballot measures and civic participation -- Indiana has referendum but limited initiative)
  - civic-history (Indiana founding, statehood, civic milestones)
  - state-constitution (Indiana Constitution provisions)
  - policy-civics (state policy issues, taxes, education governance)
- topicDistribution: roughly follow 40/30/30 split (e.g., legislature=15, governor=12, courts=12, elections=15, ballot=10, history=12, constitution=12, policy=12)
- stateFeatures string with Indiana-specific details:
  - Part-time legislature (61 days odd years, 30 days even years)
  - Bicameral: 50 senators (4-year terms), 100 representatives (2-year terms)
  - Multiple elected statewide executive officers (governor, lt. governor, AG, SoS, treasurer, auditor)
  - Township government structure unique to Indiana
  - 19th state admitted to the Union (1816)
- sourceUrls: Indiana .gov pages (in.gov, iga.in.gov, courts.in.gov, etc.)

**File 3: `locale-configs/state-configs/california.ts`**

Create `californiaConfig` same structure:
- locale: 'california-state'
- name: 'California'
- externalIdPrefix: 'cas' (California State)
- collectionSlug: 'california-state'
- targetQuestions: 100
- batchSize: 25
- topicCategories: 8 categories same structure as Indiana but California-specific descriptions
- stateFeatures string with California-specific details:
  - Direct democracy: ballot proposition system (5% signatures for statute, 8% for amendment)
  - Large full-time legislature: 40 senators (4-year), 80 assembly members (2-year)
  - Two-thirds vote required for constitutional amendments (27 senate, 54 assembly)
  - Strong ballot initiative tradition
  - Recall process (used against governors)
  - 31st state (1850)
- sourceUrls: California .gov pages (ca.gov, legislature.ca.gov, courts.ca.gov, sos.ca.gov)

Both configs should export a `stateFeatures` string alongside the config (or include it as a property) for injection into the state system prompt.
  </action>
  <verify>
Run `npx tsc --noEmit` from backend directory. Verify state-system-prompt.ts imports QUALITY_GUIDELINES. Verify both state configs follow the LocaleConfig interface. Check that topicDistribution sums to ~100 for each config.
  </verify>
  <done>
State system prompt covers government structure, civic processes, and broader civics with quality guidelines embedded. Indiana and California configs have state-specific features, 8 topic categories each, and appropriate source URLs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create state-level generation script</name>
  <files>
    backend/src/scripts/content-generation/generate-state-questions.ts
  </files>
  <action>
Create `generate-state-questions.ts` modeled after `generate-locale-questions.ts` but adapted for state-level generation with quality validation integration.

**CLI interface:**
```
npx tsx src/scripts/content-generation/generate-state-questions.ts --state indiana --fetch-sources
npx tsx src/scripts/content-generation/generate-state-questions.ts --state california --dry-run
npx tsx src/scripts/content-generation/generate-state-questions.ts --state indiana --batch 1
```

Accepts `--state` (instead of `--locale`), `--batch`, `--fetch-sources`, `--dry-run`, `--help`.

**Key differences from locale script:**

1. **Uses state system prompt**: Import `buildStateSystemPrompt` instead of `buildSystemPrompt`. Pass stateFeatures from config.

2. **Quality validation integration**: After each batch is generated and Zod-parsed:
   - Import `validateAndRetry` from `./utils/quality-validation.js`
   - Import `createReport`, `saveReport` from same
   - Run `validateAndRetry(batchQuestions, regenerateWithFeedback, { maxRetries: 3 })`
   - Only the `passed` questions proceed to database seeding
   - Failed questions are logged but NOT inserted

3. **Regeneration callback**: Implement `regenerateWithFeedback(failedQuestion, violationMessages)` that:
   - Calls Claude API with a retry prompt including the failed question text, its violations, and instruction to fix
   - Uses the same state system prompt for context
   - Parses the single-question JSON response with QuestionSchema (not BatchSchema)
   - Returns the regenerated ValidatedQuestion

4. **Auto-insert as active**: Per CONTEXT.md decision, questions that pass validation insert with `status: 'active'` (NOT 'draft' like the city script). This means they go directly into gameplay rotation.

5. **Collection creation**: If the collection doesn't exist yet (it won't for new states), create it before seeding:
   - Insert into collections table: `{ name: 'Indiana State', slug: 'indiana-state', description: '...', type: 'state' }`
   - Then proceed with `ensureLocaleTopics()` and seeding

6. **Generation report**: After all batches complete, call `createReport()` and `saveReport()` to persist the generation stats.

7. **Token tracking**: Accumulate input_tokens, output_tokens, cache_creation_input_tokens, cache_read_input_tokens across all API calls for the report.

**State config loader:**
```typescript
const supportedStates = {
  'indiana': () => import('./locale-configs/state-configs/indiana.js'),
  'california': () => import('./locale-configs/state-configs/california.js'),
};
```

The script should print progress to console similar to the locale script but add validation stats per batch (e.g., "Batch 1: 25 generated, 22 passed, 3 retrying... 24 final passed, 1 exhausted").
  </action>
  <verify>
Run `npx tsc --noEmit` from backend directory. Run `npx tsx src/scripts/content-generation/generate-state-questions.ts --help` to verify CLI parses correctly. Run with `--state indiana --dry-run --batch 1` to verify it can generate and validate a single batch (requires ANTHROPIC_API_KEY -- if not available, verify compilation only).
  </verify>
  <done>
generate-state-questions.ts compiles, accepts --state/--batch/--dry-run/--fetch-sources flags, imports state system prompt and quality validation, implements regenerateWithFeedback callback, and inserts passing questions as active status. Generation report is saved after completion.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` -- zero type errors
2. state-system-prompt.ts embeds QUALITY_GUIDELINES and has separate sections for government structure, civic processes, broader civics
3. Indiana config has stateFeatures mentioning part-time legislature, 50 senators, 100 reps
4. California config has stateFeatures mentioning ballot propositions, 40 senators, 80 assembly
5. generate-state-questions.ts imports validateAndRetry and uses it on each batch
6. generate-state-questions.ts implements regenerateWithFeedback that calls Claude API with violation context
7. Questions insert as 'active' status (not 'draft')
8. `--help` flag prints usage information
</verification>

<success_criteria>
- State template is structurally distinct from city template (broader topic coverage, state government focus)
- Both state configs have 8 topic categories with ~100 target questions each
- Generation script integrates quality validation as a gate before database insertion
- Failed questions are retried with feedback, not silently dropped
- Generation report is persisted as JSON after each run
</success_criteria>

<output>
After completion, create `.planning/phases/21-generation-pipeline-new-collections/21-02-SUMMARY.md`
</output>
