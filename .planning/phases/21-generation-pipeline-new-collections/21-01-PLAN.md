---
phase: 21-generation-pipeline-new-collections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/scripts/content-generation/prompts/quality-guidelines.ts
  - backend/src/scripts/content-generation/utils/quality-validation.ts
autonomous: true

must_haves:
  truths:
    - "Generated questions that fail blocking quality rules are rejected before database insertion"
    - "Failed questions are retried with violation feedback up to 3 times"
    - "A structured JSON report is produced after every generation run"
  artifacts:
    - path: "backend/src/scripts/content-generation/prompts/quality-guidelines.ts"
      provides: "Summarized quality guidelines for embedding in generation prompts"
      exports: ["QUALITY_GUIDELINES"]
    - path: "backend/src/scripts/content-generation/utils/quality-validation.ts"
      provides: "Validation loop with retry-on-failure and report generation"
      exports: ["validateAndRetry", "GenerationReport", "saveReport"]
  key_links:
    - from: "backend/src/scripts/content-generation/utils/quality-validation.ts"
      to: "backend/src/services/qualityRules/index.ts"
      via: "import auditQuestion"
      pattern: "import.*auditQuestion.*from.*qualityRules"
    - from: "backend/src/scripts/content-generation/utils/quality-validation.ts"
      to: "backend/src/scripts/content-generation/prompts/quality-guidelines.ts"
      via: "import QUALITY_GUIDELINES"
      pattern: "import.*QUALITY_GUIDELINES"
---

<objective>
Build the quality-gated generation infrastructure: summarized quality guidelines for prompts, post-generation validation with retry-on-failure loop, and structured generation report utility.

Purpose: This is the foundation that makes AI-generated questions pass through quality gates before database insertion. Without this, Plans 03-05 (actual generation runs) cannot produce quality-validated collections.

Output: Two new utility files that all generation scripts will import -- quality guidelines text for prompts and a validate-retry-report pipeline.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-generation-pipeline-new-collections/21-CONTEXT.md
@.planning/phases/21-generation-pipeline-new-collections/21-RESEARCH.md
@backend/src/services/qualityRules/index.ts
@backend/src/services/qualityRules/types.ts
@backend/src/scripts/content-generation/question-schema.ts
@backend/src/scripts/content-generation/anthropic-client.ts
@backend/src/scripts/content-generation/generate-locale-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quality guidelines prompt text and validation+retry utility</name>
  <files>
    backend/src/scripts/content-generation/prompts/quality-guidelines.ts
    backend/src/scripts/content-generation/utils/quality-validation.ts
  </files>
  <action>
**File 1: `prompts/quality-guidelines.ts`**

Create an exported `QUALITY_GUIDELINES` string constant (200-400 tokens) that summarizes the Phase 19 quality rules in prompt-friendly language. This is NOT the full rule implementation -- it's a natural-language summary that tells the AI what to avoid.

Read the actual rule implementations to derive the guidelines:
- `backend/src/services/qualityRules/rules/ambiguity.ts` (ambiguous answers, vague qualifiers)
- `backend/src/services/qualityRules/rules/lookup.ts` (pure lookup trivia)
- `backend/src/services/qualityRules/rules/structural.ts` (structural quality, learn more link)
- `backend/src/services/qualityRules/rules/partisan.ts` (partisan framing)

The guidelines should cover:
1. **Ambiguous answers**: No similar options that could both be correct (e.g., overlapping number ranges, near-synonyms). All 4 options must be clearly distinct.
2. **Vague qualifiers**: No subjective words like "most important", "best", "primarily", "generally", "mainly". Use objective, verifiable facts.
3. **Pure lookup trivia**: No obscure dates, phone numbers, zip codes, or specific years unless they are foundational civic knowledge (e.g., when the state was admitted to the union is OK, but the year a specific bill passed is NOT).
4. **Partisan framing**: No political party labels unless the question is about party structure itself. No liberal/conservative/progressive characterizations.
5. **Structural quality**: Explanation must begin with "According to [source]". Source URL must be a real .gov/.edu/.us page. Question text must end with "?".
6. **Distractor quality**: All four options must be plausible -- no obviously wrong throwaway answers. Distractors should be real entities, real numbers in the right range, real government structures.

Export as `QUALITY_GUIDELINES`.

**File 2: `utils/quality-validation.ts`**

Create the validation+retry pipeline with these exports:

1. `GenerationReport` interface:
```typescript
interface GenerationReport {
  timestamp: string;
  target: string;
  config: { targetQuestions: number; batchSize: number; maxRetries: number };
  results: { totalGenerated: number; passedValidation: number; failedValidation: number; retryExhausted: number; finalInserted: number };
  breakdown: { byRule: Record<string, number>; byRetryAttempt: Record<number, number>; byDifficulty: Record<string, number>; byTopic: Record<string, number> };
  failures: Array<{ externalId: string; text: string; violations: string[]; attempts: number }>;
  performance: { totalDurationMs: number; apiCalls: number; tokensUsed: { input: number; output: number; cached: number }; estimatedCostUsd: number };
}
```

2. `validateAndRetry(questions, regenerateFn, options)` function:
- Takes array of `ValidatedQuestion` from Zod parse
- For each question, calls `auditQuestion(question, { skipUrlCheck: true })` from the quality rules engine
- If `hasBlockingViolations` is false: question passes, add to passed array
- If `hasBlockingViolations` is true: extract blocking violation messages, call `regenerateFn(question, violationMessages)` to get a new question, re-validate
- Retry up to `maxRetries` (default 3) per question
- Track stats for the report: which rules triggered, which retry attempt succeeded, etc.
- Return `{ passed: ValidatedQuestion[], failed: Array<{question, violations, attempts}> }`

3. `createReport(target, config, validationResult, performanceStats)` function that builds a `GenerationReport` object

4. `saveReport(report)` function that writes JSON to `backend/src/scripts/data/reports/generation-{target}-{YYYY-MM-DD}.json`, creating the reports directory if needed

Import `auditQuestion` from `../../services/qualityRules/index.js`. Import `ValidatedQuestion` from `../question-schema.js`.

Do NOT import the Anthropic client -- the `regenerateFn` callback is injected by the caller (the generation script), keeping this utility decoupled from the API client.
  </action>
  <verify>
Run `npx tsc --noEmit` from the backend directory to verify both files compile without errors. Verify the imports resolve correctly -- especially the relative path from utils/quality-validation.ts to services/qualityRules/index.ts.
  </verify>
  <done>
quality-guidelines.ts exports QUALITY_GUIDELINES string covering all 6 quality rule areas. quality-validation.ts exports validateAndRetry (with retry loop calling auditQuestion), createReport, saveReport, and GenerationReport type. Both files compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` -- no type errors
2. quality-guidelines.ts contains actionable guidelines for all 6 rule categories (ambiguity, vague qualifiers, lookup, partisan, structural, distractors)
3. quality-validation.ts imports auditQuestion from qualityRules and uses skipUrlCheck: true
4. validateAndRetry accepts a regenerateFn callback (not hardcoded API calls)
5. Report structure includes all fields: timestamp, target, config, results, breakdown, failures, performance
</verification>

<success_criteria>
- QUALITY_GUIDELINES is a natural-language string (not code) suitable for embedding in system prompts
- validateAndRetry correctly gates on hasBlockingViolations and retries up to maxRetries
- Report captures per-rule violation counts, per-retry-attempt success rates, and failure details
- Both files compile with zero type errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-generation-pipeline-new-collections/21-01-SUMMARY.md`
</output>
