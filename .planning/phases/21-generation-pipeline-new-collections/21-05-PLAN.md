---
phase: 21-generation-pipeline-new-collections
plan: 05
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - backend/src/scripts/content-generation/generate-replacements.ts
autonomous: false

must_haves:
  truths:
    - "Collections that lost questions in Phase 19 archival have replacement questions restoring their counts"
    - "Replacement questions passed quality validation before insertion"
    - "Replacements include a mix of matching archived topics AND topic coverage gap fillers"
    - "A generation report exists showing replacement stats per collection"
  artifacts:
    - path: "backend/src/scripts/content-generation/generate-replacements.ts"
      provides: "Replacement question generation script"
    - path: "backend/src/scripts/data/reports/generation-replacements-*.json"
      provides: "Replacement generation report"
  key_links:
    - from: "backend/src/scripts/content-generation/generate-replacements.ts"
      to: "backend/src/scripts/content-generation/utils/quality-validation.ts"
      via: "import validateAndRetry"
      pattern: "import.*validateAndRetry"
    - from: "backend/src/scripts/content-generation/generate-replacements.ts"
      to: "backend/src/services/qualityRules/index.ts"
      via: "through quality-validation.ts"
      pattern: "auditQuestion"
---

<objective>
Create a replacement question generation script and run it to backfill collections that lost questions during Phase 19 archival (9 questions archived). Replacements mix matching archived topics with topic coverage gap fillers.

Purpose: Requirement QUAL-05 (generate replacement questions to maintain collection sizes). Phase 19 archived 9 questions with blocking violations. Those collections need backfill to maintain robust gameplay (minimum 50 questions per collection threshold from Phase 19).

Output: Replacement generation script and restored collection question counts, with generation report.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-generation-pipeline-new-collections/21-CONTEXT.md
@.planning/phases/21-generation-pipeline-new-collections/21-01-SUMMARY.md
@.planning/phases/21-generation-pipeline-new-collections/21-02-SUMMARY.md
@backend/src/scripts/content-generation/generate-locale-questions.ts
@backend/src/scripts/content-generation/prompts/system-prompt.ts
@backend/src/scripts/content-generation/locale-configs/bloomington-in.ts
@backend/src/scripts/content-generation/locale-configs/los-angeles-ca.ts
@backend/src/scripts/content-generation/utils/seed-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create replacement generation script</name>
  <files>
    backend/src/scripts/content-generation/generate-replacements.ts
  </files>
  <action>
Create `generate-replacements.ts` -- a script that identifies collections with archived questions and generates quality-validated replacements.

**CLI:**
```
npx tsx src/scripts/content-generation/generate-replacements.ts
npx tsx src/scripts/content-generation/generate-replacements.ts --dry-run
npx tsx src/scripts/content-generation/generate-replacements.ts --collection bloomington-in
```

Accepts `--dry-run`, `--collection <slug>` (optional, defaults to all affected collections).

**Logic:**

1. **Query archived questions per collection:**
```sql
SELECT c.slug, c.name, q.topic_id, q.subcategory, q.difficulty, q.external_id
FROM civic_trivia.questions q
JOIN civic_trivia.collection_questions cq ON q.id = cq.question_id
JOIN civic_trivia.collections c ON cq.collection_id = c.id
WHERE q.status = 'archived'
ORDER BY c.slug, q.subcategory
```

2. **For each affected collection, determine replacement needs:**
   - Count archived questions per topic/subcategory
   - Also query active question counts per topic to find under-represented topics (< 8 questions)
   - Generate ~50% replacements matching archived question topics, ~50% filling topic gaps (per CONTEXT.md)

3. **Generate replacements using the EXISTING city system prompt** (these are city-level collection replacements, not state-level). Import `buildSystemPrompt` from `./prompts/system-prompt.js`. Load the appropriate locale config for each collection.

4. **Quality validation:** Import `validateAndRetry` from `./utils/quality-validation.js`. Same validation pipeline as state generation -- validate each generated question, retry failures with feedback.

5. **Insert as active:** Same as state script -- passing questions insert with `status: 'active'`.

6. **Determine new external IDs:** Query the max existing external ID for each collection's prefix, then continue from there (e.g., if max is 'bli-120', start at 'bli-121').

7. **RAG sources:** Load existing source documents from `src/scripts/data/sources/{locale}/` (already fetched in Phase 17). Do NOT re-fetch.

8. **Generation report:** Save to `backend/src/scripts/data/reports/generation-replacements-{date}.json`.

Since only 9 questions were archived total (across likely 2-3 collections), the replacement count is small. Generate a batch of ~15-20 per affected collection to account for:
- Direct replacements for archived topics (~50%)
- Gap fillers for under-represented topics (~50%)
- Some buffer for validation failures
  </action>
  <verify>
`npx tsc --noEmit` compiles. `npx tsx src/scripts/content-generation/generate-replacements.ts --help` shows usage.
  </verify>
  <done>
generate-replacements.ts compiles, queries archived questions, generates quality-validated replacements using city system prompt, and produces generation report.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run replacement generation</name>
  <files></files>
  <action>
Execute the replacement generation:

1. **Dry run first:**
```bash
cd backend
npx tsx src/scripts/content-generation/generate-replacements.ts --dry-run
```
Review which collections need replacements and how many.

2. **Run full generation:**
```bash
npx tsx src/scripts/content-generation/generate-replacements.ts
```

3. **Verify collection counts are restored:**
```bash
npx tsx -e "
import { db } from './src/db/index.js';
import { sql } from 'drizzle-orm';

const result = await db.execute(sql\`
  SELECT c.name, c.slug,
    COUNT(CASE WHEN q.status = 'active' THEN 1 END) as active_count,
    COUNT(CASE WHEN q.status = 'archived' THEN 1 END) as archived_count
  FROM civic_trivia.collections c
  LEFT JOIN civic_trivia.collection_questions cq ON c.id = cq.collection_id
  LEFT JOIN civic_trivia.questions q ON cq.question_id = q.id
  GROUP BY c.id, c.name, c.slug
  ORDER BY c.slug
\`);
console.log(result.rows);
process.exit(0);
"
```

4. **Check generation report** in reports directory.
  </action>
  <verify>
All previously affected collections have active question counts >= their pre-archival counts (or at minimum >= 50 threshold). Generation report shows all inserted replacements passed validation.
  </verify>
  <done>
Replacement questions generated and inserted. Collection sizes restored. Generation report saved.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Replacement questions for collections that lost questions during Phase 19 archival. Questions generated through quality-gated pipeline and inserted as active.</what-built>
  <how-to-verify>
1. Check the admin collection health dashboard -- all collections should show healthy question counts (no red indicators from low counts)
2. Play a quick game from each affected collection to verify new questions feel consistent with existing ones
3. Review the generation report to confirm pass rates and topic coverage
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. All collections that had archived questions now have replacement active questions
2. No collection is below the 50-question minimum threshold
3. Replacement questions passed quality validation (no blocking violations)
4. Generation report shows mix of topic-matching and gap-filling replacements
</verification>

<success_criteria>
- Collections restored to pre-archival active question counts (or above)
- All replacement questions passed quality validation
- Replacements include both archived-topic matches and topic gap fillers
- Collection health dashboard shows no red indicators
</success_criteria>

<output>
After completion, create `.planning/phases/21-generation-pipeline-new-collections/21-05-SUMMARY.md`
</output>
