---
phase: 21-generation-pipeline-new-collections
plan: 03
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified: []
autonomous: false
user_setup:
  - service: anthropic
    why: "Claude API for question generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys (should already be in backend/.env from Phase 17)"

must_haves:
  truths:
    - "Indiana state collection has 80-100 active questions in the database"
    - "Indiana questions are visible in the collection picker for gameplay"
    - "All inserted Indiana questions passed quality validation (no blocking violations)"
    - "A generation report exists showing pass/fail breakdown for Indiana"
  artifacts:
    - path: "backend/src/scripts/data/reports/generation-indiana-state-*.json"
      provides: "Indiana generation report with stats"
  key_links:
    - from: "collections table"
      to: "indiana-state collection"
      via: "slug = 'indiana-state'"
      pattern: "indiana-state"
    - from: "collection_questions table"
      to: "questions table"
      via: "collectionId for indiana-state"
      pattern: "collectionId"
---

<objective>
Run the state generation script to produce the Indiana state question collection (80-100 questions). This plan executes the pipeline built in Plans 01 and 02 against real data.

Purpose: Requirement COLL-01 (Indiana state question collection). Indiana is an alpha community location (Bloomington UX lead). These questions complement the existing Bloomington city collection for Local/State/Federal coverage.

Output: 80-100 active Indiana state questions in the database, visible in the collection picker, with a generation report file.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-generation-pipeline-new-collections/21-CONTEXT.md
@.planning/phases/21-generation-pipeline-new-collections/21-01-SUMMARY.md
@.planning/phases/21-generation-pipeline-new-collections/21-02-SUMMARY.md
@backend/src/scripts/content-generation/generate-state-questions.ts
@backend/src/scripts/content-generation/locale-configs/state-configs/indiana.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch Indiana RAG sources and generate collection</name>
  <files></files>
  <action>
Run the Indiana state generation from the backend directory:

1. **Fetch RAG sources first:**
```bash
cd backend
npx tsx src/scripts/content-generation/generate-state-questions.ts --state indiana --fetch-sources --dry-run --batch 1
```
This fetches Indiana .gov source documents and does a dry-run of batch 1 to verify the pipeline works.

2. **Check first batch results:** Review the console output. If the first batch has a reasonable pass rate (>60%), proceed with full generation. If pass rate is very low (<50%), examine the failure reasons and consider adjusting the state system prompt or quality guidelines before continuing.

3. **Run full generation:**
```bash
npx tsx src/scripts/content-generation/generate-state-questions.ts --state indiana --fetch-sources
```
This generates all batches (4 batches of 25), validates each question, retries failures, and inserts passing questions as active.

4. **Verify database insertion:** After generation completes, verify the questions were inserted:
```bash
npx tsx -e "
import { db } from './src/db/index.js';
import { collections, collectionQuestions, questions } from './src/db/schema.js';
import { eq, sql } from 'drizzle-orm';

const result = await db.execute(sql\`
  SELECT c.name, c.slug, COUNT(cq.question_id) as question_count
  FROM civic_trivia.collections c
  LEFT JOIN civic_trivia.collection_questions cq ON c.id = cq.collection_id
  LEFT JOIN civic_trivia.questions q ON cq.question_id = q.id AND q.status = 'active'
  WHERE c.slug = 'indiana-state'
  GROUP BY c.id, c.name, c.slug
\`);
console.log(result.rows);
process.exit(0);
"
```

5. **Verify generation report exists:** Check that a report file was created in `backend/src/scripts/data/reports/`.

If the total is below 80 active questions after the full run, run additional batches:
```bash
npx tsx src/scripts/content-generation/generate-state-questions.ts --state indiana --batch 5
```
(Adjust batch number as needed to reach 80-100 target)
  </action>
  <verify>
Database query shows indiana-state collection with 80-100 active questions. Generation report JSON file exists in reports directory. Report shows passedValidation >= 80.
  </verify>
  <done>
Indiana state collection has 80-100 active questions in the database. Generation report persisted with pass/fail stats.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Indiana state question collection (80-100 questions) generated via quality-gated AI pipeline and inserted into the database as active questions.</what-built>
  <how-to-verify>
1. Visit the live frontend or local dev server
2. Navigate to the collection picker / play screen
3. Verify "Indiana State" (or similar) appears as a playable collection
4. Start a game with the Indiana State collection
5. Play through 5-10 questions and verify:
   - Questions cover state government, elections, civic history (not just legislature mechanics)
   - Questions are beginner-friendly (no assumed knowledge)
   - Explanations cite sources with "According to..."
   - Options are all plausible (no obvious throwaway answers)
6. Check the admin question explorer for the Indiana State collection:
   - Questions have quality scores
   - No blocking violations on inserted questions
  </how-to-verify>
  <resume-signal>Type "approved" or describe any quality issues with the generated questions</resume-signal>
</task>

</tasks>

<verification>
1. Database contains 80-100 active questions with collectionSlug 'indiana-state'
2. Questions cover diverse topics (not just legislature -- check topic distribution in report)
3. Generation report shows all inserted questions passed quality validation
4. Collection is visible and playable in the frontend
</verification>

<success_criteria>
- Indiana state collection has 80-100 active, playable questions
- All questions passed Phase 19 quality rules (no blocking violations)
- Topic distribution covers government structure, civic processes, and broader civics
- Collection visible in gameplay collection picker
</success_criteria>

<output>
After completion, create `.planning/phases/21-generation-pipeline-new-collections/21-03-SUMMARY.md`
</output>
