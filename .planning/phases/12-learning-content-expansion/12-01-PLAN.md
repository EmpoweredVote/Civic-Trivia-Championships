---
phase: 12-learning-content-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/scripts/generateLearningContent.ts
  - backend/src/scripts/applyContent.ts
  - frontend/src/features/game/components/LearnMoreModal.tsx
autonomous: true

must_haves:
  truths:
    - "generateLearningContent.ts accepts --ids, --difficulty, --topic, and --limit flags"
    - "Script refuses to run without at least one filter flag"
    - "Script generates content with updated prompt (inline links, plain language, anti-partisan, expanded sources)"
    - "applyContent.ts merges preview JSON into questions.json with cherry-pick support"
    - "Frontend renders inline markdown links as clickable hyperlinks in learning content"
  artifacts:
    - path: "backend/src/scripts/generateLearningContent.ts"
      provides: "CLI-filtered content generation with updated prompt"
      contains: "--ids|--difficulty|--topic|--limit"
    - path: "backend/src/scripts/applyContent.ts"
      provides: "Cherry-pick content merge into questions.json"
      contains: "applyContent"
    - path: "frontend/src/features/game/components/LearnMoreModal.tsx"
      provides: "Inline link rendering in paragraph text"
      contains: "renderParagraphWithLinks|InlineLink"
  key_links:
    - from: "backend/src/scripts/generateLearningContent.ts"
      to: "backend/src/data/questions.json"
      via: "reads questions, writes preview file"
      pattern: "readFileSync.*questions\\.json"
    - from: "backend/src/scripts/applyContent.ts"
      to: "backend/src/data/questions.json"
      via: "merges preview content into question bank"
      pattern: "writeFileSync.*questions\\.json"
    - from: "frontend/src/features/game/components/LearnMoreModal.tsx"
      to: "paragraph text with [term](url)"
      via: "regex-based inline link renderer"
      pattern: "\\[.*\\]\\(.*\\)"
---

<objective>
Update the content generation tooling and frontend to support Phase 12's expanded content workflow.

Purpose: The existing generateLearningContent.ts script generates for ALL uncovered questions with no filtering. It needs CLI flags for targeted batch generation, an updated prompt matching CONTEXT.md requirements (inline hyperlinks, plain language, anti-partisan framing, expanded source allowlist), and a companion applyContent.ts script for cherry-pick merging. The frontend LearnMoreModal currently renders paragraph text as raw strings, so inline `[text](url)` links would display as literal text -- it needs a simple link renderer.

Output: Updated generation script with CLI flags and new prompt, new apply script, and frontend inline link support.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-learning-content-expansion/12-CONTEXT.md
@.planning/phases/12-learning-content-expansion/12-RESEARCH.md
@backend/src/scripts/generateLearningContent.ts
@frontend/src/features/game/components/LearnMoreModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update generateLearningContent.ts with CLI flags and new prompt</name>
  <files>backend/src/scripts/generateLearningContent.ts</files>
  <action>
Modify the existing generateLearningContent.ts script with three changes:

**A) Add CLI argument parsing (raw process.argv, no library):**
- `--ids q076,q078,q079` — generate for specific question IDs (comma-separated)
- `--difficulty hard` — filter by difficulty field
- `--topic judiciary` — filter by topicCategory field
- `--limit 15` — cap the number of questions to process
- Safety guard: if none of `--ids`, `--difficulty`, `--topic`, or `--limit` are provided, print usage help and exit(1). The script must NEVER default to processing all uncovered questions.

Add a `parseArgs()` function before `main()`:
```typescript
function parseArgs(): { ids?: string[]; difficulty?: string; topic?: string; limit?: number } {
  const args = process.argv.slice(2);
  const result: { ids?: string[]; difficulty?: string; topic?: string; limit?: number } = {};
  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--ids' && args[i + 1]) { result.ids = args[i + 1].split(',').map(s => s.trim()); i++; }
    else if (args[i] === '--difficulty' && args[i + 1]) { result.difficulty = args[i + 1]; i++; }
    else if (args[i] === '--topic' && args[i + 1]) { result.topic = args[i + 1]; i++; }
    else if (args[i] === '--limit' && args[i + 1]) { result.limit = parseInt(args[i + 1], 10); i++; }
  }
  return result;
}
```

**B) Add filtering logic in main()** after `questionsNeedingContent` is computed:
- If `--ids` provided, filter to those IDs only (--ids takes priority over --difficulty and --topic)
- Otherwise, apply `--difficulty` filter, then `--topic` filter
- Apply `--limit` last (slice)
- If no flags provided, error and exit
- Print summary: "Processing N questions (filtered from M uncovered)"

**C) Replace the entire `buildPrompt()` function** with the updated version from RESEARCH.md Pattern 4. Key changes:
- Plain language requirement (8th grade reading level, define jargon, short sentences)
- Anti-partisan framing (no liberal/conservative/activist characterization)
- Inline hyperlinks on key terms: `[key term](https://url)`
- Expanded source allowlist: .gov, khanacademy.org, icivics.org, en.wikipedia.org, news archives
- "as of [date]" caveat for time-sensitive facts
- Keep the same JSON response schema (paragraphs, corrections, source)

**D) Update the script header comment** to show new usage:
```
// Usage:
//   npx tsx src/scripts/generateLearningContent.ts --difficulty hard --limit 15
//   npx tsx src/scripts/generateLearningContent.ts --ids q076,q078,q079
//   npx tsx src/scripts/generateLearningContent.ts --topic judiciary --limit 10
// Run from backend/ directory. Requires ANTHROPIC_API_KEY in .env or environment.
```
  </action>
  <verify>
Run `npx tsx backend/src/scripts/generateLearningContent.ts` from project root (no flags) — should print usage help and exit with code 1, NOT attempt to generate for all questions.

Run `npx tsx backend/src/scripts/generateLearningContent.ts --help` or just check the error output includes the flag names (--ids, --difficulty, --topic, --limit).

Verify the script compiles: `cd backend && npx tsx --eval "import './src/scripts/generateLearningContent.ts'" 2>&1 || true` (will fail at API call but should not have TypeScript errors).
  </verify>
  <done>
Script accepts --ids, --difficulty, --topic, --limit flags. Running without flags prints usage and exits. Prompt includes inline hyperlink requirements, plain language, anti-partisan framing, and expanded source allowlist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create applyContent.ts and add frontend inline link rendering</name>
  <files>backend/src/scripts/applyContent.ts, frontend/src/features/game/components/LearnMoreModal.tsx</files>
  <action>
**A) Create `backend/src/scripts/applyContent.ts`** — the cherry-pick merge script.

Use the complete implementation from RESEARCH.md Pattern 3 with these specifics:
- Takes preview file path as first positional argument (required)
- Optional `--ids q076,q078` flag to cherry-pick specific question IDs from the preview
- Without `--ids`, applies ALL entries from the preview file
- Skips questions that already have `learningContent` (prints SKIP warning)
- Skips question IDs not found in questions.json (prints WARN)
- Reads `src/data/questions.json` relative to cwd (run from backend/)
- Writes updated questions.json with `JSON.stringify(questions, null, 2)`
- Prints summary: "Applied N, Skipped M, Total reviewed K"
- If no preview file argument provided, prints usage and exits

Path resolution must handle both absolute paths and relative paths (relative to cwd). On Windows, check for paths starting with drive letter (C:) or forward slash.

Script header:
```
// Usage:
//   npx tsx src/scripts/applyContent.ts generated-content-2026-02-17T14-30-00.json
//   npx tsx src/scripts/applyContent.ts generated-content-2026-02-17T14-30-00.json --ids q076,q078
// Run from backend/ directory.
```

**B) Update `frontend/src/features/game/components/LearnMoreModal.tsx`** to render inline markdown links.

The modal currently renders paragraphs as raw text: `<p>{paragraph}</p>`. Inline `[text](url)` markdown links would appear as literal characters. Add a simple renderer function:

```typescript
// Add this helper function inside the file (before the component or as a standalone function)
function renderParagraphWithLinks(text: string): (string | JSX.Element)[] {
  const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
  const parts: (string | JSX.Element)[] = [];
  let lastIndex = 0;
  let match;

  while ((match = linkRegex.exec(text)) !== null) {
    // Add text before the link
    if (match.index > lastIndex) {
      parts.push(text.slice(lastIndex, match.index));
    }
    // Add the link element
    parts.push(
      <a
        key={match.index}
        href={match[2]}
        target="_blank"
        rel="noopener noreferrer"
        className="text-teal-400 hover:text-teal-300 underline transition-colors"
      >
        {match[1]}
      </a>
    );
    lastIndex = match.index + match[0].length;
  }

  // Add remaining text after last link
  if (lastIndex < text.length) {
    parts.push(text.slice(lastIndex));
  }

  return parts.length > 0 ? parts : [text];
}
```

Then update the three places where paragraph text is rendered:
1. The opener paragraph (line ~105-107): Change `{getOpener()}` to `{renderParagraphWithLinks(getOpener())}`
2. The remaining paragraphs loop (line ~110-113): Change `{paragraph}` to `{renderParagraphWithLinks(paragraph)}`

This approach does NOT require any new dependencies. It only handles `[text](url)` patterns, which is all we need. Existing content without links renders identically (the function returns the text as-is when no links found).
  </action>
  <verify>
1. Verify applyContent.ts compiles: `cd backend && npx tsx --eval "import './src/scripts/applyContent.ts'" 2>&1 || true` (will fail at missing argument but no TypeScript errors)
2. Run without arguments to verify usage help: `cd backend && npx tsx src/scripts/applyContent.ts 2>&1` — should print usage and exit
3. Verify frontend builds: `cd frontend && npx tsc --noEmit` — no TypeScript errors
4. Verify existing content still renders: The renderParagraphWithLinks function returns text as-is when no `[text](url)` patterns exist, so existing 18 content pieces are unaffected
  </verify>
  <done>
applyContent.ts exists and supports cherry-pick via --ids flag. LearnMoreModal renders inline markdown links as clickable teal hyperlinks. Existing content without links renders identically to before.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsx src/scripts/generateLearningContent.ts` (no flags) prints usage help and exits with code 1
2. `cd backend && npx tsx src/scripts/applyContent.ts` (no args) prints usage help and exits
3. `cd frontend && npx tsc --noEmit` passes with no errors
4. Both scripts have correct path resolution (run from backend/ directory)
5. generateLearningContent.ts prompt includes: inline hyperlinks, plain language, anti-partisan, expanded sources
</verification>

<success_criteria>
- generateLearningContent.ts has --ids, --difficulty, --topic, --limit flags with safety guard
- Updated prompt matches all CONTEXT.md content requirements
- applyContent.ts exists with cherry-pick --ids support
- LearnMoreModal renders [text](url) as clickable links
- All existing functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/12-learning-content-expansion/12-01-SUMMARY.md`
</output>
