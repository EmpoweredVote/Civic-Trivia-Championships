---
phase: 27-backend-foundation-inline-flagging
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - frontend/src/features/game/components/FlagButton.tsx
  - frontend/src/features/game/components/GameScreen.tsx
  - frontend/src/features/game/components/ResultsScreen.tsx
  - frontend/src/pages/Game.tsx
autonomous: true

must_haves:
  truths:
    - "Authenticated player sees flag icon on answer reveal screen"
    - "Anonymous player does NOT see flag icon"
    - "Tapping flag icon fills it amber and calls POST /api/feedback/flag"
    - "Tapping flagged icon removes amber fill and calls DELETE /api/feedback/flag/:questionId"
    - "Tapping flag icon does NOT advance to next question"
    - "Tapping anywhere else on reveal screen STILL advances to next question"
    - "Flag icon shows disabled state with tooltip when rate-limited (429)"
    - "Flagged questions show amber flag icon on results screen (read-only)"
  artifacts:
    - path: "frontend/src/features/game/components/FlagButton.tsx"
      provides: "Reusable flag icon button with toggle state, amber fill animation, tooltip"
      min_lines: 60
    - path: "frontend/src/features/game/components/GameScreen.tsx"
      provides: "FlagButton rendered during reveal phase for authenticated users"
      contains: "FlagButton"
    - path: "frontend/src/features/game/components/ResultsScreen.tsx"
      provides: "Read-only flag indicators on flagged questions"
      contains: "flaggedQuestions"
    - path: "frontend/src/pages/Game.tsx"
      provides: "Flag state management (Set of flagged questionIds), flag toggle handler with API calls"
      contains: "flaggedQuestions"
  key_links:
    - from: "frontend/src/pages/Game.tsx"
      to: "/api/feedback/flag"
      via: "fetch POST and DELETE in handleFlagToggle"
      pattern: "api/feedback/flag"
    - from: "frontend/src/pages/Game.tsx"
      to: "frontend/src/features/game/components/GameScreen.tsx"
      via: "flaggedQuestions and onFlagToggle props"
      pattern: "flaggedQuestions|onFlagToggle"
    - from: "frontend/src/features/game/components/GameScreen.tsx"
      to: "frontend/src/features/game/components/FlagButton.tsx"
      via: "renders FlagButton during reveal phase when authenticated"
      pattern: "FlagButton"
    - from: "frontend/src/features/game/components/FlagButton.tsx"
      to: "e.stopPropagation()"
      via: "prevents tap-anywhere-to-advance from firing"
      pattern: "stopPropagation"
---

<objective>
Add the inline flag button to the game answer reveal screen and results screen. Authenticated players see a small flag icon (top-right of the game area) during the reveal phase. Tapping it toggles amber fill (flag/unflag), calls the backend API, and does NOT advance to the next question. Anonymous players never see the flag icon. Flagged questions show a read-only amber flag on the results screen.

Purpose: This is the user-facing half of the flagging feature. Without this, players have no way to signal problematic questions during gameplay.
Output: FlagButton component, GameScreen integration, Game.tsx state management, ResultsScreen flag display.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-backend-foundation-inline-flagging/27-RESEARCH.md
@.planning/phases/27-backend-foundation-inline-flagging/27-CONTEXT.md
@.planning/phases/27-backend-foundation-inline-flagging/27-01-SUMMARY.md

Key existing files to read before implementing:
@frontend/src/features/game/components/GameScreen.tsx
@frontend/src/features/game/components/ResultsScreen.tsx
@frontend/src/pages/Game.tsx
@frontend/src/store/authStore.ts
@frontend/src/services/api.ts
@frontend/src/types/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: FlagButton component + Game.tsx state management</name>
  <files>
    frontend/src/features/game/components/FlagButton.tsx
    frontend/src/pages/Game.tsx
  </files>
  <action>
**FlagButton component at frontend/src/features/game/components/FlagButton.tsx:**

Create a self-contained flag button component with these behaviors:

Props interface:
```typescript
interface FlagButtonProps {
  flagged: boolean;          // Current flag state (controlled by parent)
  disabled: boolean;         // True when rate-limited
  onToggle: () => void;      // Parent handles the API call
  size?: 'sm' | 'md';       // 'sm' for results screen, 'md' for game screen (default: 'md')
  readOnly?: boolean;        // True on results screen (no click handler)
}
```

Implementation:
1. Render a `<div>` with `className="relative group"` and `onClick={(e) => e.stopPropagation()}` on the outer div — CRITICAL: this prevents tap-anywhere-to-advance. Put stopPropagation on the container div, not just the button (per research pitfall #3).

2. Inside, render a `<button>` with:
   - `onClick` calls `onToggle` (unless disabled, readOnly, or loading)
   - `aria-label` = flagged ? "Unflag question" : "Flag question"
   - `disabled` when disabled prop is true or readOnly is true
   - Sizing: md = `p-2`, sm = `p-1.5`

3. Inside button, render an inline SVG flag icon (Heroicons outline flag path). Use Framer Motion `<motion.svg>` for the fill animation:
   - Unflagged: `text-slate-400`, stroke only (fill="none", strokeWidth=2)
   - Flagged: `text-amber-400`, filled (fill="currentColor", strokeWidth=0)
   - Size: md = `w-5 h-5`, sm = `w-4 h-4`
   - SVG path (Heroicons flag): `M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5`
   - Use `animate` prop for smooth fill transition: `transition={{ duration: 0.2 }}`

4. CSS hover tooltip (NOT LearnMoreTooltip — user decision: independent tooltip):
   - `<div>` positioned `absolute bottom-full mb-2 left-1/2 -translate-x-1/2`
   - Styling: `px-2 py-1 bg-slate-700 text-white text-xs rounded whitespace-nowrap pointer-events-none`
   - Visibility: `opacity-0 group-hover:opacity-100 transition-opacity`
   - Text: disabled ? "Too many flags -- try again later" : (flagged ? "Unflag" : "Flag")
   - Do NOT show tooltip when readOnly

5. When readOnly is true: no onClick handler, no hover tooltip, just display the icon state.

**Game.tsx state management:**

Add flag state and handlers to Game.tsx (the page component that manages game lifecycle):

1. Add state:
   ```typescript
   const [flaggedQuestions, setFlaggedQuestions] = useState<Set<string>>(new Set());
   const [isRateLimited, setIsRateLimited] = useState(false);
   ```

2. Add `handleFlagToggle` function that takes `(questionId: string)`:
   - Get token from `useAuthStore.getState().accessToken`
   - Get sessionId from `state.sessionId` (already on GameState)
   - If question is currently flagged (in Set):
     - Optimistically remove from Set
     - Call `DELETE /api/feedback/flag/${questionId}` with Authorization header
     - On failure: add back to Set, log error
   - If question is NOT flagged:
     - Optimistically add to Set
     - Call `POST /api/feedback/flag` with body `{ questionId, sessionId }` and Authorization header
     - If response is 429: set `isRateLimited(true)`, remove from Set (optimistic rollback)
     - On other failure: remove from Set, log error

3. Reset flaggedQuestions and isRateLimited when game starts (in the useEffect or where startGame is called).

4. Pass `flaggedQuestions`, `isRateLimited`, and `handleFlagToggle` as props to GameScreen.

5. Pass `flaggedQuestions` as prop to ResultsScreen.

Use the existing `API_URL` from `../services/api` and `useAuthStore` from `../store/authStore` for the fetch calls. Do NOT use the `apiRequest` helper for these calls because we need to handle 429 status specifically (apiRequest throws on non-ok). Use raw `fetch` with `API_URL`.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify TypeScript compiles. Check that FlagButton.tsx has stopPropagation on container div, uses motion.svg for amber fill animation, has CSS hover tooltip. Check that Game.tsx has flaggedQuestions state, handleFlagToggle with optimistic updates and 429 handling, and passes props to GameScreen and ResultsScreen.
  </verify>
  <done>
FlagButton component renders flag icon with amber fill toggle animation, CSS tooltip, stopPropagation on container. Game.tsx manages flaggedQuestions Set and isRateLimited state, handles POST/DELETE API calls with optimistic updates and 429 rate limit detection. Props passed to GameScreen and ResultsScreen.
  </done>
</task>

<task type="auto">
  <name>Task 2: GameScreen + ResultsScreen integration</name>
  <files>
    frontend/src/features/game/components/GameScreen.tsx
    frontend/src/features/game/components/ResultsScreen.tsx
  </files>
  <action>
**GameScreen.tsx integration:**

1. Add new props to GameScreenProps interface:
   ```typescript
   flaggedQuestions: Set<string>;
   isRateLimited: boolean;
   onFlagToggle: (questionId: string) => void;
   ```

2. Import FlagButton from `./FlagButton`.

3. Import `useAuthStore` (already imported for timerMultiplier) — read `isAuthenticated` from the store:
   ```typescript
   const isAuthenticated = useAuthStore((s) => s.isAuthenticated);
   ```

4. Add FlagButton to the reveal phase area. Place it in the top HUD area (top-right). The best location is inside the existing `<div className="grid grid-cols-3 items-center w-full">` — in the right column area, OR as an absolutely positioned element relative to the main content container.

   Recommended placement: Inside the reveal phase content area, positioned absolutely in top-right corner of the question card area. Add BEFORE the AnswerGrid section, during reveal phase only, for authenticated users only:

   ```tsx
   {state.phase === 'revealing' && isAuthenticated && currentQuestion && (
     <div className="absolute top-2 right-2 z-10" onClick={(e) => e.stopPropagation()}>
       <FlagButton
         flagged={flaggedQuestions.has(currentQuestion.id)}
         disabled={isRateLimited}
         onToggle={() => onFlagToggle(currentQuestion.id)}
       />
     </div>
   )}
   ```

   Place this inside the `<motion.div>` that wraps the QuestionCard (the one with `key={currentQuestion.id}`), so the flag button is positioned relative to the question content. Ensure the parent has `relative` positioning (it likely already does from existing layout, but verify).

5. The flag button container div MUST have `onClick={(e) => e.stopPropagation()}` in addition to FlagButton's internal stopPropagation — belt and suspenders approach matching existing LearnMoreButton pattern at line ~497 of current GameScreen.

6. Do NOT modify the existing tap-anywhere-to-advance behavior (the root div's onClick at line ~346-349). The flag button exclusion is handled entirely by stopPropagation.

**ResultsScreen.tsx integration:**

1. Add `flaggedQuestions` prop to ResultsScreenProps:
   ```typescript
   flaggedQuestions?: Set<string>;  // Optional for backward compatibility
   ```

2. In the question summary list (where each answered question is displayed), add a small read-only flag indicator next to questions that were flagged:
   - Only show if `flaggedQuestions?.has(question.id)` is true
   - Render `<FlagButton flagged={true} disabled={false} onToggle={() => {}} readOnly={true} size="sm" />`
   - Position inline next to the question text or in the question row
   - Import FlagButton from `./FlagButton`

3. If ResultsScreen doesn't already render individual question rows, find where the question summary/review section is and add the flag indicator there. Read the ResultsScreen file first to understand its current structure before modifying.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify TypeScript compiles. Verify GameScreen.tsx imports FlagButton, renders it during reveal phase conditionally on isAuthenticated, has stopPropagation on container. Verify ResultsScreen.tsx shows read-only flag indicators for flagged questions. Run `cd frontend && npm run build` to ensure production build succeeds.
  </verify>
  <done>
GameScreen renders FlagButton in top-right during reveal phase for authenticated users only, with stopPropagation preventing tap-to-advance. ResultsScreen shows read-only amber flag icons next to questions that were flagged during the session. Anonymous users never see flag buttons. Frontend builds without errors.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` compiles without errors
2. `cd frontend && npm run build` produces successful production build
3. FlagButton has stopPropagation on container div (not just button)
4. GameScreen only shows FlagButton when: state.phase === 'revealing' AND isAuthenticated
5. Game.tsx handles 429 responses by setting isRateLimited
6. ResultsScreen shows read-only flag indicators for flagged questions
7. Flag toggle uses optimistic UI updates with rollback on failure
</verification>

<success_criteria>
- Authenticated users see flag icon on answer reveal screen
- Anonymous users never see flag icon (isAuthenticated check)
- Tapping flag icon toggles amber fill and calls backend API
- Tapping flag icon does NOT advance to next question (stopPropagation)
- Tapping anywhere else still advances (existing behavior preserved)
- Rate-limited state disables flag icon with "Too many flags" tooltip
- Flagged questions show read-only amber flag on results screen
- Frontend TypeScript compiles and production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/27-backend-foundation-inline-flagging/27-02-SUMMARY.md`
</output>
