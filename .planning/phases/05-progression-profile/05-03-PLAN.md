---
phase: 05-progression-profile
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/routes/profile.ts
  - backend/src/server.ts
  - backend/package.json
autonomous: true

must_haves:
  truths:
    - "GET /api/users/profile returns user stats for authenticated user"
    - "POST /api/users/avatar uploads and persists avatar image"
    - "Avatar URL returned in profile response"
    - "Invalid file types rejected with clear error"
  artifacts:
    - path: "backend/src/routes/profile.ts"
      provides: "Profile API endpoints (GET stats, POST avatar)"
      exports: ["router"]
    - path: "backend/src/server.ts"
      provides: "Profile routes mounted, static serving for uploads"
      contains: "profileRouter"
  key_links:
    - from: "backend/src/routes/profile.ts"
      to: "backend/src/models/User.ts"
      via: "User.getProfileStats and User.updateAvatarUrl"
      pattern: "User\\.getProfileStats|User\\.updateAvatarUrl"
    - from: "backend/src/routes/profile.ts"
      to: "backend/src/middleware/auth.ts"
      via: "authenticateToken middleware on all profile routes"
      pattern: "authenticateToken"
---

<objective>
Create backend profile API endpoints for fetching user stats and uploading avatar images.

Purpose: The profile page (Plan 04) needs API endpoints to fetch user progression stats and handle avatar uploads. This plan builds the backend API so the frontend can consume it.

Output: Working GET /api/users/profile endpoint returning stats and POST /api/users/avatar endpoint with secure file upload. Static file serving for uploaded avatars.
</objective>

<execution_context>
@C:\Users\Chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Project Test\.planning\PROJECT.md
@C:\Project Test\.planning\ROADMAP.md
@C:\Project Test\.planning\phases\05-progression-profile\05-CONTEXT.md
@C:\Project Test\.planning\phases\05-progression-profile\05-RESEARCH.md
@C:\Project Test\.planning\phases\05-progression-profile\05-01-SUMMARY.md

Key existing files:
@C:\Project Test\backend\src\server.ts
@C:\Project Test\backend\src\middleware\auth.ts
@C:\Project Test\backend\src\models\User.ts
@C:\Project Test\backend\package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install upload dependencies</name>
  <files>
    backend/package.json
  </files>
  <action>
    Install Multer 2.0.0+ and file-type for secure avatar uploads:
    ```bash
    cd backend && npm install multer file-type
    npm install -D @types/multer
    ```
    Note: Use Multer v2.0.0+ specifically (not v1.x which has known CVEs: CVE-2025-47935, CVE-2025-47944).
    Verify the installed version: `npm ls multer` should show 2.x.

    If Multer 2.x is not available via npm (it may still be in beta), use `multer@^1.4.5-lts.1` as fallback but document in a code comment that it should be upgraded when 2.0.0 is stable. The security patterns (MIME check, magic bytes, size limits, UUID filenames) apply regardless of version.
  </action>
  <verify>
    `cd backend && npm ls multer file-type` shows both packages installed.
  </verify>
  <done>
    Multer and file-type packages installed in backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Profile API routes with avatar upload</name>
  <files>
    backend/src/routes/profile.ts
    backend/src/server.ts
  </files>
  <action>
    1. Create `backend/src/routes/profile.ts`:
       - All routes require authentication (apply `authenticateToken` middleware to the router)

       **GET /** - Fetch profile stats:
       - Extract userId from `req.user!.userId`
       - Call `User.getProfileStats(userId)` (from User model, added in Plan 01)
       - Calculate accuracy: `totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0`
       - Return JSON: `{ totalXp, totalGems, gamesPlayed, bestScore, overallAccuracy, avatarUrl, name, email }`
       - 404 if user not found

       **POST /avatar** - Upload avatar image:
       - Configure Multer with diskStorage:
         - destination: `./uploads/avatars` (create directory if not exists)
         - filename: `crypto.randomUUID() + path.extname(file.originalname)`
       - fileFilter: only allow MIME types `image/jpeg`, `image/png`, `image/webp`
       - limits: `fileSize: 5 * 1024 * 1024` (5MB), `files: 1`
       - After Multer processes the file, add magic byte validation middleware:
         - Use `fileTypeFromBuffer` (from `file-type` package) to read actual file content
         - If magic bytes don't match allowed types, delete the uploaded file and return 400
       - On success: construct the avatar URL as `/uploads/avatars/${filename}`
       - Call `User.updateAvatarUrl(userId, avatarUrl)` to persist
       - Return JSON: `{ avatarUrl }`
       - Handle Multer errors (file too large, invalid type) with appropriate 400 responses

       **Error handling:**
       - Wrap Multer middleware in a custom error handler to catch MulterError instances
       - Return user-friendly messages: "File too large (max 5MB)", "Invalid file type"

    2. Update `backend/src/server.ts`:
       - Import profile router: `import { router as profileRouter } from './routes/profile.js';`
       - Mount it: `app.use('/api/users/profile', profileRouter);`
       - Add static file serving for uploads: `app.use('/uploads', express.static('uploads'));`
       - Place the static middleware BEFORE the API routes so uploaded files are accessible

    3. Create the uploads directory:
       - Add logic in profile.ts to ensure `./uploads/avatars` directory exists (use `mkdirSync` with `{ recursive: true }` at module load time)
       - Add `uploads/` to `.gitignore` if not already there
  </action>
  <verify>
    1. `cd backend && npx tsc --noEmit` compiles without errors
    2. Start backend: `cd backend && npm run dev`
    3. Test GET profile (authenticated):
       ```bash
       curl -H "Authorization: Bearer <token>" http://localhost:3000/api/users/profile
       ```
       Should return stats JSON with totalXp, totalGems, gamesPlayed, etc.
    4. Test avatar upload:
       ```bash
       curl -X POST -H "Authorization: Bearer <token>" -F "avatar=@test-image.jpg" http://localhost:3000/api/users/profile/avatar
       ```
       Should return `{ avatarUrl: "/uploads/avatars/uuid.jpg" }`
    5. Test unauthenticated access returns 401
  </verify>
  <done>
    GET /api/users/profile returns complete user stats with calculated accuracy. POST /api/users/profile/avatar handles secure file upload with MIME + magic byte validation, UUID filenames, 5MB limit. Static serving makes uploaded avatars accessible. All routes require authentication.
  </done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd backend && npx tsc --noEmit`
2. GET /api/users/profile returns stats for authenticated user
3. GET /api/users/profile returns 401 for unauthenticated request
4. POST /api/users/profile/avatar accepts JPEG/PNG/WebP under 5MB
5. POST /api/users/profile/avatar rejects non-image files
6. Uploaded avatar accessible at /uploads/avatars/filename
7. Avatar URL persisted in database
</verification>

<success_criteria>
- Profile endpoint returns totalXp, totalGems, gamesPlayed, bestScore, overallAccuracy, avatarUrl, name, email
- Accuracy calculated as whole number percentage (0 if no games played)
- Avatar upload validates both MIME type and magic bytes
- Upload uses UUID filenames (no user-controlled paths)
- File size limited to 5MB
- Uploads directory created automatically, gitignored
</success_criteria>

<output>
After completion, create `.planning/phases/05-progression-profile/05-03-SUMMARY.md`
</output>
